<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ã¿ã‚„ãåŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    :root {
      --bg-light: #f0f4f8;
      --accent-sky: #0ea5e9;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --bar-width-pct: 78%;
      --dot-size: 28px;
      --dot-border: 4px;
      --chip-size: 64px;
    }
    html { font-family: 'Inter', sans-serif; }
    body {
      background: linear-gradient(135deg, #e8f4f8 0%, #f0f4f8 25%, #f5f8fa 50%, #e8f0f8 75%, #f2f6f9 100%);
      background-attachment: fixed;
      color: var(--text-main);
      overscroll-behavior: none;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(at 15% 25%, hsla(210, 85%, 97%, 0.5) 0px, transparent 60%),
        radial-gradient(at 85% 20%, hsla(200, 75%, 95%, 0.4) 0px, transparent 55%),
        radial-gradient(at 25% 85%, hsla(220, 80%, 96%, 0.35) 0px, transparent 50%),
        radial-gradient(at 90% 80%, hsla(190, 70%, 94%, 0.45) 0px, transparent 58%);
      pointer-events: none;
      z-index: 0;
    }

    #app { flex: 1; display: flex; flex-direction: column; position: relative; z-index: 1; }
    main { flex: 1; overflow-y: auto; position: relative; }

    .page { display: none; width: 100%; position: relative; }
    .page.active { display: block; }

    .liquid-glass {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.7) 0%,
        rgba(255, 255, 255, 0.5) 100%
      );
      backdrop-filter: blur(16px) saturate(150%);
      -webkit-backdrop-filter: blur(16px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow:
        inset 0 1px 1px 0 rgba(255, 255, 255, 0.9),
        inset 0 -1px 1px 0 rgba(255, 255, 255, 0.4),
        0 20px 60px -10px rgba(14, 165, 233, 0.08),
        0 8px 20px -5px rgba(14, 165, 233, 0.06);
    }

    .floating-nav {
      background: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.35) 0%,
        rgba(255, 255, 255, 0.25) 100%
      );
      backdrop-filter: blur(16px) saturate(150%);
      -webkit-backdrop-filter: blur(16px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow:
        inset 0 1px 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -1px 1px 0 rgba(255, 255, 255, 0.3),
        0 20px 50px -8px rgba(14, 165, 233, 0.15),
        0 10px 25px -5px rgba(14, 165, 233, 0.08);
      position: relative;
      border-radius: 1.5rem;
    }

    #nav-indicator {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      height: 75%;
      border-radius: 0.75rem;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.62), rgba(255,255,255,0.28)),
        linear-gradient(180deg, rgba(14,165,233,0.10), rgba(14,165,233,0.00));
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border: 1px solid rgba(255,255,255,0.48);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,0.85),
        inset 0 -10px 18px rgba(14,165,233,0.08),
        0 8px 24px rgba(14,165,233,0.28);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: -1;
    }

    .nav-btn { z-index: 1; }
    .nav-btn.active { color: #0c4a6e; }

    .bottom-sheet-backdrop { position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity .3s ease; pointer-events: none; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; transform: translateY(100%); transition: transform .4s cubic-bezier(0.4, 0, 0.2, 1); }
    .bottom-sheet.is-open { transform: translateY(0); }
    .bottom-sheet.is-open + .bottom-sheet-backdrop { opacity: 1; pointer-events: auto; }

    .ripple { position: relative; overflow: hidden; }
    .ripple-effect { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.7); transform: scale(0); animation: ripple-anim .6s linear; }
    @keyframes ripple-anim { to { transform: scale(4); opacity: 0; } }

    .list-item-anim { opacity: 0; transform: translateY(20px); animation: fade-in-up .5s ease-out forwards; }
    @keyframes fade-in-up { to { opacity: 1; transform: translateY(0); } }

    @keyframes shimmer {
      0% { transform: translateX(-100%) skewX(-12deg); }
      100% { transform: translateX(200%) skewX(-12deg); }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ– */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .progress-area { position: relative; padding-top: 3rem; margin-top: 1rem; overflow: visible; }
    #progress-wrapper { position: relative; margin: 0 auto; width: clamp(260px, var(--bar-width-pct), 560px); min-height: 44px; display: block; }

    .progress-track {
      position: relative;
      width: 100%;
      height: 20px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border-radius: 9999px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.05);
      overflow: visible;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }
    #progress-bar {
      height: 100%;
      border-radius: 9999px;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9, #0284c7);
      transition: width .6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }
    #progress-bar::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2.5s infinite;
      will-change: transform;
    }
    #progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.3), transparent);
      border-radius: 9999px 9999px 0 0;
    }

    .progress-marker {
      position: absolute;
      top: 50%;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 3px solid #cbd5e1;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 12;
      display: grid;
      place-items: center;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .progress-marker.is-active {
      border-color: #0ea5e9;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5), 0 0 30px rgba(14, 165, 233, 0.3);
      transform: translate(-50%, -55%);
    }
    .progress-marker .label {
      font-size: 14px;
      font-weight: 800;
      color: #334155;
      user-select: none;
    }
    .progress-marker.is-active .label {
      color: white;
    }
    
    .map-wrap { aspect-ratio:2/3; margin-top: 0; }

    .scanner-video { width: 100%; height: auto; border-radius: 1rem; background: #000; }
    .scan-guide { position: absolute; inset: 0; pointer-events: none; }
    .scan-corner { position: absolute; width: 24px; height: 24px; border: 3px solid rgba(255,255,255,.9); }
    .scan-corner.tl { top: 12%; left: 10%; border-right: none; border-bottom: none; }
    .scan-corner.tr { top: 12%; right: 10%; border-left: none; border-bottom: none; }
    .scan-corner.bl { bottom: 12%; left: 10%; border-right: none; border-top: none; }
    .scan-corner.br { bottom: 12%; right: 10%; border-left: none; border-top: none; }

    .toast { position: fixed; left: 50%; bottom: 88px; transform: translateX(-50%); z-index: 100; }

    .auth-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.6); backdrop-filter: blur(4px); z-index: 80; display:none; }
    .auth-backdrop.show { display:block; }
    .auth-modal { position: fixed; inset: 0; z-index: 90; display:none; align-items: center; justify-content: center; overflow-y: auto; }
    .auth-modal.show { display:flex; }

    /* First Time Warning Modal */
    .first-time-warning-modal {
      position: fixed;
      inset: 0;
      z-index: 100;
      display:none;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      background: rgba(15,23,42,.7);
      backdrop-filter: blur(8px);
    }
    .first-time-warning-modal.show { display:flex; }

    .fullscreen-scanner {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: #000;
      display: none;
      flex-direction: column;
    }
    .fullscreen-scanner.active {
      display: flex;
    }
    .fullscreen-scanner video {
      flex: 1;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .fullscreen-scanner-controls {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 101;
    }

    .stamp-category-card, .stamp-booth-card {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .stamp-category-card:hover, .stamp-booth-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .booth-company-name {
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      min-width: 0;
      flex: 1;
    }

    .booth-progress {
      font-size: 11px;
      color: #059669;
      font-weight: 600;
      margin-top: 2px;
    }

    .company-mini-card {
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .company-mini-card:hover {
      background: rgba(255,255,255,0.8);
    }

  .company-mini-card .acquired-check, 
li .acquired-check {
  position: absolute;
  top: -6px;   /* ãƒ­ã‚´ã®ä¸Šç«¯ã‹ã‚‰å°‘ã—ã¯ã¿å‡ºã™ */
  right: -6px; /* ãƒ­ã‚´ã®å³ç«¯ã‹ã‚‰å°‘ã—ã¯ã¿å‡ºã™ */
ã€€z-index: 10; /* ãƒ­ã‚´ç”»åƒã®ä¸Šã«è¡¨ç¤ºã™ã‚‹ */
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, #34d399, #10b981);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(52, 211, 153, 0.4);
}

    .progress-info-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .progress-booth-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: rgba(255,255,255,0.5);
      border: 2px solid #cbd5e1;
      transition: all 0.3s ease;
    }

    .progress-booth-item.acquired {
      background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.2));
      border-color: #10b981;
    }

    .progress-booth-item .booth-icon {
      width: 28px;
      height: 28px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: white;
    }

    .progress-booth-item .booth-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .progress-booth-item .booth-label {
      font-size: 10px;
      font-weight: 600;
      color: #475569;
      text-align: center;
    }

    .progress-booth-item.acquired .booth-label {
      color: #059669;
    }

    /* Survey Styles */
    .survey-field {
      margin-bottom: 1.5rem;
    }

    .survey-label {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.75rem;
      display: block;
    }

    .survey-required {
      color: #ef4444;
      margin-left: 0.25rem;
    }

    .survey-radio-group, .survey-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .survey-option {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .survey-option:hover {
      background: rgba(226, 232, 240, 0.5);
    }

    .survey-option input {
      margin-right: 0.75rem;
      cursor: pointer;
    }

    .survey-option.checked {
      border-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.1);
    }

    .survey-textarea, .survey-text-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      font-family: inherit;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .survey-textarea:focus, .survey-text-input:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .survey-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Reward Styles */
    .reward-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      border-radius: 1.5rem;
    }

    .reward-image-wrapper {
      width: 140px;
      height: 140px;
      border-radius: 1rem;
      overflow: hidden;
      background: white;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .reward-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.5rem;
    }

    .reward-details {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      text-align: center;
    }

    .reward-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1e293b;
    }

    .reward-description {
      font-size: 0.875rem;
      color: #64748b;
      line-height: 1.5;
    }

    .staff-instruction {
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(252, 211, 77, 0.2), rgba(251, 146, 60, 0.2));
      border: 3px solid #f59e0b;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .staff-instruction-title {
      font-weight: 700;
      font-size: 1.125rem;
      color: #d97706;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .staff-instruction-text {
      font-size: 1rem;
      font-weight: 600;
      color: #b45309;
      line-height: 1.7;
    }

    .survey-completed-message {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
      border: 2px solid #10b981;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .survey-completed-message-title {
      font-weight: 700;
      color: #059669;
      margin-bottom: 0.25rem;
    }

    .survey-completed-message-text {
      font-size: 0.875rem;
      color: #059669;
    }
    /* ä¼æ¥­ãƒ­ã‚´ã‚°ãƒªãƒƒãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #company-logo-grid {
      padding: 0.5rem;
    }

    .company-logo-item {
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: visible;
      background: white;
      border: 2px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      display: block;
    }

    .company-logo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      transition: opacity 0.3s ease;
    }

    .company-logo-item.not-acquired img {
      opacity: 0.4;
      filter: grayscale(100%);
    }

    .company-logo-item.acquired {
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .company-logo-item.acquired img {
      opacity: 1;
      filter: grayscale(0%);
    }

    .company-room-badge {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
      white-space: nowrap;
      z-index: 10;
    }

    /* ã‚­ãƒ©ã‚­ãƒ©ã‚’å‹•ã‹ã™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes shine {
      0% {
        background-position: -300px 0; /* å·¦å´ï¼ˆè¦‹ãˆãªã„ä½ç½®ï¼‰ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ */
      }
      100% {
        background-position: 600px 0; /* å³å´ã¸ç§»å‹• */
      }
    }

  /* çµ±åˆã‚«ãƒ¼ãƒ‰å†…ã®reward-cardã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ */
    #post-survey-section .reward-card.p-0 {
      padding: 0;
      border: none;
      box-shadow: none;
    }

  /* ========== Survey Action Button States ========== */
  #survey-action-btn.ready-to-claim {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 6px 20px rgba(16, 185, 129, 0.4) !important;
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    50% {
      box-shadow: 0 0 30px rgba(16, 185, 129, 0.8), 0 6px 25px rgba(16, 185, 129, 0.6);
    }
  }

  #survey-action-btn.claimed {
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%) !important;
    box-shadow: none !important;
    animation: none !important;
  }

  </style>
  
</head>
<body>
  <!-- General Modal Backdrop -->
  <div id="modal-backdrop" class="auth-backdrop"></div>

  <!-- First Time Warning Modal -->
  <div id="first-time-warning-modal" class="first-time-warning-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,480px)] p-6 mx-4">
      <div class="text-center space-y-4">
        <div class="text-5xl">âš ï¸</div>
        <h3 class="text-xl font-bold text-slate-800">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦ã®æ³¨æ„</h3>
        <div class="text-left text-slate-700 space-y-3 bg-amber-50 p-4 rounded-xl border-2 border-amber-200">
          <p class="font-semibold text-amber-800">ä»¥ä¸‹ã®å ´åˆã€ã‚¹ã‚¿ãƒ³ãƒ—ã®é€²æ—ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š</p>
          <ul class="space-y-2 text-sm">
            <li class="flex items-start gap-2">
              <span class="text-amber-600 mt-0.5">â€¢</span>
              <span>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ãŸå ´åˆ</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-amber-600 mt-0.5">â€¢</span>
              <span>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆ</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-amber-600 mt-0.5">â€¢</span>
              <span>ç•°ãªã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚„ãƒ‡ãƒã‚¤ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆ</span>
            </li>
          </ul>
          <p class="text-sm font-semibold text-amber-800 mt-3">ğŸ’¡ åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¶™ç¶šã—ã¦ã”åˆ©ç”¨ãã ã•ã„</p>
        </div>
        <button id="close-first-time-warning" class="w-full px-6 py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold text-base ripple shadow-lg">
          ç†è§£ã—ã¾ã—ãŸ
        </button>
      </div>
    </div>
  </div>

  <!-- Survey Modal -->
  <div id="survey-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,640px)] max-h-[85dvh] overflow-y-auto my-auto">
      <div class="p-4 border-b border-white/50 flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur-sm z-10">
        <h3 class="text-lg font-semibold text-slate-800">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
        <button id="close-survey" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">âœ•</button>
      </div>
      <form id="survey-form" class="p-4 space-y-4">
        <!-- Q1: å±æ€§ -->
        <div class="survey-field">
          <label class="survey-label">
            Q1. ã‚ãªãŸã®å±æ€§ã‚’é¸ã‚“ã§ãã ã•ã„
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="affiliation" value="å¤§å­¦ç”Ÿ" required />
              <span>å¤§å­¦ç”Ÿ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="affiliation" value="å¤§å­¦é™¢ç”Ÿ" />
              <span>å¤§å­¦é™¢ç”Ÿ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="affiliation" value="é«˜å°‚ç”Ÿ" />
              <span>é«˜å°‚ç”Ÿ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="affiliation" value="é«˜æ ¡ç”Ÿ" />
              <span>é«˜æ ¡ç”Ÿ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="affiliation" value="æ•™å“¡" />
              <span>æ•™å“¡</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="affiliation" value="ãã®ä»–" />
              <span>ãã®ä»–</span>
            </label>
          </div>
        </div>

        <!-- Q2: æ€§åˆ¥ -->
        <div class="survey-field">
          <label class="survey-label">
            Q2. ã‚ãªãŸã®æ€§åˆ¥ã‚’æ•™ãˆã¦ãã ã•ã„
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="gender" value="ç”·æ€§" required />
              <span>ç”·æ€§</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="gender" value="å¥³æ€§" />
              <span>å¥³æ€§</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="gender" value="å›ç­”ã—ãªã„" />
              <span>å›ç­”ã—ãªã„</span>
            </label>
          </div>
        </div>

        <!-- Q3: ãƒ•ã‚§ã‚¹ã«å‚åŠ ã—ãŸæœ€å¤§ã®ãã£ã‹ã‘ -->
        <div class="survey-field">
          <label class="survey-label">
            Q3. ãƒ•ã‚§ã‚¹ã«å‚åŠ ã—ãŸæœ€å¤§ã®ãã£ã‹ã‘ã‚’æ•™ãˆã¦ãã ã•ã„
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="participation_trigger" value="å½“æ—¥ã®å‹§èª˜(æˆæ¥­ã‹ã‚‰ã®å¸°è·¯ã ã£ãŸ)" required />
              <span>å½“æ—¥ã®å‹§èª˜ï¼ˆæˆæ¥­ã‹ã‚‰ã®å¸°è·¯ã ã£ãŸï¼‰</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="participation_trigger" value="å­¦æ ¡ã®ç´¹ä»‹" />
              <span>å­¦æ ¡ã®ç´¹ä»‹</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="participation_trigger" value="å‹äººãƒ»çŸ¥äººã®ç´¹ä»‹" />
              <span>å‹äººãƒ»çŸ¥äººã®ç´¹ä»‹</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="participation_trigger" value="çœŒã‹ã‚‰ã®ç´¹ä»‹" />
              <span>çœŒã‹ã‚‰ã®ç´¹ä»‹</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="participation_trigger" value="åºƒå‘Š(ãƒãƒ©ã‚·é…å¸ƒã€åœ°ä¸‹é‰„ã€WEBç­‰)" />
              <span>åºƒå‘Šï¼ˆãƒãƒ©ã‚·é…å¸ƒã€åœ°ä¸‹é‰„ã€WEBç­‰ï¼‰</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="participation_trigger" value="ãã®ä»–" />
              <span>ãã®ä»–</span>
            </label>
          </div>
        </div>

        <!-- Q4: ãƒ•ã‚§ã‚¹ã«å‚åŠ ã—ãŸæ„Ÿæƒ³ -->
        <div class="survey-field">
          <label class="survey-label">
            Q4. ãƒ•ã‚§ã‚¹ã«å‚åŠ ã—ãŸæ„Ÿæƒ³ã‚’æ•™ãˆã¦ãã ã•ã„
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="satisfaction" value="å¤§å¤‰å‚è€ƒã«ãªã£ãŸ" required />
              <span>å¤§å¤‰å‚è€ƒã«ãªã£ãŸ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="satisfaction" value="å‚è€ƒã«ãªã£ãŸ" />
              <span>å‚è€ƒã«ãªã£ãŸ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="satisfaction" value="ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„" />
              <span>ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="satisfaction" value="ã‚ã¾ã‚Šå‚è€ƒã«ãªã‚‰ãªã‹ã£ãŸ" />
              <span>ã‚ã¾ã‚Šå‚è€ƒã«ãªã‚‰ãªã‹ã£ãŸ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="satisfaction" value="å‚è€ƒã«ãªã‚‰ãªã‹ã£ãŸ" />
              <span>å‚è€ƒã«ãªã‚‰ãªã‹ã£ãŸ</span>
            </label>
          </div>
        </div>

        <!-- Q5: è‰¯ã‹ã£ãŸä¼ç”» -->
        <div class="survey-field">
          <label class="survey-label">
            Q5. ãƒ•ã‚§ã‚¹ã®ä¸­ã§è‰¯ã‹ã£ãŸã¨æ€ã†ä¼ç”»ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰
            <span class="survey-required">*</span>
          </label>
          <div class="survey-checkbox-group">
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="ã‚‚ã®ã¥ãã‚Šå¤ªéƒã®ã‚»ãƒŸãƒŠãƒ¼" />
              <span>ã‚‚ã®ã¥ãã‚Šå¤ªéƒã®ã‚»ãƒŸãƒŠãƒ¼</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="ä¼æ¥­æ‹…å½“è€…ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ã‚»ãƒƒã‚·ãƒ§ãƒ³" />
              <span>ä¼æ¥­æ‹…å½“è€…ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ã‚»ãƒƒã‚·ãƒ§ãƒ³</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="ä¼æ¥­ã¨ã®äº¤æµãƒ–ãƒ¼ã‚¹(ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»å±•ç¤º)" />
              <span>ä¼æ¥­ã¨ã®äº¤æµãƒ–ãƒ¼ã‚¹ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»å±•ç¤ºï¼‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="å­¦ç”Ÿã«ã‚ˆã‚‹ä¼æ¥­ç ”ç©¶ç™ºè¡¨ä¼š" />
              <span>å­¦ç”Ÿã«ã‚ˆã‚‹ä¼æ¥­ç ”ç©¶ç™ºè¡¨ä¼š</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="ä¼æ¥­è¦‹å­¦ãƒ„ã‚¢ãƒ¼ã®å—ä»˜" />
              <span>ä¼æ¥­è¦‹å­¦ãƒ„ã‚¢ãƒ¼ã®å—ä»˜</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="åŠå°ä½“ã®åŸºç¤çŸ¥è­˜ãƒ‘ãƒãƒ«å±•ç¤º" />
              <span>åŠå°ä½“ã®åŸºç¤çŸ¥è­˜ãƒ‘ãƒãƒ«å±•ç¤º</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="ã‚€ã™ã³ä¸¸ãƒ”ãƒ³ãƒãƒƒã‚¸ç‰¹å…¸" />
              <span>ã‚€ã™ã³ä¸¸ãƒ”ãƒ³ãƒãƒƒã‚¸ç‰¹å…¸</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="QUOã‚«ãƒ¼ãƒ‰ç‰¹å…¸" />
              <span>QUOã‚«ãƒ¼ãƒ‰ç‰¹å…¸</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_programs" value="ãã®ä»–" />
              <span>ãã®ä»–</span>
            </label>
          </div>
        </div>

        <!-- Q6: çŸ¥ã‚‰ãªã‹ã£ãŸä¼æ¥­ -->
        <div class="survey-field">
          <label class="survey-label">
            Q6. ãƒ•ã‚§ã‚¹ã«å‚åŠ ã™ã‚‹ã¾ã§çŸ¥ã‚‰ãªã‹ã£ãŸä¼æ¥­ã¯ã‚ã‚Šã¾ã™ã‹ï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰
            <span class="survey-required">*</span>
          </label>
          <div class="survey-checkbox-group">
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="ãƒ¬ã‚¹ã‚¿ãƒ¼" />
              <span>ãƒ¬ã‚¹ã‚¿ãƒ¼</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹" />
              <span>ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°" />
              <span>ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸ" />
              <span>æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸ</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="TOPPAN" />
              <span>TOPPAN</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿" />
              <span>ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="unknown_companies" value="å…¨ã¦çŸ¥ã£ã¦ã„ãŸ" />
              <span>å…¨ã¦çŸ¥ã£ã¦ã„ãŸ</span>
            </label>
          </div>
        </div>

        <!-- Q7: è‰¯ã‹ã£ãŸä¼æ¥­ -->
        <div class="survey-field">
          <label class="survey-label">
            Q7. ä¼æ¥­ã¨ã®äº¤æµãƒ–ãƒ¼ã‚¹ã«å‚åŠ ã—ã¦è‰¯ã‹ã£ãŸä¼æ¥­ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰
            <span class="survey-required">*</span>
          </label>
          <div class="survey-checkbox-group">
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="ãƒ¬ã‚¹ã‚¿ãƒ¼" />
              <span>ãƒ¬ã‚¹ã‚¿ãƒ¼</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹" />
              <span>ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°" />
              <span>ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸ" />
              <span>æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸ</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="TOPPAN" />
              <span>TOPPAN</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿" />
              <span>ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="good_companies" value="äº¤æµãƒ–ãƒ¼ã‚¹ã«ã¯è¡Œã‹ãªã‹ã£ãŸ" />
              <span>äº¤æµãƒ–ãƒ¼ã‚¹ã«ã¯è¡Œã‹ãªã‹ã£ãŸ</span>
            </label>
          </div>
        </div>

        <!-- Q8: åƒã„ã¦ã¿ãŸã„ä¼æ¥­ -->
        <div class="survey-field">
          <label class="survey-label">
            Q8. ãƒ•ã‚§ã‚¹ã‚’é€šã˜ã¦ã‚ãªãŸãŒåƒã„ã¦ã¿ãŸã„ã¨æ€ã£ãŸä¼æ¥­ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰
            <span class="survey-required">*</span>
          </label>
          <div class="survey-checkbox-group">
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="ãƒ¬ã‚¹ã‚¿ãƒ¼" />
              <span>ãƒ¬ã‚¹ã‚¿ãƒ¼</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹" />
              <span>ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°" />
              <span>ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸ" />
              <span>æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸ</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="TOPPAN" />
              <span>TOPPAN</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿" />
              <span>ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="desired_companies" value="åƒã„ã¦ã¿ãŸã„ä¼æ¥­ã¯ãªã‹ã£ãŸ" />
              <span>åƒã„ã¦ã¿ãŸã„ä¼æ¥­ã¯ãªã‹ã£ãŸ</span>
            </label>
          </div>
        </div>

        <!-- Q9: åƒããŸã„ç†ç”± (ä»»æ„) -->
        <div class="survey-field">
          <label class="survey-label">
            Q9. Q8ã§åƒããŸã„ã¨æ€ã£ãŸç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆè¤‡æ•°å›ç­”å¯ï¼‰
          </label>
          <div class="survey-checkbox-group">
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="ä¼æ¥­ã®æˆé•·ãŒè¦‹è¾¼ã‚ã‚‹ã¨æ„Ÿã˜ãŸã‹ã‚‰" />
              <span>ä¼æ¥­ã®æˆé•·ãŒè¦‹è¾¼ã‚ã‚‹ã¨æ„Ÿã˜ãŸã‹ã‚‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="æŠ€è¡“åŠ›ãƒ»ä»˜åŠ ä¾¡å€¤ã®é«˜ã•ã‚’æ„Ÿã˜ãŸã‹ã‚‰" />
              <span>æŠ€è¡“åŠ›ãƒ»ä»˜åŠ ä¾¡å€¤ã®é«˜ã•ã‚’æ„Ÿã˜ãŸã‹ã‚‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="è‡ªåˆ†ãŒå­¦ã‚“ã§ããŸã“ã¨ã‚’æ´»ã‹ã›ãã†ã ã‹ã‚‰" />
              <span>è‡ªåˆ†ãŒå­¦ã‚“ã§ããŸã“ã¨ã‚’æ´»ã‹ã›ãã†ã ã‹ã‚‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="çµ¦æ–™ã‚„ç¦åˆ©åšç”Ÿãªã©ã®å¾…é‡ãŒè‰¯ã•ãã†ã ã‹ã‚‰" />
              <span>çµ¦æ–™ã‚„ç¦åˆ©åšç”Ÿãªã©ã®å¾…é‡ãŒè‰¯ã•ãã†ã ã‹ã‚‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="åƒãã‚„ã™ã„è·å ´ã ã¨æ„Ÿã˜ãŸã‹ã‚‰" />
              <span>åƒãã‚„ã™ã„è·å ´ã ã¨æ„Ÿã˜ãŸã‹ã‚‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="æœ‰åãªä¼šç¤¾ã ã‹ã‚‰" />
              <span>æœ‰åãªä¼šç¤¾ã ã‹ã‚‰</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="work_reasons" value="ãã®ä»–" id="work-reasons-other" />
              <span>ãã®ä»–</span>
            </label>
          </div>
          <div id="work-reasons-other-input" class="mt-2 hidden">
            <input type="text" name="work_reasons_other_text" class="survey-text-input" maxlength="100" placeholder="ãã®ä»–ã®ç†ç”±ã‚’ã”è¨˜å…¥ãã ã•ã„ï¼ˆ100å­—ä»¥å†…ï¼‰" />
          </div>
        </div>

        <!-- Q10: ãã®ä»–æ„Ÿæƒ³ (ä»»æ„) -->
        <div class="survey-field">
          <label class="survey-label">
            Q10. ãã®ä»–ã€ãƒ•ã‚§ã‚¹å…¨èˆ¬ã«ã¤ã„ã¦ã®æ„è¦‹ãƒ»æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„ï¼ˆ200å­—ä»¥å†…ï¼‰
          </label>
          <textarea name="other_feedback" class="survey-textarea" maxlength="200" placeholder="ã”æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„..."></textarea>
        </div>

        <button type="submit" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">
          å›ç­”ã‚’é€ä¿¡
        </button>
        <p id="survey-error" class="text-sm text-red-600"></p>
      </form>
    </div>
  </div>

  <!-- Gold Pin Badge Exchange Modal -->
<div id="badge-exchange-modal" class="auth-modal">
  <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,480px)] my-auto">
    <div class="p-4 border-b border-white/50 flex items-center justify-between bg-white/80 backdrop-blur-sm z-10">
      <h3 class="text-lg font-semibold text-slate-800">ç‰¹å…¸äº¤æ›</h3>
      <button id="close-badge-exchange" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
    </div>

    <!-- Already Claimed Display -->
    <div id="badge-already-claimed" class="p-6 space-y-6 hidden">
      <div class="text-center space-y-4">
        <div class="w-32 h-32 mx-auto bg-gradient-to-br from-slate-400 via-slate-500 to-slate-600 rounded-full flex items-center justify-center shadow-xl">
          <span class="text-6xl">âœ“</span>
        </div>
        <div>
          <div class="text-3xl font-bold text-slate-800 mb-3">äº¤æ›æ¸ˆã¿</div>
          <div class="text-base text-slate-600 leading-relaxed">
            ã“ã®ç‰¹å…¸ã¯æ—¢ã«äº¤æ›æ¸ˆã¿ã§ã™ã€‚
          </div>
        </div>
      </div>
    </div>

    <!-- Just Claimed Display -->
    <div id="badge-just-claimed" class="p-6 space-y-6 hidden">
      <div class="text-center space-y-4">
        <div class="w-32 h-32 mx-auto rounded-full flex items-center justify-center shadow-xl">
          <img src="musubi_yoko.jpeg" alt="ã‚€ã™ã³ä¸¸ ãƒ”ãƒ³ãƒãƒƒã‚¸ï¼ˆæ¨ªverï¼‰" class="w-full h-full object-contain" />
        </div>
        <div>
          <div class="text-3xl font-bold text-emerald-600 mb-3">ğŸ‰ äº¤æ›ã—ã¾ã—ãŸï¼</div>
          <div class="text-base text-slate-700 leading-relaxed">
            ã‚€ã™ã³ä¸¸ ãƒ”ãƒ³ãƒãƒƒã‚¸ï¼ˆæ¨ªverï¼‰ã‚’äº¤æ›ã—ã¾ã—ãŸã€‚<br>
            <span class="font-bold text-amber-700 mt-2 inline-block">ğŸ“ ã“ã®ç”»é¢ã‚’L404æ•™å®¤ã«ã¦ã€ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠè¦‹ã›ãã ã•ã„</span>
          </div>
        </div>
        <button id="close-just-claimed" class="w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-semibold ripple">
          é–‰ã˜ã‚‹
        </button>
      </div>
    </div>

    <!-- Exchange Interface -->
    <div id="badge-exchange-interface" class="p-6 space-y-6">
      <div class="text-center space-y-4">
        <div class="w-32 h-32 mx-auto rounded-full flex items-center justify-center shadow-xl">
          <img src="musubi_yoko.jpeg" alt="ã‚€ã™ã³ä¸¸ ãƒ”ãƒ³ãƒãƒƒã‚¸ï¼ˆæ¨ªverï¼‰" class="w-full h-full object-contain" />
        </div>
        <div>
          <div class="text-2xl font-bold text-slate-800 mb-2">ã‚€ã™ã³ä¸¸ ãƒ”ãƒ³ãƒãƒƒã‚¸ï¼ˆæ¨ªverï¼‰</div>
          <div class="text-sm text-slate-600">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ç‰¹å…¸</div>
        </div>
      </div>

      <div class="staff-instruction">
        <div class="staff-instruction-title">
          âš ï¸ é‡è¦ï¼šã‚¹ã‚¿ãƒƒãƒ•ç¢ºèªãŒå¿…è¦ã§ã™
        </div>
        <div class="staff-instruction-text">
          ğŸ“ L404æ•™å®¤ã«ã¦ã€ã‚¹ã‚¿ãƒƒãƒ•ã®ç›®ã®å‰ã§ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <!-- Badge Exchange Button -->
      <button id="claim-badge-button" class="w-full px-6 py-4 rounded-2xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold text-lg ripple shadow-lg hover:shadow-xl transition-all">
        ç‰¹å…¸ã‚’äº¤æ›ã™ã‚‹
      </button>

      <div class="text-xs text-slate-500 text-center">
        â€»äº¤æ›ã¯1å›ã®ã¿ã¨ãªã‚Šã¾ã™
      </div>
    </div>
  </div>
</div>

<!-- UUID QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="uuid-qr-modal" class="auth-modal">
  <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,420px)] my-auto">
    <div class="p-4 border-b border-white/50 flex items-center justify-between bg-white/80 backdrop-blur-sm">
      <h3 class="text-lg font-semibold text-slate-800">ã‚ãªãŸã®å—ä»˜QR</h3>
      <button id="close-uuid-qr" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
    </div>
    <div class="p-6 space-y-4">
      <div class="text-center space-y-2">
        <p class="text-sm text-slate-600">äº‹å‰ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
        <p class="text-xs text-slate-500">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’å—ä»˜ã§ã”æç¤ºãã ã•ã„</p>
      </div>

      <div class="bg-white rounded-2xl p-4 border border-slate-200">
        <div id="uuid-qr-container" class="flex items-center justify-center min-h-[200px]">
          <!-- QRã‚³ãƒ¼ãƒ‰ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
      </div>

      <div class="text-center space-y-1">
        <div class="text-xs text-slate-500">å—ä»˜ç•ªå·</div>
        <div class="text-2xl font-bold text-sky-600 font-mono" id="uuid-qr-number">00000</div>
      </div>

      <div class="bg-sky-50 rounded-xl p-3 border border-sky-200">
        <div class="text-xs text-sky-800 space-y-1">
          <p>ğŸ’¡ <strong>ã“ã®ç”»é¢ã®é–‹ãæ–¹</strong></p>
          <p class="pl-4">å³ä¸Šã®å—ä»˜ç•ªå·ï¼ˆ5æ¡ã®æ•°å­—ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ã„ã¤ã§ã‚‚ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Fullscreen Scanner -->
  <div id="fullscreen-scanner" class="fullscreen-scanner">
    <div class="fullscreen-scanner-controls">
      <button id="fullscreen-close" class="px-4 py-2 rounded-xl bg-red-500 text-white font-semibold">âœ• é–‰ã˜ã‚‹</button>
      <div class="flex gap-2">
        <button id="fullscreen-torch" class="px-3 py-2 rounded-xl bg-white/20 text-white border border-white/40">ğŸ’¡</button>
        <button id="fullscreen-switch" class="px-3 py-2 rounded-xl bg-white/20 text-white border border-white/40">ğŸ”„</button>
      </div>
    </div>
    <video id="fullscreen-video" autoplay playsinline muted></video>
    <div class="scan-guide">
      <div class="scan-corner tl"></div>
      <div class="scan-corner tr"></div>
      <div class="scan-corner bl"></div>
      <div class="scan-corner br"></div>
    </div>
    <div style="position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); color: white; text-align: center; background: rgba(0,0,0,0.6); padding: 0.5rem 1rem; border-radius: 1rem;">
      <span id="fullscreen-status">QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å†™ã—ã¦ãã ã•ã„</span>
    </div>
    <div id="fullscreen-message" class="hidden" style="position: absolute; bottom: 6rem; left: 50%; transform: translateX(-50%); z-index: 102; width: 80%; max-width: 320px;">
      <div class="px-4 py-3 rounded-2xl bg-red-500 text-white shadow-lg text-center font-medium"></div>
    </div>
  </div>

  <!-- Booth Detail Sheet -->
  <div id="booth-sheet" class="bottom-sheet">
    <div class="liquid-glass rounded-t-3xl max-h-[85dvh] overflow-y-auto">
      <div class="p-4 border-b border-white/50 flex items-center gap-3">
        <div class="min-w-0 flex-1 text-left">
          <h4 id="booth-sheet-title" class="font-semibold text-lg text-slate-800 leading-tight"></h4>
        </div>
        <button id="close-booth-sheet" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
      </div>
      <div class="p-4 space-y-4 text-sm">
        <p id="booth-sheet-desc" class="text-slate-700 leading-6"></p>
      </div>
    </div>
  </div>
  <div class="bottom-sheet-backdrop" data-target="booth"></div>

  <div id="app">
    <header id="header" class="sticky top-0 z-30 liquid-glass transition-transform duration-300 rounded-b-3xl backdrop-blur-xl" style="background: linear-gradient(135deg, rgba(255,255,255,0.7) 0%, rgba(240,249,255,0.8) 100%); border-bottom: 1px solid rgba(14, 165, 233, 0.1);">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
        <!-- ãƒ­ã‚´ã‚¨ãƒªã‚¢ -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <div class="relative w-16 h-10 rounded-xl overflow-hidden bg-white shadow-md" style="box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);">
            <img src="logo.png" alt="Logo" class="w-full h-full object-contain p-1" />
          </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ -->
        <div class="flex-1 min-w-0">
          <h1 id="header-title" class="text-base font-bold text-sky-900 tracking-tight">ãƒ›ãƒ¼ãƒ </h1>
          <p class="text-xs text-sky-600 font-medium truncate">ã¿ã‚„ãåŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹</p>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç•ªå·è¡¨ç¤º -->
        <div id="user-number-display" class="ml-auto text-xs text-slate-700 font-mono font-bold px-3 py-1.5 rounded-full bg-gradient-to-r from-sky-50 to-blue-50 backdrop-blur-sm border border-sky-300 flex items-center gap-1.5 shadow-sm">
          <span class="text-sky-600">#</span>
          <span id="user-number">00000</span>
        </div>
      </div>
    </header>

    <main class="flex-1 pb-28">
      <div id="page-home" class="page active p-4 space-y-6">
        <div class="liquid-glass rounded-3xl p-4 relative overflow-hidden" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #dbeafe 100%); box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);">
          <div class="relative z-10">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-sky-800">ã‚¹ã‚¿ãƒ³ãƒ—é€²æ—</h3>
              <div class="flex items-center gap-2">
                <span id="rank-percentile" class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 border border-amber-200 font-medium"></span>
                <span id="progress-badge" class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-700 border border-sky-200 font-mono">0pt</span>
              </div>
            </div>
            <!-- ä¼æ¥­ãƒ­ã‚´ã‚°ãƒªãƒƒãƒ‰ (2Ã—3) -->
            <div id="company-logo-grid" class="grid grid-cols-3 gap-3 mt-3">
              <!-- ãƒ­ã‚´ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <p id="progress-msg" class="mt-4 text-sm text-center text-slate-600"></p>
            <div id="progress-percent" class="mt-2 text-center">
              <span id="stamp-count" class="text-2xl font-bold text-sky-600">0</span>
              <span class="text-xs text-slate-500 ml-1">/ 6 ã‚¹ã‚¿ãƒ³ãƒ—</span>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div class="mt-5 space-y-3">
              <!-- QRã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ -->
              <button id="scan-card" class="w-full relative overflow-hidden rounded-2xl p-4 ripple" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); box-shadow: 0 6px 20px rgba(14, 165, 233, 0.3);">
                <div class="relative z-10 flex items-center justify-center gap-3">
                  <div class="w-12 h-12 rounded-xl bg-white/25 backdrop-blur-sm grid place-items-center text-3xl">
                    ğŸ“·
                  </div>
                  <div class="text-left flex-1">
                    <div class="font-bold text-lg text-white">QRã‚¹ã‚­ãƒ£ãƒ³</div>
                    <div class="text-xs text-sky-50">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚ˆã†</div>
                  </div>
                  <div class="text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </div>
                </div>
                <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/15 to-white/0 transform -skew-x-12" style="animation: shimmer 3s infinite; will-change: transform;"></div>
              </button>

              <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­” / ç‰¹å…¸äº¤æ›ãƒœã‚¿ãƒ³ -->
              <button id="survey-action-btn" class="w-full px-6 py-3 rounded-2xl bg-gradient-to-r from-purple-500 to-purple-600 text-white font-semibold text-sm ripple shadow-lg hover:shadow-xl transition-shadow flex flex-col items-center justify-center gap-1">
                <div class="flex items-center gap-2">
                  <span class="text-lg">ğŸ“</span>
                  <span id="survey-action-text">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”</span>
                </div>
                <span id="survey-action-subtext" class="text-xs opacity-90 font-normal">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã§ã‚€ã™ã³ä¸¸ ãƒ”ãƒ³ãƒãƒƒã‚¸ï¼ˆæ¨ªverï¼‰ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼</span>
              </button>
            </div>
          </div>
        </div>

        <div class="liquid-glass rounded-3xl p-4">
          <h3 class="font-semibold text-sky-800 mb-3">ã‚¹ã‚¿ãƒ³ãƒ—</h3>
          <div class="space-y-3" id="stamp-categories">
            <!-- 6ç¤¾ã®ä¼æ¥­ãƒ–ãƒ¼ã‚¹ -->
            <div class="stamp-booth-card liquid-glass rounded-2xl p-4 border border-white/50" data-booth-id="D">
              <div class="flex items-center justify-between gap-2">
                <div class="booth-company-name font-semibold text-slate-800">æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸæ ªå¼ä¼šç¤¾</div>
                <div class="text-slate-400 flex-shrink-0">â€º</div>
              </div>
            </div>

            <div class="stamp-booth-card liquid-glass rounded-2xl p-4 border border-white/50" data-booth-id="E">
              <div class="flex items-center justify-between gap-2">
                <div class="booth-company-name font-semibold text-slate-800">TOPPANæ ªå¼ä¼šç¤¾</div>
                <div class="text-slate-400 flex-shrink-0">â€º</div>
              </div>
            </div>

            <div class="stamp-booth-card liquid-glass rounded-2xl p-4 border border-white/50" data-booth-id="A">
              <div class="flex items-center justify-between gap-2">
                <div class="booth-company-name font-semibold text-slate-800">æ ªå¼ä¼šç¤¾ãƒ¬ã‚¹ã‚¿ãƒ¼</div>
                <div class="text-slate-400 flex-shrink-0">â€º</div>
              </div>
            </div>

            <div class="stamp-booth-card liquid-glass rounded-2xl p-4 border border-white/50" data-booth-id="C">
              <div class="flex items-center justify-between gap-2">
                <div class="booth-company-name font-semibold text-slate-800">ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°æ ªå¼ä¼šç¤¾</div>
                <div class="text-slate-400 flex-shrink-0">â€º</div>
              </div>
            </div>

            <div class="stamp-booth-card liquid-glass rounded-2xl p-4 border border-white/50" data-booth-id="F">
              <div class="flex items-center justify-between gap-2">
                <div class="booth-company-name font-semibold text-slate-800">ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿æ ªå¼ä¼šç¤¾</div>
                <div class="text-slate-400 flex-shrink-0">â€º</div>
              </div>
            </div>

            <div class="stamp-booth-card liquid-glass rounded-2xl p-4 border border-white/50" data-booth-id="B">
              <div class="flex items-center justify-between gap-2">
                <div class="booth-company-name font-semibold text-slate-800">ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹æ ªå¼ä¼šç¤¾</div>
                <div class="text-slate-400 flex-shrink-0">â€º</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div id="page-map" class="page p-3 pt-2">
        <div class="map-wrap w-full max-w-[1200px] mx-auto">
          <svg id="svg-map" viewBox="0 0 1200 1800" preserveAspectRatio="xMidYMid meet" class="w-full h-auto">
            <image id="bg-image" href="assets/layout.png" xlink:href="assets/layout.png" x="0" y="0" width="1200" height="1800" />
            <g id="booth-icons" font-size="140" text-anchor="middle" dominant-baseline="middle" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));"></g>
          </svg>
        </div>
      </div>
    </main>

    <div id="staff-confirm-modal" class="auth-modal">
      <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,480px)] my-auto">
        <div class="p-4 border-b border-white/50">
          <h3 class="text-lg font-semibold text-slate-800 text-center">ã‚¹ã‚¿ãƒƒãƒ•ç¢ºèª</h3>
        </div>
        <div class="p-5 text-center space-y-4">
          <p class="text-lg font-semibold text-sky-700 leading-relaxed">
            ã‚¹ã‚¿ãƒƒãƒ•ã«ã“ã®ç”»é¢ã‚’
            <br>
            è¦‹ã›ã¦ãã ã•ã„
          </p>
          
          <div class="liquid-glass rounded-2xl p-4 border border-white/40">
            <div class="text-sm text-slate-600">äº¤æ›æšæ•°</div>
            <div id="staff-confirm-count" class="text-3xl font-bold text-purple-600">0æš</div>
          </div>

          <p class="text-xs text-slate-600">ã‚¹ã‚¿ãƒƒãƒ•ãŒã€Œäº¤æ›ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
          
          <div class="grid grid-cols-2 gap-3 mt-2">
            <button id="staff-confirm-cancel" class="px-4 py-3 rounded-2xl bg-slate-200 text-slate-800 font-semibold ripple">
              æˆ»ã‚‹
            </button>
            <button id="staff-confirm-execute" class="px-4 py-3 rounded-2xl bg-purple-600 text-white font-semibold ripple text-lg">
              ğŸ äº¤æ›
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="toast" class="toast hidden">
      <div class="px-4 py-2 rounded-2xl bg-sky-600 text-white shadow-lg"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 z-40 p-3">
      <nav class="h-16 grid grid-cols-2 items-center floating-nav rounded-3xl">
        <div id="nav-indicator"></div>
        <button data-page="home" class="nav-btn active flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ </div><span class="text-xs font-medium">ãƒ›ãƒ¼ãƒ </span></button>
        <button data-page="map" class="nav-btn flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ—ºï¸</div><span class="text-xs font-medium">ãƒãƒƒãƒ—</span></button>
      </nav>
    </div>
  </div>
<script>
const SUPABASE_URL = "https://fsaeuowdijoeqhnrqazx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzYWV1b3dkaWpvZXFobnJxYXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjA0MjYsImV4cCI6MjA3NTQ5NjQyNn0.xgIQ9jf3qa4oy6Dbc8mVaP8woRDWBwMxLAJwiCGEWmk";

async function callEdgeFunction(functionName, body = {}) {
  const headers = {
    'Content-Type': 'application/json',
    'apikey': SUPABASE_ANON_KEY
  };
  try {
    const response = await fetch(
      `${SUPABASE_URL}/functions/v1/${functionName}`,
      {
        method: 'POST',
        headers,
        body: JSON.stringify(body)
      }
    );
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      console.error(`API Response:`, response.status, error);
      throw new Error(error.error || `API Error: ${response.status}`);
    }
    return await response.json();
  } catch (error) {
    console.error(`[callEdgeFunction] ${functionName} failed:`, error);
    throw error;
  }
}

// å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿å®šç¾©
const IMG_DEFAULT = 'logo.jpg';
const MAX_POINTS = 6;

const BOOTH_ANCHORS = {
  A: { x: 0.85, y: 0.22 },
  B: { x: 0.82, y: 0.83 },
  C: { x: 0.83, y: 0.35 },
  D: { x: 0.175, y: 0.60 },
  E: { x: 0.175, y: 0.83 },
  F: { x: 0.82, y: 0.60 }
};

const BOOTH_DATA = [
  {
    id: 'D',
    name: 'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸæ ªå¼ä¼šç¤¾',
    room: 'L402',
    img: 'assets/tel.png',
    mapIcon: 'tel',
    icon: 'ğŸ”¥',
    desc: 'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã—ã¦åŠå°ä½“è£½é€ è£…ç½®ãƒ¡ãƒ¼ã‚«ãƒ¼å£²ä¸Šä¸–ç•Œ4ä½ã€‚åŠå°ä½“ã®ä¸»è¦å·¥ç¨‹ã§å¤šãã®ä¸–ç•Œãƒˆãƒƒãƒ—ã‚·ã‚§ã‚¢ã‚’èª‡ã‚‹ã»ã‹ã€ç‰¹è¨±ä¿æœ‰æ•°ä¸–ç•ŒNo.1ã€‚',
    tags:['ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹', 'è£…ç½®éƒ¨å“', 'é™é›»ãƒãƒ£ãƒƒã‚¯'],
    giveaway:'ã‚»ãƒ©ãƒŸãƒƒã‚¯è£½ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼',
    condition:'ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹ã®ç†±ä¼å°å®Ÿé¨“ã«å‚åŠ '
  },
  {
    id: 'E',
    name: 'TOPPANæ ªå¼ä¼šç¤¾',
    room: 'L403',
    img: 'assets/toppan.jpg',
    mapIcon: 'toppan',
    icon: 'ğŸº',
    desc: 'ã‚°ãƒ«ãƒ¼ãƒ—ã«ãŠã‘ã‚‹ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹éƒ¨é–€ã¨ã—ã¦åŠå°ä½“ã‚„ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤äº‹æ¥­ã‚’å±•é–‹ã€‚å°åˆ·ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚’æ§˜ã€…ãªé ˜åŸŸã«å¿œç”¨ã—ã€æ–°ãŸãªè£½å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰µå‡º',
    tags:['ææ–™', 'ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹', 'é«˜ç´”åº¦'],
    giveaway:'ãƒŸãƒ‹ãƒãƒ¥ã‚¢ã‚»ãƒ©ãƒŸãƒƒã‚¯ãƒ—ãƒ¬ãƒ¼ãƒˆ',
    condition:'è£½å“ã‚µãƒ³ãƒ—ãƒ«ã«è§¦ã‚Œã¦ã¿ã‚‹'
  },
  {
    id: 'A',
    name: 'æ ªå¼ä¼šç¤¾ãƒ¬ã‚¹ã‚¿ãƒ¼',
    room: 'L404',
    img: 'assets/restar.jpeg',
    mapIcon: 'restar',
    icon: 'âš¡',
    desc: 'å›½å†…å¤–ã®æœ€å…ˆç«¯ã®åŠå°ä½“ã‚„é›»å­éƒ¨å“ã‚’æ‰±ã†ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹å•†ç¤¾ã€‚å¤šæ•°ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒåœ¨ç±ã€å›è·¯è¨­è¨ˆãƒ»é–‹ç™ºç­‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã€‚',
    tags:['ã‚¨ãƒƒãƒãƒ³ã‚°', 'è£½é€ è£…ç½®', 'ãƒ—ãƒ©ã‚ºãƒ'],
    giveaway:'TELã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¦ã‚¨ãƒãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ—',
    condition:'ã‚¨ãƒƒãƒãƒ³ã‚°å·¥ç¨‹ã«é–¢ã™ã‚‹ã‚¯ã‚¤ã‚ºã«æ­£è§£'
  },
  {
    id: 'C',
    name: 'ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°æ ªå¼ä¼šç¤¾',
    room: 'L404',
    img: 'assets/sont.png',
    mapIcon: 'sony',
    icon: 'ğŸ’¡',
    desc: 'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®åŠå°ä½“éƒ¨é–€ã«ãŠã„ã¦é–‹ç™ºãƒ»ç”Ÿç”£ã‚’æ‹…ã†æ‹ ç‚¹ã€‚ã‚°ãƒ«ãƒ¼ãƒ—ãŒç”Ÿç”£ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚»ãƒ³ã‚µãƒ¼ã¯ä¸–ç•Œã‚·ã‚§ã‚¢No.1 ã€‚',
    tags:['LSI', 'MCU', 'IoT'],
    giveaway:'ã‚ªãƒªã‚¸ãƒŠãƒ«ICãƒãƒƒãƒ—ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼',
    condition:'IoTãƒ‡ãƒã‚¤ã‚¹ã®ãƒ‡ãƒ¢ã‚’ä½“é¨“'
  },
  {
    id: 'F',
    name: 'ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿æ ªå¼ä¼šç¤¾',
    room: 'L405',
    img: 'assets/lapis.png',
    mapIcon: 'rapis',
    icon: 'ğŸŒ¡ï¸',
    desc: 'ãƒ‘ãƒ¯ãƒ¼åŠå°ä½“ã§ä¸–ç•Œä¸Šä½ã®ã‚·ã‚§ã‚¢ã‚’èª‡ã‚‹ãƒ­ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸»åŠ›ç”Ÿç”£æ‹ ç‚¹ã€‚å®®åŸå·¥å ´ã§ã¯ãƒ­ãƒ¼ãƒ‘ãƒ¯ãƒ¼ãƒã‚¤ã‚³ãƒ³ã€ ç„¡ç·šé€šä¿¡ç”¨ãªã©ã®åŠå°ä½“LSIå•†å“ã‚’è£½é€ ã€‚',
    tags:['è¨ˆæ¸¬', 'æˆè†œ', 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼'],
    giveaway:'æ¶²æ™¶æ¸©åº¦è¨ˆã‚«ãƒ¼ãƒ‰',
    condition:'è†œåšè¨ˆã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹å­¦'
  },
  {
    id: 'B',
    name: 'ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹æ ªå¼ä¼šç¤¾',
    room: 'L406',
    img: 'assets/kioxia.png',
    mapIcon: 'kioxia',
    icon: 'ğŸ–¼ï¸',
    desc: 'ã‚­ã‚ªã‚¯ã‚·ã‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã—ã¦ä¸–ç•Œã‚·ã‚§ã‚¢ç¬¬2ä½ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªç”Ÿç”£é‡ã€‚ã‚°ãƒ«ãƒ¼ãƒ—ã®å°†æ¥ã®ä¸€ç¿¼ã‚’æ‹…ã†3æ¬¡å…ƒãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªã®é‡ç”£å·¥å ´ã€‚',
    tags:['ãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯', 'EUV', 'ãƒªã‚½ã‚°ãƒ©ãƒ•ã‚£'],
    giveaway:'ãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³å®šè¦',
    condition:'ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒã‚¹ã‚¯ã®é‡ã­åˆã‚ã›ä½“é¨“'
  },
];


// ã‚¢ãƒ—ãƒªçŠ¶æ…‹
const state = {
  points: 0,                // äº¤æ›å¯èƒ½ãƒã‚¤ãƒ³ãƒˆï¼ˆredeemable_pointsï¼‰
  totalPoints: 0,           // ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆï¼ˆtotal_pointsï¼‰
  activePage: 'home',
  prevCount: 0,
  user: null,
  percentile: null,
  acquiredStamps: new Set(), // å›ã£ãŸãƒ–ãƒ¼ã‚¹ID
  claimedRewards: new Set(), // äº¤æ›æ¸ˆã¿æ™¯å“
  surveyCompleted: false
};

// DOMå‚ç…§
const $app = {
  header: document.getElementById('header'),
  headerTitle: document.getElementById('header-title'),
  pages: document.querySelectorAll('.page'),
  nav: document.querySelector('.floating-nav'),
  navIndicator: document.getElementById('nav-indicator'),
  navButtons: document.querySelectorAll('.nav-btn'),
  boothList: document.getElementById('booth-list'),
  progress: {
    badge: document.getElementById('progress-badge'),
    msg: document.getElementById('progress-msg'),
    percent: document.getElementById('progress-percent'),
    rankPercentile: document.getElementById('rank-percentile'),
    logoGrid: document.getElementById('company-logo-grid'),
    stampCount: document.getElementById('stamp-count'),
  },
  map: {
    svg: document.getElementById('svg-map'),
    bg: document.getElementById('bg-image'),
    iconsGroup: document.getElementById('booth-icons')
  },
  boothSheet: {
    el: document.getElementById('booth-sheet'),
    backdrop: document.querySelector('.bottom-sheet-backdrop[data-target="booth"]'),
    title: document.getElementById('booth-sheet-title'),
    desc: document.getElementById('booth-sheet-desc'),
    closeBtn: document.getElementById('close-booth-sheet')
  },
  scan: {
    openCard: document.getElementById('scan-card'),
  },
  fullscreenScanner: {
    container: document.getElementById('fullscreen-scanner'),
    video: document.getElementById('fullscreen-video'),
    status: document.getElementById('fullscreen-status'),
    closeBtn: document.getElementById('fullscreen-close'),
    torchBtn: document.getElementById('fullscreen-torch'),
    switchBtn: document.getElementById('fullscreen-switch'),
  },
  backdrop: document.getElementById('modal-backdrop'),
  toast: document.getElementById('toast'),
  staffConfirm: {
    modal: document.getElementById('staff-confirm-modal'),
    count: document.getElementById('staff-confirm-count'),
    executeBtn: document.getElementById('staff-confirm-execute'),
    cancelBtn: document.getElementById('staff-confirm-cancel')
  },
  badgeExchange: {
    modal: document.getElementById('badge-exchange-modal'),
    closeBtn: document.getElementById('close-badge-exchange')
  },
  survey: {
    modal: document.getElementById('survey-modal'),
    form: document.getElementById('survey-form'),
    closeBtn: document.getElementById('close-survey'),
    error: document.getElementById('survey-error')
  },
  surveyActionBtn: document.getElementById('survey-action-btn'),
  surveyActionText: document.getElementById('survey-action-text'),
  surveyActionSubtext: document.getElementById('survey-action-subtext')
};

// ========== localStorageç®¡ç† ==========
const LS_KEY_USER = 'app_user';

function saveLocalUser(u) {
  localStorage.setItem(LS_KEY_USER, JSON.stringify(u));
}

// ========== First Time Warning ==========
const LS_KEY_FIRST_VISIT = 'first_visit_shown';

function isFirstVisit() {
  return !localStorage.getItem(LS_KEY_FIRST_VISIT);
}

function markFirstVisitShown() {
  localStorage.setItem(LS_KEY_FIRST_VISIT, 'true');
}

function showFirstTimeWarning() {
  const modal = document.getElementById('first-time-warning-modal');
  if (modal) {
    modal.classList.add('show');
  }
}

function closeFirstTimeWarning() {
  const modal = document.getElementById('first-time-warning-modal');
  if (modal) {
    modal.classList.remove('show');
  }
  markFirstVisitShown();

  // If should open UUID QR modal after closing
  if (window._shouldOpenUuidQrAfterWarning) {
    window._shouldOpenUuidQrAfterWarning = false;
    setTimeout(() => {
      openUuidQrModal();
    }, 300);
  }
}

// ========== ãƒ¢ãƒ¼ãƒ€ãƒ« / UI ã‚ªãƒ¼ãƒ—ãƒ³ãƒ»ã‚¯ãƒ­ãƒ¼ã‚º ==========
function openSurveyModal() {
  $app.backdrop.classList.add('show');
  $app.survey.modal.classList.add('show');
}
function closeSurveyModal() {
  $app.survey.modal.classList.remove('show');
  if (!$app.badgeExchange.modal.classList.contains('show')) {
    $app.backdrop.classList.remove('show');
  }
}

// UUID QRãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
function openUuidQrModal() {
  if (!state.user?.id) {
    showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  // äº‹å‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
  if (state.user.registration_type !== 'pre_registration') {
    return; // ä½•ã‚‚èµ·ã“ã‚‰ãªã„
  }

  const modal = document.getElementById('uuid-qr-modal');
  const container = document.getElementById('uuid-qr-container');
  const numberDisplay = document.getElementById('uuid-qr-number');

  // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  container.innerHTML = ''; // ã‚¯ãƒªã‚¢
  new QRCode(container, {
    text: state.user.id,
    width: 200,
    height: 200,
    colorDark: '#0284c7',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });

  // å—ä»˜ç•ªå·è¡¨ç¤º
  if (state.user.user_number) {
    numberDisplay.textContent = String(state.user.user_number).padStart(5, '0');
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  $app.backdrop.classList.add('show');
  modal.classList.add('show');
}

function closeUuidQrModal() {
  const modal = document.getElementById('uuid-qr-modal');
  modal.classList.remove('show');
  if (
    !$app.badgeExchange.modal.classList.contains('show') &&
    !$app.survey.modal.classList.contains('show')
  ) {
    $app.backdrop.classList.remove('show');
  }
}

function openBadgeExchangeModal() {
  if (!state.user?.id) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }

  const alreadyClaimedDiv = document.getElementById('badge-already-claimed');
  const exchangeInterfaceDiv = document.getElementById('badge-exchange-interface');

  // Check if badge already claimed
  if (state.user.badge_claimed) {
    // Show "Already Claimed" message
    alreadyClaimedDiv.classList.remove('hidden');
    exchangeInterfaceDiv.classList.add('hidden');
  } else {
    // Show exchange interface
    alreadyClaimedDiv.classList.add('hidden');
    exchangeInterfaceDiv.classList.remove('hidden');
  }

  $app.backdrop.classList.add('show');
  $app.badgeExchange.modal.classList.add('show');
}

function closeBadgeExchangeModal() {
  $app.badgeExchange.modal.classList.remove('show');
  if (!$app.survey.modal.classList.contains('show')) {
    $app.backdrop.classList.remove('show');
  }
}

// ========== ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæå‡º ==========
async function submitSurvey(e) {
  e.preventDefault();
  if (!state.user?.id) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }

  const formData = new FormData($app.survey.form);

  // Validate required checkbox fields (Q5-Q8)
  const requiredCheckboxFields = [
    { name: 'good_programs', label: 'Q5' },
    { name: 'unknown_companies', label: 'Q6' },
    { name: 'good_companies', label: 'Q7' },
    { name: 'desired_companies', label: 'Q8' }
  ];

  for (const field of requiredCheckboxFields) {
    if (formData.getAll(field.name).length === 0) {
      $app.survey.error.textContent = `${field.label}ã¯å¿…é ˆé …ç›®ã§ã™ã€‚å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚`;
      return;
    }
  }

  const surveyData = {
    affiliation: formData.get('affiliation'),
    gender: formData.get('gender'),
    participation_trigger: formData.get('participation_trigger'),
    satisfaction: formData.get('satisfaction'),
    good_programs: formData.getAll('good_programs'),
    unknown_companies: formData.getAll('unknown_companies'),
    good_companies: formData.getAll('good_companies'),
    desired_companies: formData.getAll('desired_companies'),
    work_reasons: formData.getAll('work_reasons'),
    work_reasons_other: formData.get('work_reasons_other_text') || null,
    other_feedback: formData.get('other_feedback') || null
  };

  try {
    $app.survey.error.textContent = '';
    const result = await callEdgeFunction('submit-survey', {
      userId: state.user.id,
      surveyData
    });

    if (result.success) {
      state.surveyCompleted = true;
      state.user.survey_completed = true;
      saveLocalUser(state.user);

      $app.survey.modal.classList.remove('show');
      showToast('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼');

      // Update button to "ç‰¹å…¸äº¤æ›" with green glow
      updateSurveyActionButton();

      // Auto-open badge exchange modal after 500ms
      setTimeout(() => {
        openBadgeExchangeModal();
      }, 500);
    }
  } catch (err) {
    console.error('Survey submission failed:', err);
    $app.survey.error.textContent = 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
  }
}

// ========== Survey Action Button Update ==========
function updateSurveyActionButton() {
  const isSurveyCompleted = state.surveyCompleted || (state.user && state.user.survey_completed);
  const isBadgeClaimed = state.user?.badge_claimed ?? false;

  console.log('[updateSurveyActionButton] State:', {
    survey_completed: isSurveyCompleted,
    badge_claimed: isBadgeClaimed,
    'state.user': state.user
  });

  if (!$app.surveyActionBtn) return;

  // Remove all state classes first
  $app.surveyActionBtn.classList.remove('ready-to-claim', 'claimed', 'opacity-50', 'cursor-not-allowed');

  if (isBadgeClaimed) {
    // Badge already claimed - disable button with grey style
    $app.surveyActionBtn.disabled = true;
    $app.surveyActionBtn.classList.add('opacity-50', 'cursor-not-allowed', 'claimed');
    $app.surveyActionText.textContent = 'äº¤æ›æ¸ˆã¿';
    // Hide subtext for claimed state
    if ($app.surveyActionSubtext) {
      $app.surveyActionSubtext.classList.add('hidden');
    }
  } else if (isSurveyCompleted) {
    // Survey completed but badge not claimed - show "ç‰¹å…¸äº¤æ›" with green glow
    $app.surveyActionBtn.disabled = false;
    $app.surveyActionBtn.classList.add('ready-to-claim');
    $app.surveyActionText.textContent = 'ç‰¹å…¸äº¤æ›';
    // Hide subtext for claim state
    if ($app.surveyActionSubtext) {
      $app.surveyActionSubtext.classList.add('hidden');
    }
  } else {
    // Survey not completed - show "ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”"
    $app.surveyActionBtn.disabled = false;
    $app.surveyActionText.textContent = 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”';
    // Show subtext for survey state
    if ($app.surveyActionSubtext) {
      $app.surveyActionSubtext.classList.remove('hidden');
    }
  }
}

// ========== Badge Claim Function ==========
async function claimBadge() {
  if (!state.user?.id) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }

  if (state.user.badge_claimed) {
    showToast('ç‰¹å…¸ã¯æ—¢ã«äº¤æ›æ¸ˆã¿ã§ã™');
    return;
  }

  try {
    const result = await callEdgeFunction('claim-badge', {
      userId: state.user.id
    });

    if (result.success) {
      state.user.badge_claimed = true;
      saveLocalUser(state.user);

      // Show "Just Claimed" screen instead of closing modal
      const exchangeInterfaceDiv = document.getElementById('badge-exchange-interface');
      const justClaimedDiv = document.getElementById('badge-just-claimed');
      exchangeInterfaceDiv.classList.add('hidden');
      justClaimedDiv.classList.remove('hidden');

      // Update button to disabled state
      updateSurveyActionButton();
    }
  } catch (err) {
    console.error('Badge claim failed:', err);

    // Check if error is "already claimed"
    if (err.message && err.message.includes('already claimed')) {
      // Update state to reflect server status
      state.user.badge_claimed = true;
      saveLocalUser(state.user);

      // Switch modal display to "Already Claimed"
      const alreadyClaimedDiv = document.getElementById('badge-already-claimed');
      const exchangeInterfaceDiv = document.getElementById('badge-exchange-interface');
      alreadyClaimedDiv.classList.remove('hidden');
      exchangeInterfaceDiv.classList.add('hidden');

      // Update button state
      updateSurveyActionButton();

      showToast('ç‰¹å…¸ã¯æ—¢ã«äº¤æ›æ¸ˆã¿ã§ã™');
    } else {
      showToast('äº¤æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }
}


// ========== ã‚µãƒ¼ãƒãƒ¼åŒæœŸç³» ==========

// Supabaseå´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ/å–å¾—
async function ensureAuth() {
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
  const urlParams = new URLSearchParams(window.location.search);
  const hasPreRegParam = urlParams.get('mode') === 'prereg';

  // å„ªå…ˆé †ä½1: æ—¢ã«äº‹å‰ç™»éŒ²UUIDãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  const preRegUuid = localStorage.getItem('user_uuid_pre_registration');

  let registrationType;
  let uuid;
  let storageKey;

  if (preRegUuid) {
    // æ—¢ã«äº‹å‰ç™»éŒ²æ¸ˆã¿ â†’ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«é–¢ã‚ã‚‰ãšäº‹å‰ç™»éŒ²ã¨ã—ã¦æ‰±ã†
    registrationType = 'pre_registration';
    uuid = preRegUuid;
    storageKey = 'user_uuid_pre_registration';
  } else if (hasPreRegParam) {
    // æ–°è¦äº‹å‰ç™»éŒ²
    registrationType = 'pre_registration';
    storageKey = 'user_uuid_pre_registration';
    uuid = localStorage.getItem(storageKey);
    if (!uuid) {
      uuid = crypto.randomUUID();
      localStorage.setItem(storageKey, uuid);
    }
  } else {
    // å½“æ—¥ç™»éŒ²
    registrationType = 'on_site';
    storageKey = 'user_uuid_on_site';
    uuid = localStorage.getItem(storageKey);
    if (!uuid) {
      uuid = crypto.randomUUID();
      localStorage.setItem(storageKey, uuid);
    }
  }

  // ä»®ã®state.user
  state.user = {
    id: uuid,
    name: 'åŒ¿åå‚åŠ è€…',
    registration_type: registrationType
  };

  // UIã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼ˆã‚‚ã—ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã‚‹ãªã‚‰ï¼‰
  const root = document.getElementById('app');
  root.classList.remove('opacity-0', 'pointer-events-none', 'select-none');

  try {
    const serverData = await callEdgeFunction('get-user-data', {
      userId: uuid,
      registrationType: registrationType
    });

    if (serverData && serverData.user) {
      console.log('[ensureAuth] Received from Supabase:', {
        survey_completed: serverData.user.survey_completed,
        badge_claimed: serverData.user.badge_claimed
      });

      state.user = {
        id: serverData.user.id,
        user_number: serverData.user.user_number || 0,
        registration_type: serverData.user.registration_type,
        survey_completed: serverData.user.survey_completed ?? false,
        badge_claimed: serverData.user.badge_claimed ?? false,
        created_at: serverData.user.created_at,
        points: serverData.user.points ?? 0,
        total_points: serverData.user.total_points ?? 0,
        redeemable_points: serverData.user.redeemable_points ?? 0
      };

      console.log('[ensureAuth] Set state.user.badge_claimed:', state.user.badge_claimed);

      state.points = serverData.user.redeemable_points ?? 0;
      state.totalPoints = serverData.user.total_points ?? 0;
      state.surveyCompleted = serverData.user.survey_completed ?? false;

      if (serverData.progress && Array.isArray(serverData.progress.acquiredBooths)) {
        state.acquiredStamps = new Set(serverData.progress.acquiredBooths);
      } else {
        state.acquiredStamps = new Set();
      }

      const userNumberElement = document.getElementById('user-number');
      if (userNumberElement) {
        const formattedNumber = String(serverData.user.user_number || 0).padStart(5, '0');
        userNumberElement.textContent = formattedNumber;
      }

      saveLocalUser(state.user);
    }
  } catch (err) {
    console.error('[ensureAuth] Failed to sync user from server:', err);
    // fail soft: ã‚¢ãƒ—ãƒªã¯å‹•ã‹ã™
  }
  updateSurveyActionButton();
}

// æœ€æ–°çŠ¶æ…‹ã‚’DBã‹ã‚‰å†å–å¾—
async function syncPointsFromServer() {
  if (!state.user?.id) {
    return;
  }

  try {
    const data = await callEdgeFunction('get-user-data', {
      userId: state.user.id
    });

    if (data && data.user) {
      state.points = data.user.redeemable_points ?? 0;
      state.totalPoints = data.user.total_points ?? 0;
      state.surveyCompleted = data.user.survey_completed ?? false;

      state.user.user_number = data.user.user_number || state.user.user_number;
      state.user.survey_completed = data.user.survey_completed ?? false;
      state.user.badge_claimed = data.user.badge_claimed ?? false;
      state.user.points = data.user.points ?? 0;
      state.user.total_points = data.user.total_points ?? 0;
      state.user.redeemable_points = data.user.redeemable_points ?? 0;

      saveLocalUser(state.user);

      const userNumberElement = document.getElementById('user-number');
      if (userNumberElement) {
        const formattedNumber = String(state.user.user_number || 0).padStart(5, '0');
        userNumberElement.textContent = formattedNumber;
      }
    }

    if (data && data.progress && Array.isArray(data.progress.acquiredBooths)) {
      state.acquiredStamps = new Set(data.progress.acquiredBooths);
    }

    await updatePercentile();
    renderAll();

    // Update survey action button to reflect badge_claimed status
    updateSurveyActionButton();
  } catch (err) {
    console.error('[syncPointsFromServer] Failed to sync points:', err);
  }
}

// ========== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç³» ==========
async function updatePercentile() {
  if (!state.user?.id || state.totalPoints === 0) {
    state.percentile = null;
    return;
  }
  try {
    const result = await callEdgeFunction('get-percentile', {
      userId: state.user.id
    });
    state.percentile = result.percentile;
  } catch (err) {
    console.error('Failed to calculate percentile:', err);
    state.percentile = null;
  }
}

// ========== é€²æ—ãƒ»ãƒšãƒ¼ã‚¸æç”»ç³» ==========
function renderAll() {
  try {
    renderProgress();
    updateActivePage();
    if (state.activePage === 'map') {
      layoutBoothIcons();
    }
  } catch (error) {
    console.error('renderAll ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚’ç¶šè¡Œ
  }
}

// ä¼æ¥­åã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è‡ªå‹•èª¿æ•´
function adjustBoothCompanyNameSizes() {
  const companyNames = document.querySelectorAll('.booth-company-name');
  companyNames.forEach(nameEl => {
    const text = nameEl.textContent || '';
    const length = text.length;

    // æ–‡å­—æ•°ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´
    if (length > 20) {
      nameEl.style.fontSize = '0.75rem'; // 12px
    } else if (length > 15) {
      nameEl.style.fontSize = '0.85rem'; // 13.6px
    } else if (length > 12) {
      nameEl.style.fontSize = '0.9rem'; // 14.4px
    } else {
      nameEl.style.fontSize = '1rem'; // 16px
    }
  });
}

function renderProgress() {
  try {
    // totalPoints ã‚’ã€Œç²å¾—ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã€ã¨ã—ã¦æ‰±ã†å‰æ
    const n = state.totalPoints;

  $app.progress.badge.textContent = `${state.totalPoints}pt`;

  if (state.percentile !== null) {
    const displayPercentile = (state.percentile === 0) ? 1 : state.percentile;
    $app.progress.rankPercentile.textContent = `ä¸Šä½ ${displayPercentile}%`;
    $app.progress.rankPercentile.classList.remove('hidden');
  } else {
    $app.progress.rankPercentile.classList.add('hidden');
  }

  // ãƒ­ã‚´ã‚°ãƒªãƒƒãƒ‰
  if ($app.progress.logoGrid) {
    $app.progress.logoGrid.innerHTML = '';
    BOOTH_DATA.forEach(booth => {
      const isAcquired = state.acquiredStamps.has(booth.id);
      const imgSrc = isAcquired ? `booth/${booth.mapIcon}2.png` : `booth/${booth.mapIcon}.png`;
      const logoItem = document.createElement('div');
      logoItem.className = `company-logo-item ${isAcquired ? 'acquired' : 'not-acquired'}`;
      logoItem.innerHTML = `
        <div class="company-room-badge">${booth.room}</div>
        <img src="${imgSrc}" alt="${booth.name}" loading="lazy">
      `;
      $app.progress.logoGrid.appendChild(logoItem);
    });
  }

  // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
  if ($app.progress.stampCount) {
    $app.progress.stampCount.textContent = n;
  }

  if (n >= MAX_POINTS) {
    $app.progress.msg.innerHTML = 'ğŸ‰ <strong>å…¨ã¦ã®ãƒ–ãƒ¼ã‚¹ã‚’å›ã‚Šã¾ã—ãŸï¼</strong> ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
  } else {
    $app.progress.msg.innerHTML = `ã‚ã¨<strong>${MAX_POINTS - n}</strong>ãƒ–ãƒ¼ã‚¹ã§å…¨ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼`;
  }

    updateAcquiredBadges();
    state.prevCount = n;
  } catch (error) {
    console.error('renderProgress ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚’ç¶šè¡Œ
  }
}

function updateAcquiredBadges() {
  const boothIds = ['A', 'B', 'C', 'D', 'E', 'F'];
  const acquiredBooths = boothIds.filter(id => state.acquiredStamps.has(id)).length;
  const boothProgress = document.getElementById('booth-progress');
  if (boothProgress) {
    boothProgress.textContent = `${acquiredBooths}/6 ç²å¾—æ¸ˆã¿`;
    if (acquiredBooths === 6) {
      boothProgress.style.color = '#059669';
    }
  }
}

function updateActivePage() {
  try {
    if ($app.pages) {
      $app.pages.forEach(p => {
        if (!p) return;
        const isActive = p.id === `page-${state.activePage}`;
        p.classList.toggle('active', isActive);
        p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
      });
    }

    let activeBtn = null;
    if ($app.navButtons) {
      $app.navButtons.forEach(btn => {
        if (!btn) return;
        const isActive = btn.dataset.page === state.activePage;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-current', isActive ? 'page' : 'false');
        if (isActive) activeBtn = btn;
      });
    }

    if (activeBtn && $app.navIndicator) {
      const btnW = activeBtn.offsetWidth;
      const indW = Math.max(56, Math.round(btnW * 0.66));
      const left = activeBtn.offsetLeft + (btnW - indW) / 2;
      $app.navIndicator.style.width = `${indW}px`;
      $app.navIndicator.style.transform = `translate(${left}px, -50%)`;
    }

    const pageTitles = { home: 'ãƒ›ãƒ¼ãƒ ', map: 'ãƒãƒƒãƒ—' };
    if ($app.headerTitle) {
      $app.headerTitle.textContent = pageTitles[state.activePage];
    }

    if (state.activePage === 'map') {
      layoutBoothIcons();
    }
  } catch (error) {
    console.error('updateActivePage ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚’ç¶šè¡Œ
  }
}

// ========== ãƒ–ãƒ¼ã‚¹ è©³ç´°ã‚·ãƒ¼ãƒˆ ==========
function openBoothSheet(booth) {
  try {
    if (!booth) return;
    if ($app.boothSheet.title) {
      $app.boothSheet.title.textContent = booth.name;
    }
    if ($app.boothSheet.desc) {
      $app.boothSheet.desc.textContent = booth.desc;
    }
    if ($app.boothSheet.el) {
      $app.boothSheet.el.classList.add('is-open');
    }
    if ($app.boothSheet.backdrop) {
      $app.boothSheet.backdrop.classList.add('is-open');
    }
  } catch (error) {
    console.error('openBoothSheet ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
  }
}

function closeBoothSheet() {
  try {
    if ($app.boothSheet.el) {
      $app.boothSheet.el.classList.remove('is-open');
    }
    if ($app.boothSheet.backdrop) {
      $app.boothSheet.backdrop.classList.remove('is-open');
    }
  } catch (error) {
    console.error('closeBoothSheet ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
  }
}

// ========== ã‚¹ã‚­ãƒ£ãƒŠé–¢é€£ ==========
let scanStream = null;
let useBackCamera = true;
let trackWithTorch = null;
let scanning = false;
let codeReader = null;

async function openFullscreenScanner() {
  try {
    if ($app.fullscreenScanner.container) {
      $app.fullscreenScanner.container.classList.add('active');
    }
    await startCamera();
  } catch (error) {
    console.error('openFullscreenScanner ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
  }
}

function closeFullscreenScanner() {
  try {
    stopCamera();
    if ($app.fullscreenScanner.container) {
      $app.fullscreenScanner.container.classList.remove('active');
    }
  } catch (error) {
    console.error('closeFullscreenScanner ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
  }
}

async function startCamera() {
  try {
    if ($app.fullscreenScanner.status) {
      $app.fullscreenScanner.status.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦';
    }

    if (!codeReader) {
      codeReader = new ZXing.BrowserQRCodeReader();
    }

    const constraints = {
      video: {
        facingMode: useBackCamera ? 'environment' : 'user',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };

    scanStream = await navigator.mediaDevices.getUserMedia(constraints);
    if ($app.fullscreenScanner.video) {
      $app.fullscreenScanner.video.srcObject = scanStream;
      await $app.fullscreenScanner.video.play();
    }

    try {
      const [track] = scanStream.getVideoTracks();
      const caps = track.getCapabilities?.();
      if (caps && 'torch' in caps) {
        trackWithTorch = track;
        if ($app.fullscreenScanner.torchBtn) {
          $app.fullscreenScanner.torchBtn.classList.remove('opacity-50', 'pointer-events-none');
        }
      } else {
        if ($app.fullscreenScanner.torchBtn) {
          $app.fullscreenScanner.torchBtn.classList.add('opacity-50', 'pointer-events-none');
        }
      }
    } catch (e) {
      console.warn('Torch not available');
      if ($app.fullscreenScanner.torchBtn) {
        $app.fullscreenScanner.torchBtn.classList.add('opacity-50', 'pointer-events-none');
      }
    }

    scanning = true;
    if ($app.fullscreenScanner.status) {
      $app.fullscreenScanner.status.textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å†™ã—ã¦ãã ã•ã„';
    }

    scanQRCode();
  } catch (err) {
    console.error(err);
    if ($app.fullscreenScanner.status) {
      $app.fullscreenScanner.status.textContent = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    }
  }
}

async function scanQRCode() {
  if (!scanning || !$app.fullscreenScanner.video || !$app.fullscreenScanner.video.srcObject) return;

  try {
    const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'fullscreen-video');
    if (result && result.text) {
      scanning = false;
      await handleScanResult(result.text);
      return;
    }
  } catch (err) {
    // è¦‹ã¤ã‹ã‚‰ãªã„ç­‰ã¯ç„¡è¦–ã—ã¦ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
  }

  if (scanning) {
    requestAnimationFrame(() => scanQRCode());
  }
}

async function stopCamera() {
  scanning = false;

  if (codeReader) {
    try {
      await codeReader.reset();
    } catch (e) {
      console.warn('Failed to reset code reader', e);
    }
  }

  if (scanStream) {
    scanStream.getTracks().forEach(t => {
      t.stop();
      console.log('Track stopped:', t.label);
    });
    scanStream = null;
  }

  if ($app.fullscreenScanner.video && $app.fullscreenScanner.video.srcObject) {
    $app.fullscreenScanner.video.srcObject = null;
  }

  trackWithTorch = null;
  if ($app.fullscreenScanner.torchBtn) {
    $app.fullscreenScanner.torchBtn.dataset.on = '0';
    $app.fullscreenScanner.torchBtn.classList.remove('bg-amber-200');
  }
}

async function toggleTorch() {
  if (!trackWithTorch || !$app.fullscreenScanner.torchBtn) return;
  const on = $app.fullscreenScanner.torchBtn.dataset.on === '1';
  try {
    await trackWithTorch.applyConstraints({ advanced: [{ torch: !on }] });
    if ($app.fullscreenScanner.torchBtn) {
      $app.fullscreenScanner.torchBtn.dataset.on = on ? '0' : '1';
      $app.fullscreenScanner.torchBtn.classList.toggle('bg-amber-200');
    }
  } catch (e) {
    console.warn('Torch not available', e);
  }
}

async function switchCamera() {
  useBackCamera = !useBackCamera;
  await stopCamera();
  setTimeout(() => {
    startCamera();
  }, 300);
}

function showFullscreenMessage(msg, isError = true) {
  const el = document.getElementById('fullscreen-message');
  const box = el.firstElementChild;
  box.textContent = msg;
  box.className = `px-4 py-3 rounded-2xl shadow-lg text-center font-medium ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
  el.classList.remove('hidden');
  clearTimeout(showFullscreenMessage._t);
  showFullscreenMessage._t = setTimeout(() => {
    el.classList.add('hidden');
  }, 2000);
}

async function handleScanResult(rawText) {
  if (!state.user?.id) {
    showFullscreenMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“', true);
    return false;
  }

  // URLã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—IDã‚’æŠ½å‡º
  let stampId = rawText;
  try {
    const url = new URL(rawText);
    const urlStampId = url.searchParams.get('stamp');
    if (urlStampId) {
      stampId = urlStampId;
    }
  } catch (e) {
    // URLã§ã¯ãªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ã†
  }

  const boothId = stampId;
  const stampCode = stampId;

  try {
    const result = await callEdgeFunction('grant-stamp', {
      userId: state.user.id,
      boothId,
      stampCode
    });

    if (result.success) {
      console.log('[DEBUG] QR Success - Before update:', {
        oldTotalPoints: state.totalPoints,
        oldAcquiredStamps: Array.from(state.acquiredStamps),
        newTotalPoints: result.newTotalPoints,
        newAcquiredStamps: result.acquiredStamps
      });

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ç›´æ¥ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ï¼ˆè¿½åŠ APIä¸è¦ï¼‰
      if (result.newTotalPoints !== undefined) {
        state.totalPoints = result.newTotalPoints;
        state.user.total_points = result.newTotalPoints;
      }
      if (result.newRedeemablePoints !== undefined) {
        state.points = result.newRedeemablePoints;
        state.user.redeemable_points = result.newRedeemablePoints;
        state.user.points = result.newRedeemablePoints;
      }
      if (result.acquiredStamps) {
        state.acquiredStamps = new Set(result.acquiredStamps);
      }

      console.log('[DEBUG] QR Success - After update:', {
        newTotalPoints: state.totalPoints,
        newAcquiredStamps: Array.from(state.acquiredStamps),
        activePage: state.activePage
      });

      // localStorageã«ä¿å­˜
      saveLocalUser(state.user);

      showFullscreenMessage(`âœ… ${result.pointsAdded}ptç²å¾—ï¼`, false);

      // UIã‚’å®Œå…¨ã«æ›´æ–°ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ï¼‹å…¨UIï¼‰
      await updatePercentile();
      console.log('[DEBUG] Before renderAll()');
      renderAll();
      console.log('[DEBUG] After renderAll()');

      // å¾…æ©Ÿæ™‚é–“ã‚’çŸ­ç¸® & ã‚«ãƒ¡ãƒ©ã‚’æ—©ãé–‰ã˜ã‚‹
      await wait(800);
      closeFullscreenScanner();
      return true;
    }
  } catch (error) {
    console.error('Stamp grant error:', error);

    if (error.message.includes('å–å¾—æ¸ˆã¿')) {
      showFullscreenMessage('âš ï¸ æ—¢ã«å–å¾—æ¸ˆã¿ã§ã™', true);
    } else if (error.message.includes('æœªå¯¾å¿œ')) {
      showFullscreenMessage('âŒ æœªå¯¾å¿œã®QRã‚³ãƒ¼ãƒ‰ã§ã™', true);
    } else {
      showFullscreenMessage('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
    }

    await wait(1500);
    return false;
  }
}

function wait(ms) {
  return new Promise(r => setTimeout(r, ms));
}

async function autoGrantStamp(stampId) {
  if (!state.user?.id) {
    showToast('ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return false;
  }

  const boothId = stampId.toLowerCase();
  const stampCode = stampId.toLowerCase();

  try {
    showToast('ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç¢ºèªä¸­...');

    const result = await callEdgeFunction('grant-stamp', {
      userId: state.user.id,
      boothId,
      stampCode
    });

    if (result.success) {
      showToast(`âœ… ${result.pointsAdded}ptç²å¾—ï¼`);
      await syncPointsFromServer();
      return true;
    }
  } catch (error) {
    console.error('[autoGrantStamp] Error:', error);

    if (error.message.includes('å–å¾—æ¸ˆã¿')) {
      showToast('âš ï¸ æ—¢ã«å–å¾—æ¸ˆã¿ã§ã™');
    } else if (error.message.includes('æœªå¯¾å¿œ')) {
      showToast('âŒ ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™');
    } else {
      showToast('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }

    return false;
  }
}

// ========== ãƒˆãƒ¼ã‚¹ãƒˆ ==========
function showToast(msg) {
  const el = $app.toast;
  const box = el.firstElementChild;
  box.textContent = msg;
  el.classList.remove('hidden');
  el.classList.add('animate-bounce');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => {
    el.classList.add('hidden');
    el.classList.remove('animate-bounce');
  }, 1800);
}

// ========== ãƒãƒƒãƒ—(ãƒ–ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) ==========
// SVGã‚¢ã‚¤ã‚³ãƒ³ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const boothIconsCache = new Map();

function layoutBoothIcons() {
  try {
    const g = $app.map.iconsGroup;
    if (!g) return;

    const vb = $app.map.svg.viewBox.baseVal;
    const base = Math.min(vb.width, vb.height);
    const size = Math.max(100, Math.min(280, Math.round(base * 0.14)));

    Object.keys(BOOTH_ANCHORS).forEach(id => {
    const a = BOOTH_ANCHORS[id];
    const cx = vb.width * a.x;
    const cy = vb.height * a.y;
    const x = cx - size / 2;
    const y = cy - size / 2;

    const booth = BOOTH_DATA.find(b => b.id === id) || { img: IMG_DEFAULT };
    const isAcquired = state.acquiredStamps.has(id);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã¾ãŸã¯æ–°è¦ä½œæˆ
    let group = boothIconsCache.get(id);

    if (!group) {
      // åˆå›ä½œæˆ
      group = document.createElementNS('http://www.w3.org/2000/svg','g');
      group.setAttribute('cursor', 'pointer');
      group.setAttribute('role', 'button');
      group.setAttribute('aria-label', booth.name);
      group.dataset.id = id;

      const baseRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      baseRect.setAttribute('rx', size * 0.18);
      baseRect.setAttribute('stroke-width', '2');
      baseRect.classList.add('booth-base-rect');
      group.appendChild(baseRect);

      const border = document.createElementNS('http://www.w3.org/2000/svg','rect');
      border.setAttribute('rx', size * 0.18);
      border.setAttribute('fill', 'white');
      border.setAttribute('stroke-width', '4');
      border.style.filter = 'drop-shadow(0 4px 12px rgba(0,0,0,0.15))';
      border.classList.add('booth-border');
      group.appendChild(border);

      const innerShadow = document.createElementNS('http://www.w3.org/2000/svg','rect');
      innerShadow.setAttribute('rx', size * 0.15);
      innerShadow.setAttribute('fill', 'none');
      innerShadow.setAttribute('stroke', 'rgba(0,0,0,0.1)');
      innerShadow.setAttribute('stroke-width', '1');
      innerShadow.classList.add('booth-inner-shadow');
      group.appendChild(innerShadow);

      const clipId = `clip-${id}`;
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      const clipPath = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
      clipPath.setAttribute('id', clipId);
      const clipRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      clipRect.setAttribute('rx', size * 0.15);
      clipRect.classList.add('booth-clip-rect');
      clipPath.appendChild(clipRect);
      defs.appendChild(clipPath);
      group.appendChild(defs);

      const fillRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      fillRect.setAttribute('rx', size * 0.15);
      fillRect.setAttribute('fill', '#fff');
      fillRect.setAttribute('clip-path', `url(#${clipId})`);
      fillRect.classList.add('booth-fill-rect');
      group.appendChild(fillRect);

      const iconImage = document.createElementNS('http://www.w3.org/2000/svg','image');
      iconImage.setAttribute('clip-path', `url(#${clipId})`);
      iconImage.setAttribute('preserveAspectRatio', 'xMidYMid meet');
      iconImage.classList.add('booth-icon-image');
      group.appendChild(iconImage);

      const checkBg = document.createElementNS('http://www.w3.org/2000/svg','circle');
      checkBg.setAttribute('fill', '#10b981');
      checkBg.setAttribute('stroke', 'white');
      checkBg.setAttribute('stroke-width', '3');
      checkBg.classList.add('booth-check-bg');
      checkBg.style.display = 'none';
      group.appendChild(checkBg);

      const checkMark = document.createElementNS('http://www.w3.org/2000/svg','text');
      checkMark.setAttribute('text-anchor', 'middle');
      checkMark.setAttribute('dominant-baseline', 'central');
      checkMark.setAttribute('fill', 'white');
      checkMark.setAttribute('font-weight', 'bold');
      checkMark.textContent = 'âœ“';
      checkMark.classList.add('booth-check-mark');
      checkMark.style.display = 'none';
      group.appendChild(checkMark);

      boothIconsCache.set(id, group);
      g.appendChild(group);
    }

    // ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’æ›´æ–°ï¼ˆnullãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼‰
    const baseRect = group.querySelector('.booth-base-rect');
    if (baseRect) {
      baseRect.setAttribute('x', x + 1);
      baseRect.setAttribute('y', y + 1);
      baseRect.setAttribute('width', size);
      baseRect.setAttribute('height', size);
      baseRect.setAttribute('fill', isAcquired ? '#34d399' : '#cbd5e1');
      baseRect.setAttribute('stroke', isAcquired ? '#10b981' : '#64748b');
    }

    const border = group.querySelector('.booth-border');
    if (border) {
      border.setAttribute('x', x);
      border.setAttribute('y', y);
      border.setAttribute('width', size);
      border.setAttribute('height', size);
      border.setAttribute('stroke', isAcquired ? 'url(#acquired-gradient)' : 'url(#border-gradient)');
    }

    const innerShadow = group.querySelector('.booth-inner-shadow');
    if (innerShadow) {
      innerShadow.setAttribute('x', x + 4);
      innerShadow.setAttribute('y', y + 4);
      innerShadow.setAttribute('width', size - 8);
      innerShadow.setAttribute('height', size - 8);
    }

    const clipRect = group.querySelector('.booth-clip-rect');
    if (clipRect) {
      clipRect.setAttribute('x', x + 5);
      clipRect.setAttribute('y', y + 5);
      clipRect.setAttribute('width', size - 10);
      clipRect.setAttribute('height', size - 10);
    }

    const fillRect = group.querySelector('.booth-fill-rect');
    if (fillRect) {
      fillRect.setAttribute('x', x + 5);
      fillRect.setAttribute('y', y + 5);
      fillRect.setAttribute('width', size - 10);
      fillRect.setAttribute('height', size - 10);
    }

    // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’æ›´æ–°
    const iconSuffix = isAcquired ? '2' : '';
    const iconPath = booth.mapIcon ? `booth/${booth.mapIcon}${iconSuffix}.png` : '';
    const iconImage = group.querySelector('.booth-icon-image');
    if (iconImage) {
      iconImage.setAttribute('x', x + 5);
      iconImage.setAttribute('y', y + 5);
      iconImage.setAttribute('width', size - 10);
      iconImage.setAttribute('height', size - 10);
      iconImage.setAttribute('href', iconPath);
    }

    // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º
    const checkBg = group.querySelector('.booth-check-bg');
    const checkMark = group.querySelector('.booth-check-mark');
    if (checkBg && checkMark) {
      if (isAcquired) {
        checkBg.setAttribute('cx', x + size - 20);
        checkBg.setAttribute('cy', y + 20);
        checkBg.setAttribute('r', size * 0.12);
        checkBg.style.display = 'block';

        checkMark.setAttribute('x', x + size - 20);
        checkMark.setAttribute('y', y + 20);
        checkMark.setAttribute('font-size', size * 0.12);
        checkMark.style.display = 'block';
      } else {
        checkBg.style.display = 'none';
        checkMark.style.display = 'none';
      }
    }
  });

  if (!document.getElementById('highlight-gradient')) {
    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

    const gradient = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    gradient.setAttribute('id', 'highlight-gradient');
    gradient.setAttribute('x1', '0');
    gradient.setAttribute('y1', '0');
    gradient.setAttribute('x2', '0');
    gradient.setAttribute('y2', '1');
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    stop1.setAttribute('offset', '0%');
    stop1.setAttribute('stop-color', 'white');
    stop1.setAttribute('stop-opacity', '0.9');
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    stop2.setAttribute('offset', '100%');
    stop2.setAttribute('stop-color', 'white');
    stop2.setAttribute('stop-opacity', '0');
    gradient.appendChild(stop1);
    gradient.appendChild(stop2);
    defs.appendChild(gradient);

    const borderGrad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    borderGrad.setAttribute('id', 'border-gradient');
    borderGrad.setAttribute('x1', '0');
    borderGrad.setAttribute('y1', '0');
    borderGrad.setAttribute('x2', '0');
    borderGrad.setAttribute('y2', '1');
    const b1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    b1.setAttribute('offset', '0%');
    b1.setAttribute('stop-color', '#f1f5f9');
    const b2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    b2.setAttribute('offset', '50%');
    b2.setAttribute('stop-color', '#e2e8f0');
    const b3 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    b3.setAttribute('offset', '100%');
    b3.setAttribute('stop-color', '#cbd5e1');
    borderGrad.appendChild(b1);
    borderGrad.appendChild(b2);
    borderGrad.appendChild(b3);
    defs.appendChild(borderGrad);

    const acquiredGrad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    acquiredGrad.setAttribute('id', 'acquired-gradient');
    acquiredGrad.setAttribute('x1', '0');
    acquiredGrad.setAttribute('y1', '0');
    acquiredGrad.setAttribute('x2', '0');
    acquiredGrad.setAttribute('y2', '1');
    const a1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    a1.setAttribute('offset', '0%');
    a1.setAttribute('stop-color', '#6ee7b7');
    const a2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    a2.setAttribute('offset', '50%');
    a2.setAttribute('stop-color', '#34d399');
    const a3 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    a3.setAttribute('offset', '100%');
    a3.setAttribute('stop-color', '#10b981');
    acquiredGrad.appendChild(a1);
    acquiredGrad.appendChild(a2);
    acquiredGrad.appendChild(a3);
    defs.appendChild(acquiredGrad);

    const stdShadowFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
    stdShadowFilter.setAttribute('id', 'std-shadow');
    const feStdShadow = document.createElementNS('http://www.w3.org/2000/svg', 'feDropShadow');
    feStdShadow.setAttribute('dx', '0');
    feStdShadow.setAttribute('dy', '2');
    feStdShadow.setAttribute('stdDeviation', '6');
    feStdShadow.setAttribute('flood-color', '#000000');
    feStdShadow.setAttribute('flood-opacity', '0.2');
    stdShadowFilter.appendChild(feStdShadow);
    defs.appendChild(stdShadowFilter);

    const glowFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
    glowFilter.setAttribute('id', 'acquired-glow');
    const feGlowShadow = document.createElementNS('http://www.w3.org/2000/svg', 'feDropShadow');
    feGlowShadow.setAttribute('dx', '0');
    feGlowShadow.setAttribute('dy', '4');
    feGlowShadow.setAttribute('stdDeviation', '10');
    feGlowShadow.setAttribute('flood-color', '#10b981');
    feGlowShadow.setAttribute('flood-opacity', '0.75');
    glowFilter.appendChild(feGlowShadow);
    defs.appendChild(glowFilter);

    $app.map.svg.insertBefore(defs, $app.map.svg.firstChild);
  }

    g.querySelectorAll('g[data-id]').forEach(el => el.addEventListener('click', () => {
      const booth = BOOTH_DATA.find(b => b.id === el.dataset.id);
      if (booth) openBoothSheet(booth);
    }));
  } catch (error) {
    console.error('layoutBoothIcons ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚’ç¶šè¡Œ
  }
}

// ========== ã‚¢ãƒ³ã‚±æ³¨ç›®UI(é¸æŠçŠ¶æ…‹ã®è¦‹ãŸç›®) ==========
function setupSurveyInteractivity() {
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const group = e.target.name;
      document.querySelectorAll(`input[name="${group}"]`).forEach(r => {
        r.closest('.survey-option').classList.remove('checked');
      });
      e.target.closest('.survey-option').classList.add('checked');
    });
  });

  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      e.target.closest('.survey-option').classList.toggle('checked', e.target.checked);
    });
  });

  // Q9ã®ã€Œãã®ä»–ã€é¸æŠæ™‚ã«å…¥åŠ›æ¬„ã‚’è¡¨ç¤ºï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
  const workReasonsOther = document.getElementById('work-reasons-other');
  const workReasonsOtherInput = document.getElementById('work-reasons-other-input');

  if (workReasonsOther && workReasonsOtherInput) {
    workReasonsOther.addEventListener('change', (e) => {
      if (e.target.checked) {
        workReasonsOtherInput.classList.remove('hidden');
      } else {
        workReasonsOtherInput.classList.add('hidden');
      }
    });
  }
}

// ========== init() ==========
async function init() {
  try {
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚«ãƒ¡ãƒ© or æ·±ã„ãƒªãƒ³ã‚¯)
    const urlParams = new URLSearchParams(window.location.search);
    const stampId = urlParams.get('stamp');

    // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼æº–å‚™ & ã‚µãƒ¼ãƒãƒ¼å´ã¨åŒæœŸ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚‚ã“ã“ã§ã‚„ã‚‹)
    await ensureAuth();

  // æœ€åˆã®æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ï¼ˆãƒã‚¤ãƒ³ãƒˆ/ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§/percentileãªã©ï¼‰
  await syncPointsFromServer();

  // stampãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å³ä»˜ä¸
  if (stampId) {
    await autoGrantStamp(stampId);
    window.history.replaceState({}, '', window.location.pathname);
  }

  // äº‹å‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãURLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«UUID QRã‚’è‡ªå‹•è¡¨ç¤º
  const isPreRegUrl = urlParams.get('mode') === 'prereg';
  const shouldShowUuidQr = state.user?.registration_type === 'pre_registration' && isPreRegUrl;

  // åˆå›è¨ªå•æ™‚ã®è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆäº‹å‰ç™»éŒ²QRã‚ˆã‚Šã‚‚å‰ã«è¡¨ç¤ºï¼‰
  if (isFirstVisit()) {
    showFirstTimeWarning();
    // äº‹å‰ç™»éŒ²QRã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ãŸå¾Œã«è¡¨ç¤º
    if (shouldShowUuidQr) {
      window._shouldOpenUuidQrAfterWarning = true;
    }
  } else if (shouldShowUuidQr) {
    // åˆå›è¨ªå•ã§ãªã„å ´åˆã¯é€šå¸¸é€šã‚Šè¡¨ç¤º
    setTimeout(() => {
      openUuidQrModal();
    }, 500);
  }

  // é€£ç•ªã‚¯ãƒªãƒƒã‚¯ã§UUID QRè¡¨ç¤ºï¼ˆäº‹å‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
  const userNumberElement = document.getElementById('user-number');
  if (userNumberElement) {
    userNumberElement.addEventListener('click', () => {
      openUuidQrModal();
    });
    // äº‹å‰ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã“ã¨ã‚’ç¤ºã™ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
    if (state.user?.registration_type === 'pre_registration') {
      userNumberElement.style.cursor = 'pointer';
      userNumberElement.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦å—ä»˜QRã‚’è¡¨ç¤º';
    }
  }

  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  $app.navButtons.forEach(btn => {
    if (!btn) return;
    btn.addEventListener('click', () => {
      state.activePage = btn.dataset.page;
      updateActivePage();
    });
  });
  if ($app.nav) {
    $app.nav.addEventListener('click', (e) => {
      const btn = e.target.closest('.nav-btn');
      if (!btn) return;
      state.activePage = btn.dataset.page;
      updateActivePage();
    });
  }

  // å„ä¼æ¥­ãƒ–ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰
  document.querySelectorAll('.stamp-booth-card').forEach(card => {
    card.addEventListener('click', () => {
      const boothId = card.dataset.boothId;
      const booth = BOOTH_DATA.find(b => b.id === boothId);
      if (booth) {
        openBoothSheet(booth);
      }
    });
  });

  // ãƒ–ãƒ¼ã‚¹ã‚·ãƒ¼ãƒˆã®é–‰ã˜ã‚‹å‹•ã
  if ($app.boothSheet.backdrop) {
    $app.boothSheet.backdrop.addEventListener('click', closeBoothSheet);
  }
  if ($app.boothSheet.closeBtn) {
    $app.boothSheet.closeBtn.addEventListener('click', closeBoothSheet);
  }

  // rippleã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  document.addEventListener('click', e => {
    const rippleTarget = e.target.closest('.ripple');
    if (!rippleTarget) return;
    const rect = rippleTarget.getBoundingClientRect();
    const ripple = document.createElement('span');
    const diameter = Math.max(rippleTarget.clientWidth, rippleTarget.clientHeight);
    const radius = diameter / 2;
    ripple.style.width = ripple.style.height = `${diameter}px`;
    ripple.style.left = `${e.clientX - rect.left - radius}px`;
    ripple.style.top = `${e.clientY - rect.top - radius}px`;
    ripple.classList.add('ripple-effect');
    rippleTarget.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  });

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰åŒ–ã§ãƒãƒƒãƒ—å†æç”»ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ä»˜ãï¼‰
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (state.activePage === 'map') {
        layoutBoothIcons();
      }
    }, 150);
  });

  // ã‚¹ã‚­ãƒ£ãƒŠç³»ã‚¤ãƒ™ãƒ³ãƒˆ
  if ($app.scan.openCard) {
    $app.scan.openCard.addEventListener('click', openFullscreenScanner);
  }
  if ($app.fullscreenScanner.closeBtn) {
    $app.fullscreenScanner.closeBtn.addEventListener('click', closeFullscreenScanner);
  }
  if ($app.fullscreenScanner.torchBtn) {
    $app.fullscreenScanner.torchBtn.addEventListener('click', toggleTorch);
  }
  if ($app.fullscreenScanner.switchBtn) {
    $app.fullscreenScanner.switchBtn.addEventListener('click', switchCamera);
  }

  // UUID QRãƒ¢ãƒ¼ãƒ€ãƒ«
  const uuidQrCloseBtn = document.getElementById('close-uuid-qr');
  if (uuidQrCloseBtn) {
    uuidQrCloseBtn.addEventListener('click', closeUuidQrModal);
  }

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
  if ($app.survey.closeBtn) {
    $app.survey.closeBtn.addEventListener('click', closeSurveyModal);
  }
  if ($app.survey.form) {
    $app.survey.form.addEventListener('submit', submitSurvey);
  }

  // Survey Action Button (ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­” / ç‰¹å…¸äº¤æ›)
  if ($app.surveyActionBtn) {
    $app.surveyActionBtn.addEventListener('click', () => {
      const isSurveyCompleted = state.surveyCompleted || (state.user && state.user.survey_completed);
      if (!isSurveyCompleted) {
        openSurveyModal();
      } else if (!state.user?.badge_claimed) {
        openBadgeExchangeModal();
      }
    });
  }

  // Badge Exchange Modal
  if ($app.badgeExchange.closeBtn) {
    $app.badgeExchange.closeBtn.addEventListener('click', closeBadgeExchangeModal);
  }

  // Close Just Claimed button
  const closeJustClaimedBtn = document.getElementById('close-just-claimed');
  if (closeJustClaimedBtn) {
    closeJustClaimedBtn.addEventListener('click', () => {
      closeBadgeExchangeModal();
      // Reset to exchange interface for next time
      document.getElementById('badge-just-claimed').classList.add('hidden');
      document.getElementById('badge-exchange-interface').classList.remove('hidden');
    });
  }

  // Badge claim button
  const claimBadgeBtn = document.getElementById('claim-badge-button');
  if (claimBadgeBtn) {
    claimBadgeBtn.addEventListener('click', claimBadge);
  }

  // First time warning close button
  const firstTimeWarningCloseBtn = document.getElementById('close-first-time-warning');
  if (firstTimeWarningCloseBtn) {
    firstTimeWarningCloseBtn.addEventListener('click', closeFirstTimeWarning);
  }

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®UIãƒã‚¤ãƒ©ã‚¤ãƒˆ
  setupSurveyInteractivity();

  // æœ€åˆã®æç”»
  await updatePercentile();
  renderAll();

  // Update survey action button based on survey and badge claim status
  updateSurveyActionButton();

    // ä¼æ¥­åã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´
    adjustBoothCompanyNameSizes();
  } catch (error) {
    console.error('init ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚åŸºæœ¬çš„ãªè¡¨ç¤ºã‚’è©¦ã¿ã‚‹
    try {
      renderAll();
    } catch (renderError) {
      console.error('renderAll ã§ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', renderError);
    }
  }
}
// DOMæ§‹ç¯‰å¾Œã«åˆæœŸåŒ–ã‚’1å›ã ã‘å‘¼ã¶
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
