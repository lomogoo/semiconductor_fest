<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ã¿ã‚„ãåŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- QRç”Ÿæˆç”¨ï¼ˆè»½é‡ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    :root {
      --bg-light: #f0f4f8;
      --accent-sky: #0ea5e9;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --bar-width-pct: 78%;
      --dot-size: 28px;
      --dot-border: 4px;
      --chip-size: 64px;
    }
    html { font-family: 'Inter', sans-serif; }
    body {
      background-color: var(--bg-light);
      background-image:
        radial-gradient(at 10% 20%, hsla(210, 80%, 95%, 0.7) 0px, transparent 50%),
        radial-gradient(at 80% 15%, hsla(200, 70%, 90%, 0.6) 0px, transparent 50%),
        radial-gradient(at 20% 90%, hsla(220, 75%, 92%, 0.5) 0px, transparent 50%),
        radial-gradient(at 90% 85%, hsla(190, 60%, 90%, 0.6) 0px, transparent 50%);
      background-attachment: fixed;
      color: var(--text-main);
      overscroll-behavior: none;
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    #app { flex: 1; display: flex; flex-direction: column; }
    main { flex: 1; overflow-y: auto; position: relative; }

    .page { display: none; width: 100%; position: relative; }
    .page.active { display: block; }

    .liquid-glass {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(32px) saturate(180%);
      -webkit-backdrop-filter: blur(32px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow:
        inset 0 2px 2px rgba(255, 255, 255, 0.8),
        0 16px 40px rgba(37, 37, 85, 0.12);
    }

    .floating-nav {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(32px) saturate(180%);
      -webkit-backdrop-filter: blur(32px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.32);
      box-shadow:
        inset 0 2px 2px rgba(255, 255, 255, 0.7),
        0 16px 40px rgba(37, 37, 85, 0.18);
      position: relative;
      border-radius: 1.5rem;
    }

    #nav-indicator {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      height: 75%;
      border-radius: 0.75rem;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.62), rgba(255,255,255,0.28)),
        linear-gradient(180deg, rgba(14,165,233,0.10), rgba(14,165,233,0.00));
      backdrop-filter: blur(28px) saturate(180%);
      -webkit-backdrop-filter: blur(28px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.48);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,0.85),
        inset 0 -10px 18px rgba(14,165,233,0.08),
        0 8px 24px rgba(14,165,233,0.28);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: -1;
    }
    #nav-indicator::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0) 40%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: .7;
    }

    .nav-btn { z-index: 1; }
    .nav-btn.active { color: #0c4a6e; }

    .chip {
      width: var(--chip-size);
      height: var(--chip-size);
      border-radius: 20px;
      border: 1.5px solid rgba(255,255,255,0.7);
      background: #fff;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.9), 0 8px 20px rgba(0, 150, 200, 0.15);
      overflow: hidden;
      transition: box-shadow .3s ease;
    }
    .chip.on { box-shadow: inset 0 1px 1px rgba(255,255,255,0.9), 0 0 24px rgba(52, 211, 153, .55); }
    .chip img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .chip-name { max-width: 88px; height: 2.4em; margin-top: 6px; font-size: 11px; line-height: 1.2; color: #0f172a; text-align: center; font-weight: 600; white-space: normal; display: flex; align-items: center; justify-content: center; }

    .bottom-sheet-backdrop { position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity .3s ease; pointer-events: none; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; transform: translateY(100%); transition: transform .4s cubic-bezier(0.4, 0, 0.2, 1); }
    .bottom-sheet.is-open { transform: translateY(0); }
    .bottom-sheet.is-open + .bottom-sheet-backdrop { opacity: 1; pointer-events: auto; }

    .ripple { position: relative; overflow: hidden; }
    .ripple-effect { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.7); transform: scale(0); animation: ripple-anim .6s linear; }
    @keyframes ripple-anim { to { transform: scale(4); opacity: 0; } }

    .list-item-anim { opacity: 0; transform: translateY(20px); animation: fade-in-up .5s ease-out forwards; }
    @keyframes fade-in-up { to { opacity: 1; transform: translateY(0); } }

    .progress-area { position: relative; padding-top: 7rem; margin-top: 1rem; overflow: visible; }
    #progress-wrapper { position: relative; margin: 0 auto; width: clamp(260px, var(--bar-width-pct), 560px); min-height: 44px; display: block; }

    .reward-bubble { position: absolute; bottom: 64px; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; width: 90px; pointer-events: none; }
    #reward-bubble-4 { left: 50%; }
    #reward-bubble-8 { left: 100%; transform: translateX(-50%); }

    .reward-bubble-content { width: 100%; min-height: 50px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; position: relative; margin-top: 6px; }

    .progress-track { position: relative; width: 100%; height: 12px; background-color: #e0e7ff; border-radius: 9999px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08); overflow: visible; }
    #progress-bar { height: 100%; border-radius: 9999px; background: linear-gradient(90deg, #34d399, #10b981, var(--accent-sky), #3b82f6); transition: width .5s ease-in-out; }

    .marker-dot { position: absolute; top: 50%; width: var(--dot-size); height: var(--dot-size); background: #fff; border: var(--dot-border) solid #cbd5e1; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 4px rgba(0,0,0,.08); z-index: 12; display: grid; place-items: center; }
    .marker-dot .label { font-size: 14px; font-weight: 800; color: #334155; user-select: none; line-height: 1; }
    .marker-dot.is-active { border-color: #3b82f6; background: #3b82f6; box-shadow: 0 0 14px rgba(59,130,246,.6), 0 2px 8px rgba(0,0,0,.15); }
    .marker-dot.is-active .label { color: #fff; }

    #progress-dot { position: absolute; top: 50%; left: 0%; width: var(--dot-size); height: var(--dot-size); background-color: white; border: var(--dot-border) solid #3b82f6; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 14px rgba(59, 130, 246, 0.55), 0 2px 8px rgba(0,0,0,.12); transition: left 0.5s ease-in-out; z-index: 20; outline: 3px solid #fff; }

    .map-wrap { aspect-ratio:2/3; margin-top: 0; }

    .scanner-video { width: 100%; height: auto; border-radius: 1rem; background: #000; }
    .scan-guide { position: absolute; inset: 0; pointer-events: none; }
    .scan-corner { position: absolute; width: 24px; height: 24px; border: 3px solid rgba(255,255,255,.9); }
    .scan-corner.tl { top: 12%; left: 10%; border-right: none; border-bottom: none; }
    .scan-corner.tr { top: 12%; right: 10%; border-left: none; border-bottom: none; }
    .scan-corner.bl { bottom: 12%; left: 10%; border-right: none; border-top: none; }
    .scan-corner.br { bottom: 12%; right: 10%; border-left: none; border-top: none; }

    .toast { position: fixed; left: 50%; bottom: 88px; transform: translateX(-50%); z-index: 60; }

    .auth-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.55); backdrop-filter: blur(6px); z-index: 80; display:none; }
    .auth-backdrop.show { display:block; }
    .auth-modal { position: fixed; inset: 0; z-index: 90; display:none; align-items: center; justify-content: center; }
    .auth-modal.show { display:flex; }

    .fullscreen-scanner {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: #000;
      display: none;
      flex-direction: column;
    }
    .fullscreen-scanner.active {
      display: flex;
    }
    .fullscreen-scanner video {
      flex: 1;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .fullscreen-scanner-controls {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 101;
    }
  </style>
</head>
<body>
  <!-- Auth: Backdrop and Launch Panel -->
  <div id="auth-backdrop" class="auth-backdrop"></div>
  <div id="auth-launch" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 p-6 w-[min(92vw,480px)]">
      <h2 class="text-xl font-semibold text-slate-800">ã”åˆ©ç”¨å‰ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³/ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <p class="text-sm text-slate-600 mt-1">å½“æ—¥å—ä»˜ã®æ–¹ã¯ã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã§æ°åãƒ»å­¦æ ¡åãƒ»å­¦éƒ¨/å­¦ç§‘ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚äº‹å‰ç”³è¾¼æ¸ˆã¿ã®æ–¹ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã¸ã€‚</p>
      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="open-signin" class="px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">å½“æ—¥å—ä»˜ã®æ–¹</button>
        <button id="open-login" class="px-4 py-3 rounded-2xl bg-slate-200 text-slate-800 font-semibold ripple">äº‹å‰ç”³è¾¼æ¸ˆã¿ã®æ–¹</button>
      </div>
    </div>
  </div>

  <!-- Signin Modal -->
  <div id="signin-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,560px)]">
      <div class="p-5 border-b border-white/50 flex items-center justify-between">
        <button data-back="signin" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300 flex items-center gap-1">
          <span>â†</span>
          <span>æˆ»ã‚‹</span>
        </button>
        <h3 class="text-lg font-semibold text-slate-800">å½“æ—¥å—ä»˜ã®æ–¹</h3>
        <div class="w-16"></div>
      </div>
      
      <form id="signin-form" class="p-5 space-y-4">
        <div>
          <label class="text-sm text-slate-700">æ°å</label>
          <input id="si-name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ä¾‹:æ±åŒ— å¤ªéƒ" />
        </div>
        <div>
          <label class="text-sm text-slate-700">å­¦æ ¡å</label>
          <input id="si-school" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ä¾‹:æ±åŒ—å¤§å­¦" />
        </div>
        <div>
          <label class="text-sm text-slate-700">å­¦éƒ¨ãƒ»å­¦ç§‘</label>
          <input id="si-dept" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ä¾‹:å·¥å­¦éƒ¨ é›»æ°—æƒ…å ±ç‰©ç†å·¥å­¦ç§‘" />
        </div>
        <button id="signin-submit" type="submit" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">ç™»éŒ²</button>
        <p id="signin-error" class="text-sm text-red-600"></p>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,560px)]">
      <div class="p-5 border-b border-white/50 flex items-center justify-between">
        <button data-back="login" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300 flex items-center gap-1">
          <span>â†</span>
          <span>æˆ»ã‚‹</span>
        </button>
        <h3 class="text-lg font-semibold text-slate-800">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç™»éŒ²æ¸ˆã¿ï¼‰</h3>
        <div class="w-16"></div>
      </div>
      <form id="login-form" class="p-5 space-y-4">
        <div>
          <label class="text-sm text-slate-700">æ°å</label>
          <input id="li-name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ç™»éŒ²ã—ãŸæ°å" />
        </div>
        <div>
          <label class="text-sm text-slate-700">å­¦æ ¡å</label>
          <input id="li-school" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ç™»éŒ²ã—ãŸå­¦æ ¡å" />
        </div>
        <button id="login-submit" type="submit" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">å…¥å ´</button>
        <p class="text-xs text-slate-500">â€»äº‹å‰ã«Googleãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ãŸå†…å®¹ã§ãŠç­”ãˆãã ã•ã„ã€‚</p>
        <p id="login-error" class="text-sm text-red-600"></p>
      </form>
    </div>
  </div>

  <!-- User QR Modal -->
  <div id="qr-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,420px)]">
      <div class="p-4 border-b border-white/50 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">ã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰</h3>
        <button id="close-qr" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
      </div>
      <div class="p-5 flex flex-col items-center gap-3">
        <div id="qr-box" class="bg-white rounded-2xl p-3 border border-slate-200 shadow-sm"></div>
        <div id="qr-uuid" class="text-[10px] text-slate-500 break-all font-mono"></div>
        <div class="flex gap-2">
          <a id="download-qr" class="px-3 py-1.5 text-xs rounded-xl bg-sky-600 text-white border border-sky-600">ç”»åƒã‚’ä¿å­˜</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Scanner -->
  <div id="fullscreen-scanner" class="fullscreen-scanner">
    <div class="fullscreen-scanner-controls">
      <button id="fullscreen-close" class="px-4 py-2 rounded-xl bg-red-500 text-white font-semibold">âœ• é–‰ã˜ã‚‹</button>
      <div class="flex gap-2">
        <button id="fullscreen-torch" class="px-3 py-2 rounded-xl bg-white/20 text-white border border-white/40">ğŸ’¡</button>
        <button id="fullscreen-switch" class="px-3 py-2 rounded-xl bg-white/20 text-white border border-white/40">ğŸ”„</button>
      </div>
    </div>
    <video id="fullscreen-video" autoplay playsinline muted></video>
    <div class="scan-guide">
      <div class="scan-corner tl"></div>
      <div class="scan-corner tr"></div>
      <div class="scan-corner bl"></div>
      <div class="scan-corner br"></div>
    </div>
    <div style="position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); color: white; text-align: center; background: rgba(0,0,0,0.6); padding: 0.5rem 1rem; border-radius: 1rem;">
      <span id="fullscreen-status">QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å†™ã—ã¦ãã ã•ã„</span>
    </div>
  </div>

  <div id="app" class="opacity-0 pointer-events-none select-none">
    <header id="header" class="sticky top-0 z-30 liquid-glass transition-transform duration-300 rounded-b-3xl">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
        <svg class="w-10 h-10 shadow-lg" viewBox="0 0 64 64" aria-label="Semiconductor" role="img">
          <defs>
            <linearGradient id="waferGrad" x1="0" x2="1">
              <stop offset="0" stop-color="#a5f3fc"/>
              <stop offset="1" stop-color="#60a5fa"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="28" fill="url(#waferGrad)" stroke="rgba(255,255,255,0.6)" stroke-width="2"/>
          <g stroke="rgba(255,255,255,0.6)" stroke-width="1">
            <path d="M8 20 H56M8 32 H56M8 44 H56"/>
            <path d="M20 8 V56M32 8 V56M44 8 V56"/>
          </g>
          <path d="M58 30 A28 28 0 0 1 58 34" stroke="#0ea5e9" stroke-width="3" fill="none"/>
        </svg>
        <div>
          <h1 id="header-title" class="text-lg font-semibold text-sky-800">ãƒ›ãƒ¼ãƒ </h1>
          <p class="text-xs text-sky-700">ã¿ã‚„ãåŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹</p>
        </div>
        <div id="user-pill" class="ml-auto text-xs text-slate-700 hidden"></div>
      </div>
    </header>

    <main class="flex-1 pb-28">
      <div id="page-home" class="page active p-4 space-y-6">
        <div class="liquid-glass rounded-3xl p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-sky-800">ã‚¹ã‚¿ãƒ³ãƒ—é€²æ—</h3>
            <span id="progress-badge" class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-700 border border-sky-200 font-mono">0/8</span>
          </div>
          <div class="progress-area">
            <div id="progress-wrapper">
              <div id="reward-bubble-4" class="reward-bubble">
                <div class="reward-bubble-content liquid-glass border-slate-300">ğŸ’</div>
              </div>
              <div id="reward-bubble-8" class="reward-bubble">
                <div class="reward-bubble-content liquid-glass border-amber-300">ğŸ‘‘</div>
              </div>
              <div id="progress-track" class="progress-track">
                <div id="progress-bar" style="width:0%"></div>
                <div id="marker-4" class="marker-dot" style="left:50%"><span class="label">4</span></div>
                <div id="marker-8" class="marker-dot" style="left:100%"><span class="label">8</span></div>
                <div id="progress-dot"></div>
              </div>
            </div>
          </div>
          <p id="progress-msg" class="mt-4 text-sm text-center text-slate-600">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã‚ˆã†ã€‚</p>
        </div>
        <div class="liquid-glass rounded-3xl p-4">
          <div class="grid grid-cols-4 gap-y-4" id="stamp-grid"></div>
        </div>
      </div>

<div id="page-map" class="page p-3 pt-2 space-y-1">
  <!-- ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒœã‚¿ãƒ³ -->
  <div class="max-w-[1200px] mx-auto">
    <button id="scan-card" class="w-full liquid-glass rounded-2xl px-4 py-3 flex items-center justify-between border border-white/50 ripple">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-sky-500 text-white grid place-items-center text-2xl">ğŸ“·</div>
        <div class="text-left">
          <div class="font-semibold text-slate-800">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</div>
          <div class="text-xs text-slate-600">QRã‚’èª­ã¿å–ã£ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’GET</div>
        </div>
      </div>
      <div class="text-sky-700 text-sm font-medium">ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹</div>
    </button>
  </div>
  
  <!-- ãƒãƒƒãƒ— -->
  <div class="map-wrap w-full max-w-[1200px] mx-auto">
    <svg id="svg-map" viewBox="0 0 1200 1800" preserveAspectRatio="xMidYMid meet" class="w-full h-auto">
      <image id="bg-image" href="background.png" x="0" y="0" width="1200" height="1800" />
      <g id="booth-icons" font-size="140" text-anchor="middle" dominant-baseline="middle" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));"></g>
    </svg>
  </div>
</div>

      <div id="page-list" class="page p-2">
        <ul id="booth-list" class="space-y-2"></ul>
      </div>
    </main>

    <!-- ãƒ–ãƒ¼ã‚¹è©³ç´°ã‚·ãƒ¼ãƒˆ -->
    <div id="booth-sheet" class="bottom-sheet">
      <div class="liquid-glass rounded-t-3xl max-h-[85dvh] overflow-y-auto">
        <div class="p-4 border-b border-white/50 flex items-start gap-3">
          <div id="booth-sheet-icon" class="w-12 h-12 rounded-lg overflow-hidden bg-white flex-shrink-0"></div>
          <div class="min-w-0 flex-1">
            <h4 id="booth-sheet-title" class="font-semibold text-lg text-slate-800 leading-tight"></h4>
            <div id="booth-sheet-tags" class="mt-2 flex flex-wrap gap-2"></div>
          </div>
          <button id="get-stamp-btn" data-id="" class="px-4 py-2 text-sm rounded-2xl bg-sky-500 text-white ripple shadow-md">ã‚¹ã‚¿ãƒ³ãƒ—GET</button>
        </div>
        <div class="p-4 space-y-4 text-sm">
          <p id="booth-sheet-desc" class="text-slate-700 leading-6"></p>
          <div class="text-slate-600 space-y-2">
            <div><strong class="font-medium text-slate-800">ã‚¹ã‚¿ãƒ³ãƒ—æ¡ä»¶ï¼š</strong><span id="booth-sheet-condition">-</span></div>
            <div><strong class="font-medium text-slate-800">ãƒãƒ™ãƒ«ãƒ†ã‚£ï¼š</strong><span id="booth-sheet-giveaway">-</span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="bottom-sheet-backdrop" data-target="booth"></div>

    <div id="toast" class="toast hidden">
      <div class="px-4 py-2 rounded-2xl bg-sky-600 text-white shadow-lg"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 z-40 p-3">
      <nav class="h-16 grid grid-cols-3 items-center floating-nav rounded-3xl">
        <div id="nav-indicator"></div>
        <button data-page="home" class="nav-btn active flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ </div><span class="text-xs font-medium">ãƒ›ãƒ¼ãƒ </span></button>
        <button data-page="map" class="nav-btn flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ—ºï¸</div><span class="text-xs font-medium">ãƒãƒƒãƒ—</span>
</button>
        <button data-page="list" class="nav-btn flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ“„</div><span class="text-xs font-medium">ä¸€è¦§</span></button>
      </nav>
    </div>
  </div>

<script>
/******************* Supabase æ¥ç¶šè¨­å®š *******************/
const SUPABASE_URL = "https://fsaeuowdijoeqhnrqazx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzYWV1b3dkaWpvZXFobnJxYXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjA0MjYsImV4cCI6MjA3NTQ5NjQyNn0.xgIQ9jf3qa4oy6Dbc8mVaP8woRDWBwMxLAJwiCGEWmk";

const IS_SUPABASE_CONFIGURED =
  typeof SUPABASE_URL === "string" && SUPABASE_URL.trim() !== "" &&
  typeof SUPABASE_ANON_KEY === "string" && SUPABASE_ANON_KEY.trim() !== "";
  
let supabase = null;
if (IS_SUPABASE_CONFIGURED) {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: false }
  });
} else {
  console.warn('Supabase ã®URL/Anonã‚­ãƒ¼ãŒæœªè¨­å®šã®ãŸã‚ã€èªè¨¼æ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚');
}

function getSupabaseClientOrThrow() {
  if (!IS_SUPABASE_CONFIGURED || !supabase) {
    const err = new Error('Supabase credentials are not configured.');
    err.code = 'SUPABASE_NOT_CONFIGURED';
    throw err;
  }
  return supabase;
}

/******************* DATA & STATE *******************/
const IMG_DEFAULT = 'logo.jpg';
const BOOTH_ANCHORS = {
  A: { x: 0.20, y: 0.30 }, B: { x: 0.80, y: 0.30 }, C: { x: 0.30, y: 0.38 },
  D: { x: 0.70, y: 0.38 }, E: { x: 0.27, y: 0.51 }, F: { x: 0.73, y: 0.51 },
  G: { x: 0.27, y: 0.65 }, H: { x: 0.73, y: 0.65 }
};

const BOOTH_DATA = [
  { id: 'A', name: 'æ ªå¼ä¼šç¤¾ãƒ¬ã‚¹ã‚¿ãƒ¼', img: IMG_DEFAULT, icon: 'âš¡', desc: 'æœ€å…ˆç«¯ã®ãƒ—ãƒ©ã‚ºãƒã‚¨ãƒƒãƒãƒ³ã‚°è£…ç½®ã‚’å±•ç¤ºã€‚å¾®ç´°åŠ å·¥æŠ€è¡“ã®æœ€å‰ç·šã‚’ã”è¦§ãã ã•ã„ã€‚', tags:['ã‚¨ãƒƒãƒãƒ³ã‚°', 'è£½é€ è£…ç½®', 'ãƒ—ãƒ©ã‚ºãƒ'], giveaway:'TELã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¦ã‚¨ãƒãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ—', condition:'ã‚¨ãƒƒãƒãƒ³ã‚°å·¥ç¨‹ã«é–¢ã™ã‚‹ã‚¯ã‚¤ã‚ºã«æ­£è§£' },
  { id: 'B', name: 'ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹æ ªå¼ä¼šç¤¾', img: IMG_DEFAULT, icon: 'ğŸ–¼ï¸', desc: 'åŠå°ä½“å›è·¯ã®åŸç‰ˆã€Œãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯ã€ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãã€‚EUVãƒã‚¹ã‚¯ã®æœ€æ–°æŠ€è¡“ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚', tags:['ãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯', 'EUV', 'ãƒªã‚½ã‚°ãƒ©ãƒ•ã‚£'], giveaway:'ãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³å®šè¦', condition:'ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒã‚¹ã‚¯ã®é‡ã­åˆã‚ã›ä½“é¨“' },
  { id: 'C', name: 'ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°æ ªå¼ä¼šç¤¾', img: IMG_DEFAULT, icon: 'ğŸ’¡', desc: 'è¶…ä½æ¶ˆè²»é›»åŠ›MCUã¨ã‚«ã‚¹ã‚¿ãƒ LSIã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã€‚èº«è¿‘ãªIoTãƒ‡ãƒã‚¤ã‚¹ã‚’å‹•ã‹ã™æŠ€è¡“ã‚’è§£èª¬ã—ã¾ã™ã€‚', tags:['LSI', 'MCU', 'IoT'], giveaway:'ã‚ªãƒªã‚¸ãƒŠãƒ«ICãƒãƒƒãƒ—ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼', condition:'IoTãƒ‡ãƒã‚¤ã‚¹ã®ãƒ‡ãƒ¢ã‚’ä½“é¨“' },
  { id: 'D', name: 'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸæ ªå¼ä¼šç¤¾', img: IMG_DEFAULT, icon: 'ğŸ”¥', desc: 'è£½é€ è£…ç½®ã‚’æ”¯ãˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ³ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹éƒ¨å“ã€‚é™é›»ãƒãƒ£ãƒƒã‚¯ã‚„ãƒ’ãƒ¼ã‚¿ãƒ¼ã®å®Ÿç‰©ã‚’å±•ç¤ºã€‚', tags:['ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹', 'è£…ç½®éƒ¨å“', 'é™é›»ãƒãƒ£ãƒƒã‚¯'], giveaway:'ã‚»ãƒ©ãƒŸãƒƒã‚¯è£½ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼', condition:'ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹ã®ç†±ä¼å°å®Ÿé¨“ã«å‚åŠ ' },
  { id: 'E', name: 'TOPPANæ ªå¼ä¼šç¤¾', img: IMG_DEFAULT, icon: 'ğŸº', desc: 'é«˜ç´”åº¦ãƒ»é«˜ç²¾åº¦ãªã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹è£½å“ã€‚åŠå°ä½“ã®å“è³ªã¯ã€ç§ãŸã¡ã®ç´ ææŠ€è¡“ã‹ã‚‰ç”Ÿã¾ã‚Œã¾ã™ã€‚', tags:['ææ–™', 'ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹', 'é«˜ç´”åº¦'], giveaway:'ãƒŸãƒ‹ãƒãƒ¥ã‚¢ã‚»ãƒ©ãƒŸãƒƒã‚¯ãƒ—ãƒ¬ãƒ¼ãƒˆ', condition:'è£½å“ã‚µãƒ³ãƒ—ãƒ«ã«è§¦ã‚Œã¦ã¿ã‚‹' },
  { id: 'F', name: 'ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿æ ªå¼ä¼šç¤¾', img: IMG_DEFAULT, icon: 'ğŸŒ¡ï¸', desc: 'æˆè†œãƒ—ãƒ­ã‚»ã‚¹ã‚’ç²¾å¯†ã«åˆ¶å¾¡ã™ã‚‹æ°´æ™¶æŒ¯å‹•å­å¼è†œåšè¨ˆã‚„å„ç¨®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’å±•ç¤ºã€‚', tags:['è¨ˆæ¸¬', 'æˆè†œ', 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼'], giveaway:'æ¶²æ™¶æ¸©åº¦è¨ˆã‚«ãƒ¼ãƒ‰', condition:'è†œåšè¨ˆã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹å­¦' },
];

const state = { stamps: new Set(), activePage: 'home', prevCount: 0, user: null };

const QR_WHITELIST = {
  'handoutai_a': 'A', 'handoutai_b': 'B', 'handoutai_c': 'C', 'handoutai_d': 'D',
  'handoutai_e': 'E', 'handoutai_f': 'F', 'handoutai_g': 'G', 'handoutai_h': 'H'
};

/******************* DOM ELEMENTS *******************/
const $app = {
  header: document.getElementById('header'),
  headerTitle: document.getElementById('header-title'),
  userPill: document.getElementById('user-pill'),
  pages: document.querySelectorAll('.page'),
  nav: document.querySelector('.floating-nav'),
  navIndicator: document.getElementById('nav-indicator'),
  navButtons: document.querySelectorAll('.nav-btn'),
  stampGrid: document.getElementById('stamp-grid'),
  boothList: document.getElementById('booth-list'),
  progress: {
    badge: document.getElementById('progress-badge'),
    bar: document.getElementById('progress-bar'),
    wrapper: document.getElementById('progress-wrapper'),
    msg: document.getElementById('progress-msg'),
    bubble4: document.getElementById('reward-bubble-4'),
    bubble8: document.getElementById('reward-bubble-8'),
    dot: document.getElementById('progress-dot'),
    marker4: document.getElementById('marker-4'),
    marker8: document.getElementById('marker-8'),
  },
  map: {
    svg: document.getElementById('svg-map'),
    bg: document.getElementById('bg-image'),
    iconsGroup: document.getElementById('booth-icons')
  },
  sheet: {
    el: document.getElementById('booth-sheet'),
    backdrop: document.querySelector('.bottom-sheet-backdrop[data-target="booth"]'),
    icon: document.getElementById('booth-sheet-icon'),
    title: document.getElementById('booth-sheet-title'),
    tags: document.getElementById('booth-sheet-tags'),
    desc: document.getElementById('booth-sheet-desc'),
    condition: document.getElementById('booth-sheet-condition'),
    giveaway: document.getElementById('booth-sheet-giveaway'),
    getStampBtn: document.getElementById('get-stamp-btn'),
  },
  scan: {
    openCard: document.getElementById('scan-card'),
  },
  fullscreenScanner: {
    container: document.getElementById('fullscreen-scanner'),
    video: document.getElementById('fullscreen-video'),
    status: document.getElementById('fullscreen-status'),
    closeBtn: document.getElementById('fullscreen-close'),
    torchBtn: document.getElementById('fullscreen-torch'),
    switchBtn: document.getElementById('fullscreen-switch'),
  },
  auth: {
    backdrop: document.getElementById('auth-backdrop'),
    launch: document.getElementById('auth-launch'),
    signin: document.getElementById('signin-modal'),
    login: document.getElementById('login-modal'),
    openSignin: document.getElementById('open-signin'),
    openLogin: document.getElementById('open-login'),
    signinForm: document.getElementById('signin-form'),
    loginForm: document.getElementById('login-form'),
    siName: document.getElementById('si-name'),
    siSchool: document.getElementById('si-school'),
    siDept: document.getElementById('si-dept'),
    liName: document.getElementById('li-name'),
    liSchool: document.getElementById('li-school'),
    signinError: document.getElementById('signin-error'),
    loginError: document.getElementById('login-error'),
  },
  toast: document.getElementById('toast'),
  qr: {
    modal: document.getElementById('qr-modal'),
    box: document.getElementById('qr-box'),
    uuid: document.getElementById('qr-uuid'),
    dl: document.getElementById('download-qr'),
    closeBtn: document.getElementById('close-qr')
  }
};

/******************* Auth UI Helpers *******************/
function showAuthGate() {
  $app.auth.backdrop.classList.add('show');
  $app.auth.launch.classList.add('show');
  const root = document.getElementById('app');
  root.classList.add('opacity-0', 'pointer-events-none', 'select-none');
}

function hideAuthGate() {
  $app.auth.backdrop.classList.remove('show');
  $app.auth.launch.classList.remove('show');
}

function openAuthModal(kind) {
  hideAuthGate();
  $app.auth.backdrop.classList.add('show');
  const target = kind === 'signin' ? $app.auth.signin : $app.auth.login;
  target.classList.add('show');
}

function closeAuthModal(kind) {
  const target = kind === 'signin' ? $app.auth.signin : $app.auth.login;
  target.classList.remove('show');
  // ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã‘ã‚Œã°backdropã‚’é–‰ã˜ã‚‹
  if (!$app.auth.signin.classList.contains('show') && 
      !$app.auth.login.classList.contains('show') &&
      !$app.qr.modal.classList.contains('show')) {
    $app.auth.backdrop.classList.remove('show');
  }
}

function backToAuthGate(kind) {
  closeAuthModal(kind);
  showAuthGate();
}
  
function enableAppUI(user) {
  const root = document.getElementById('app');
  root.classList.remove('opacity-0', 'pointer-events-none', 'select-none');
  $app.userPill.classList.remove('hidden');
  $app.userPill.classList.add('cursor-pointer');
  $app.userPill.innerHTML =
    `<button class="px-2 py-1 rounded-xl bg-sky-100 border border-sky-200 hover:bg-sky-200 transition">
       ${user.name}ï¼ˆ${user.school}ï¼‰
     </button>`;
  
  // Authå®Œäº†å¾Œã«åˆæœŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®Ÿè¡Œ
  setTimeout(() => {
    layoutBoothIcons();
    syncBubbleHeights();
  }, 100);
}

function openQrModal() {
  if (!state.user?.id) { showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  $app.auth.backdrop.classList.add('show');
  $app.qr.modal.classList.add('show');
  renderUserQr(state.user.id);
}

function closeQrModal() {
  $app.qr.modal.classList.remove('show');
  // ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã‘ã‚Œã°backdropã‚’é–‰ã˜ã‚‹
  if (!$app.auth.signin.classList.contains('show') &&
      !$app.auth.login.classList.contains('show')) {
    $app.auth.backdrop.classList.remove('show');
  }
}

function renderUserQr(uuid) {
  $app.qr.box.innerHTML = '';
  $app.qr.uuid.textContent = uuid;

  try {
    // QRCodeJSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
    new QRCode($app.qr.box, {
      text: uuid,
      width: 260,
      height: 260,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®è¨­å®šï¼ˆç”Ÿæˆå¾Œã«å°‘ã—å¾…ã¤ï¼‰
    setTimeout(() => {
      const canvas = $app.qr.box.querySelector('canvas');
      if (canvas) {
        try {
          const dataUrl = canvas.toDataURL('image/png');
          $app.qr.dl.setAttribute('href', dataUrl);
          $app.qr.dl.setAttribute('download', `user-qr-${uuid}.png`);
        } catch (e) {
          console.warn('toDataURL failed', e);
        }
      }
    }, 100);
  } catch (err) {
    console.error(err);
    showToast('QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/******************* Auth Storage *******************/
const LS_KEY_USER = 'app_user';
function saveLocalUser(u){ localStorage.setItem(LS_KEY_USER, JSON.stringify(u)); }
function loadLocalUser(){ try { return JSON.parse(localStorage.getItem(LS_KEY_USER)||'null'); } catch { return null; } }
function clearLocalUser(){ localStorage.removeItem(LS_KEY_USER); }

/******************* Supabase Accessors *******************/
/******************* Supabase Accessors *******************/
// ç½®ãæ›ãˆï¼šå½“æ—¥å—ä»˜ï¼ˆã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼‰â†’ on_site ã§INSERT
async function sbInsertUser({name, school, department}) {
  const client = getSupabaseClientOrThrow();
  const { data, error } = await client
    .from('app_users')
    .insert({
      name,
      school,
      department,
      registration_type: 'on_site'   // â†ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ
    })
    .select()
    .single();
  if (error) throw error;
  return data;
}

// æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³ã¯ãã®ã¾ã¾ã§OKï¼ˆäº‹å‰ç”³è¾¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼‰
async function sbFindUserByNameAndSchool({name, school}) {
  const client = getSupabaseClientOrThrow();
  const { data, error } = await client
    .rpc('login_user', { p_name: name, p_school: school });
  if (error) throw error;
  return data;
}
/******************* RENDER FUNCTIONS *******************/
function renderAll() {
  renderStampGrid();
  renderProgress();
  updateActivePage();
  layoutBoothIcons();
}

function renderStampGrid() {
  $app.stampGrid.innerHTML = '';
  BOOTH_DATA.forEach(b => {
    const on = state.stamps.has(b.id);
    const cell = document.createElement('div');
    cell.className = 'flex flex-col items-center';
    cell.innerHTML = `
      <div class="chip ${on ? 'on' : ''}" data-id="${b.id}">
        <img src="${b.img}" alt="${b.name}">
      </div>
      <div class="chip-name" title="${b.name}">${b.name}</div>`;
    cell.addEventListener('click', () => { openBoothSheet(b); });
    $app.stampGrid.appendChild(cell);
  });
}

function renderBoothList() {
  $app.boothList.innerHTML = '';
  BOOTH_DATA.forEach((b, i) => {
    const li = document.createElement('li');
    li.className = 'liquid-glass rounded-2xl flex items-center gap-3 p-3 ripple list-item-anim';
    li.style.animationDelay = `${i * 50}ms`;
    li.innerHTML = `
      <div class="w-12 h-12 rounded-lg overflow-hidden bg-white flex-shrink-0">
        <img src="${b.img}" alt="${b.name}" class="w-full h-full object-cover" />
      </div>
      <div class="min-w-0 flex-1">
        <div class="font-semibold text-slate-800">${b.name}</div>
        <div class="text-xs text-slate-500 truncate">${b.desc}</div>
      </div>
      <div class="text-2xl text-slate-300">${state.stamps.has(b.id) ? 'âœ…' : 'âšªï¸'}</div>`;
    li.addEventListener('click', () => openBoothSheet(b));
    $app.boothList.appendChild(li);
  });
}

function renderProgress() {
  const n = state.stamps.size;
  const total = BOOTH_DATA.length;
  const progressPercent = (n / total) * 100;

  $app.progress.badge.textContent = `${n}/${total}`;
  $app.progress.bar.style.width = `${progressPercent}%`;
  $app.progress.dot.style.left = `${progressPercent}%`;

  $app.progress.bubble4.classList.toggle('is-achieved', n >= 4);
  $app.progress.bubble8.classList.toggle('is-achieved', n >= 8);
  
  if (n === total) {
    $app.progress.msg.textContent = 'ğŸ‰ å…¨ã¦ã®ç‰¹å…¸ã‚’ã‚²ãƒƒãƒˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼';
  } else if (n >= 4) {
    $app.progress.msg.textContent = `ğŸ’ ç‰¹å…¸ã‚²ãƒƒãƒˆï¼æ¬¡ã®ç‰¹å…¸ã¾ã§ã‚ã¨${total - n}å€‹ï¼`;
  } else {
    $app.progress.msg.textContent = `ã‚ã¨${Math.max(0, 4 - n)}å€‹ã§æœ€åˆã®ç‰¹å…¸ã‚’ã‚²ãƒƒãƒˆï¼`;
  }

  const onMilestone = (n === 4 || n === 8);
  $app.progress.dot.style.display = onMilestone ? 'none' : 'block';
  $app.progress.marker4.classList.toggle('is-active', n >= 4);
  $app.progress.marker8.classList.toggle('is-active', n >= 8);

  state.prevCount = n;
  syncBubbleHeights();
}

function updateActivePage() {
  $app.pages.forEach(p => {
    const isActive = p.id === `page-${state.activePage}`;
    p.classList.toggle('active', isActive);
    p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
    p.style.visibility = isActive ? 'visible' : 'hidden';
  });

  let activeBtn = null;
  $app.navButtons.forEach(btn => {
    const isActive = btn.dataset.page === state.activePage;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-current', isActive ? 'page' : 'false');
    if (isActive) activeBtn = btn;
  });
  
  if (activeBtn) {
    const btnW = activeBtn.offsetWidth;
    const indW = Math.max(56, Math.round(btnW * 0.66));
    const left = activeBtn.offsetLeft + (btnW - indW) / 2;
    $app.navIndicator.style.width = `${indW}px`;
    $app.navIndicator.style.transform = `translate(${left}px, -50%)`;
  }
  
  const pageTitles = { home: 'ãƒ›ãƒ¼ãƒ ', map: 'ãƒãƒƒãƒ—', list: 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„' };
  $app.headerTitle.textContent = pageTitles[state.activePage];

  if (state.activePage === 'list') { renderBoothList(); }

  const isMap = state.activePage === 'map';
  $app.map.iconsGroup?.setAttribute('pointer-events', isMap ? 'auto' : 'none');
  if ($app.map.svg) $app.map.svg.style.display = isMap ? '' : 'none';
}

function openBoothSheet(booth) {
  $app.sheet.icon.innerHTML = `<img src="${booth.img}" alt="${booth.name}" class="w-full h-full object-cover" />`;
  $app.sheet.title.textContent = booth.name;
  $app.sheet.desc.textContent = booth.desc;
  $app.sheet.condition.textContent = booth.condition;
  $app.sheet.giveaway.textContent = booth.giveaway;
  $app.sheet.getStampBtn.dataset.id = booth.id;
  
  const hasStamp = state.stamps.has(booth.id);
  $app.sheet.getStampBtn.textContent = hasStamp ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : 'ã‚¹ã‚¿ãƒ³ãƒ—GET';
  $app.sheet.getStampBtn.classList.toggle('bg-red-500', hasStamp);
  $app.sheet.getStampBtn.classList.toggle('bg-sky-500', !hasStamp);
  
  $app.sheet.tags.innerHTML = '';
  booth.tags.forEach(t => {
    const span = document.createElement('span');
    span.className = 'px-2 py-0.5 rounded-full bg-sky-100 text-sky-700 border border-sky-200 text-xs';
    span.textContent = t;
    $app.sheet.tags.appendChild(span);
  });
  
  $app.sheet.el.classList.add('is-open');
  $app.sheet.backdrop.classList.add('is-open');
}

function closeBoothSheet() {
  $app.sheet.el.classList.remove('is-open');
  $app.sheet.backdrop.classList.remove('is-open');
}

function toggleStamp(id) {
  state.stamps.has(id) ? state.stamps.delete(id) : state.stamps.add(id);
  renderAll();
}

function grantStampByBoothId(boothId) {
  if (!boothId) return false;
  const booth = BOOTH_DATA.find(b => b.id === boothId);
  if (!booth) return false;
  const firstTime = !state.stamps.has(boothId);
  state.stamps.add(boothId);
  renderAll();
  showToast(firstTime ? `âœ… ã€Œ${booth.name}ã€ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç²å¾—ï¼` : `â„¹ï¸ ã€Œ${booth.name}ã€ã¯å–å¾—æ¸ˆã¿ã§ã™`);
  return true;
}

/******************* QR Scanner (Fullscreen) *******************/
let scanStream = null;
let useBackCamera = true;
let trackWithTorch = null;
let scanning = false;
let barcodeDetector = ('BarcodeDetector' in window) ? new BarcodeDetector({ formats: ['qr_code'] }) : null;

async function openFullscreenScanner() {
  $app.fullscreenScanner.container.classList.add('active');
  await startCamera();
}

function closeFullscreenScanner() {
  stopCamera();
  $app.fullscreenScanner.container.classList.remove('active');
}

async function startCamera() {
  try {
    $app.fullscreenScanner.status.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦';
    const constraints = {
      audio: false,
      video: {
        facingMode: useBackCamera ? { ideal: 'environment' } : 'user',
        width: { ideal: 1280 }, height: { ideal: 720 }
      }
    };
    scanStream = await navigator.mediaDevices.getUserMedia(constraints);
    $app.fullscreenScanner.video.srcObject = scanStream;
    await $app.fullscreenScanner.video.play();

    trackWithTorch = null;
    const [track] = scanStream.getVideoTracks();
    const caps = track.getCapabilities?.();
    if (caps && 'torch' in caps) {
      trackWithTorch = track;
      $app.fullscreenScanner.torchBtn.classList.remove('opacity-50', 'pointer-events-none');
    } else {
      $app.fullscreenScanner.torchBtn.classList.add('opacity-50', 'pointer-events-none');
    }

    $app.fullscreenScanner.status.textContent = barcodeDetector ? 'QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å†™ã—ã¦ãã ã•ã„' : 'ã“ã®ç«¯æœ«ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–QRéå¯¾å¿œã§ã™ï¼ˆæœ€æ–°Chromeæ¨å¥¨ï¼‰';
    scanning = true;
    requestAnimationFrame(scanLoop);
  } catch (err) {
    console.error(err);
    $app.fullscreenScanner.status.textContent = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
}

function stopCamera() {
  scanning = false;
  if (scanStream) {
    scanStream.getTracks().forEach(t => t.stop());
    scanStream = null;
  }
  $app.fullscreenScanner.torchBtn.dataset.on = '0';
  $app.fullscreenScanner.torchBtn.classList.remove('bg-amber-200');
}

async function toggleTorch() {
  if (!trackWithTorch) return;
  const on = $app.fullscreenScanner.torchBtn.dataset.on === '1';
  try {
    await trackWithTorch.applyConstraints({ advanced: [{ torch: !on }] });
    $app.fullscreenScanner.torchBtn.dataset.on = on ? '0' : '1';
    $app.fullscreenScanner.torchBtn.classList.toggle('bg-amber-200');
  } catch (e) { console.warn('Torch not available', e); }
}

async function switchCamera() {
  useBackCamera = !useBackCamera;
  stopCamera();
  await startCamera();
}

async function scanLoop() {
  if (!scanning) return;
  if (barcodeDetector && $app.fullscreenScanner.video.readyState >= 2) {
    try {
      const barcodes = await barcodeDetector.detect($app.fullscreenScanner.video);
      if (barcodes && barcodes.length > 0) {
        const text = (barcodes[0].rawValue || '').trim();
        if (await handleScanResult(text)) return;
      }
    } catch (e) { /* ignore */ }
  }
  requestAnimationFrame(scanLoop);
}

async function handleScanResult(text) {
  if (!text) return false;
  const lowered = text.toLowerCase();
  const boothId = QR_WHITELIST[lowered];
  if (!boothId) {
    showToast('æœªå¯¾å¿œã®QRã‚³ãƒ¼ãƒ‰ã§ã™');
    await wait(800);
    return false;
  }
  grantStampByBoothId(boothId);
  await wait(500);
  closeFullscreenScanner();
  return true;
}

function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

function handleDeepLinkAward() {
  const url = new URL(window.location.href);
  let code = url.searchParams.get('qr');
  if (!code && url.hash) {
    const m = url.hash.match(/qr=([^&]+)/);
    if (m) code = decodeURIComponent(m[1]);
  }
  if (!code) return;
  const boothId = QR_WHITELIST[String(code).toLowerCase()];
  if (boothId) {
    grantStampByBoothId(boothId);
    url.searchParams.delete('qr');
    const clean = url.pathname + url.search + (url.hash.replace(/qr=[^&]+&?/,'').replace(/[#&]$/,''));
    history.replaceState({}, '', clean || '/');
  } else {
    showToast('æœªå¯¾å¿œã®QRã‚³ãƒ¼ãƒ‰ã§ã™');
  }
}

/******************* Auth Flow *******************/
async function ensureAuth() {
  const local = loadLocalUser();
  if (local && local.id) {
    state.user = local;
    enableAppUI(state.user);
    return true;
  }
  showAuthGate();
  return false;
}

/******************* Auth Flow *******************/
async function handleSignin(e) {
  e.preventDefault();
  $app.auth.signinError.textContent = '';
  
  const name = $app.auth.siName.value.trim();
  const school = $app.auth.siSchool.value.trim();
  const department = $app.auth.siDept.value.trim();
  
  if (!name || !school || !department) {
    $app.auth.signinError.textContent = 'æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚';
    return;
  }

  try {
    // â† Supabase Functionå‘¼ã³å‡ºã—
    const res = await fetch("https://fsaeuowdijoeqhnrqazx.supabase.co/functions/v1/onsite-intake", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        name,
        school,
        department
      })
    });

    if (!res.ok) throw new Error(`Functionå‘¼ã³å‡ºã—å¤±æ•—: ${res.status}`);
    const data = await res.json();

    // Functionã®è¿”ã™JSONãŒ { id, name, school, department } ã‚’å«ã‚€å‰æ
    const user = {
      id: data.id,
      name: data.name,
      school: data.school,
      department: data.department
    };

    saveLocalUser(user);
    state.user = user;

    closeAuthModal('signin');
    enableAppUI(user);
    showToast('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚ˆã†ã“ãï¼');
  } catch (err) {
    console.error(err);
    $app.auth.signinError.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
}

async function handleLogin(e){
  e.preventDefault();
  $app.auth.loginError.textContent = '';
  const name = $app.auth.liName.value.trim();
  const school = $app.auth.liSchool.value.trim();
  if (!name || !school) {
    $app.auth.loginError.textContent = 'æ°åã¨å­¦æ ¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    return;
  }
  try {
    const rec = await sbFindUserByNameAndSchool({ name, school });
    if (!rec) {
      $app.auth.loginError.textContent = 'è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
      return;
    }
    const user = { id: rec.id, name: rec.name, school: rec.school, department: rec.department };
    saveLocalUser(user);
    state.user = user;
    closeAuthModal('login');
    enableAppUI(user);
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚');
  } catch(err){
    console.error(err);
    if (err?.code === 'SUPABASE_NOT_CONFIGURED') {
      $app.auth.loginError.textContent = 'ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç®¡ç†è€…ã¯Supabaseã®URLã¨Anonã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
      return;
    }
    $app.auth.loginError.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
  }
}

/******************* UI Utilities *******************/
function showToast(msg) {
  const el = $app.toast;
  const box = el.firstElementChild;
  box.textContent = msg;
  el.classList.remove('hidden');
  el.classList.add('animate-bounce');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => {
    el.classList.add('hidden');
    el.classList.remove('animate-bounce');
  }, 1800);
}

function layoutBoothIcons() {
  const g = $app.map.iconsGroup;
  if (!g) return;
  g.innerHTML = '';
  
  const vb = $app.map.svg.viewBox.baseVal;
  const marginFactorX = 0.02;
  const marginFactorY = 0.02;
  const usableW = vb.width * (1 - marginFactorX * 2);
  const usableH = vb.height * (1 - marginFactorY * 2);
  const offsetX = vb.x + vb.width * marginFactorX;
  const offsetY = vb.y + vb.height * marginFactorY;
  const base = Math.min(vb.width, vb.height);
  const size = Math.max(72, Math.min(200, Math.round(base * 0.09)));

  Object.keys(BOOTH_ANCHORS).forEach(id => {
    const a = BOOTH_ANCHORS[id];
    const cx = offsetX + a.x * usableW;
    const cy = offsetY + a.y * usableH;
    const x = cx - size / 2;
    const y = cy - size / 2;

    const booth = BOOTH_DATA.find(b => b.id === id) || { img: IMG_DEFAULT };
    const img = document.createElementNS('http://www.w3.org/2000/svg','image');
    img.setAttribute('x', x);
    img.setAttribute('y', y);
    img.setAttribute('width', size);
    img.setAttribute('height', size);
    img.setAttribute('href', booth.img);
    img.setAttribute('preserveAspectRatio', 'xMidYMid slice');
    img.setAttribute('cursor', 'pointer');
    img.setAttribute('role', 'button');
    img.setAttribute('aria-label', booth.name);
    img.dataset.id = id;
    g.appendChild(img);
  });

  g.querySelectorAll('image').forEach(el => el.addEventListener('click', () => {
    const booth = BOOTH_DATA.find(b => b.id === el.dataset.id);
    if (booth) openBoothSheet(booth);
  }));
}

function syncBubbleHeights(){
  const b4 = document.querySelector('#reward-bubble-4 .reward-bubble-content');
  const b8 = document.querySelector('#reward-bubble-8 .reward-bubble-content');
  if (!b4 || !b8) return;
  const h = Math.max(50, b4.getBoundingClientRect().height);
  b8.style.minHeight = h + 'px';
}

function applySupabaseAvailabilityState() {
  if (IS_SUPABASE_CONFIGURED) return;
  
  const disabledMessage = 'ç¾åœ¨ã‚µã‚¤ãƒ³ã‚¤ãƒ³/ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ç®¡ç†è€…ã¯Supabaseã®URLã¨Anonã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
  
  [$app.auth.signinError, $app.auth.loginError].forEach(el => {
    if (el) el.textContent = disabledMessage;
  });
  
  [$app.auth.signinForm, $app.auth.loginForm].forEach(form => {
    if (!form) return;
    form.querySelectorAll('input, button[type="submit"]').forEach(el => {
      el.disabled = true;
      if (el.tagName === 'BUTTON') {
        el.classList.add('opacity-50', 'cursor-not-allowed');
      }
    });
  });
}

/******************* Initialization *******************/
function init() {
  // Navigation
  $app.navButtons.forEach(btn => btn.addEventListener('click', () => {
    state.activePage = btn.dataset.page;
    updateActivePage();
  }));

  applySupabaseAvailabilityState();

  // Booth sheet
  if ($app.sheet.backdrop) {
    $app.sheet.backdrop.addEventListener('click', closeBoothSheet);
  }
  $app.sheet.getStampBtn.addEventListener('click', (e) => {
    toggleStamp(e.target.dataset.id);
    closeBoothSheet();
  });

  // Ripple effect
  document.addEventListener('click', e => {
    const rippleTarget = e.target.closest('.ripple');
    if (!rippleTarget) return;
    const rect = rippleTarget.getBoundingClientRect();
    const ripple = document.createElement('span');
    const diameter = Math.max(rippleTarget.clientWidth, rippleTarget.clientHeight);
    const radius = diameter / 2;
    ripple.style.width = ripple.style.height = `${diameter}px`;
    ripple.style.left = `${e.clientX - rect.left - radius}px`;
    ripple.style.top = `${e.clientY - rect.top - radius}px`;
    ripple.classList.add('ripple-effect');
    rippleTarget.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  });

  // Layout
  window.addEventListener('resize', () => {
    layoutBoothIcons();
    syncBubbleHeights();
  });

  // QR Scanner (Fullscreen)
  $app.scan.openCard.addEventListener('click', openFullscreenScanner);
  $app.fullscreenScanner.closeBtn.addEventListener('click', closeFullscreenScanner);
  $app.fullscreenScanner.torchBtn.addEventListener('click', toggleTorch);
  $app.fullscreenScanner.switchBtn.addEventListener('click', switchCamera);

  // Deep Link
  handleDeepLinkAward();

  // Auth
  ensureAuth().then(ok => {
    if (ok) {
      enableAppUI(state.user);
    }
  });

  // Auth Buttons
  $app.auth.openSignin.addEventListener('click', () => openAuthModal('signin'));
  $app.auth.openLogin.addEventListener('click', () => openAuthModal('login'));
  document.querySelectorAll('[data-back="signin"]').forEach(el => 
    el.addEventListener('click', () => backToAuthGate('signin'))
  );
  document.querySelectorAll('[data-back="login"]').forEach(el => 
    el.addEventListener('click', () => backToAuthGate('login'))
  );
  $app.auth.signinForm.addEventListener('submit', handleSignin);
  $app.auth.loginForm.addEventListener('submit', handleLogin);

  // User QR
  $app.userPill.addEventListener('click', openQrModal);
  $app.qr.closeBtn.addEventListener('click', closeQrModal);

  // Auth backdrop click to close QR modal
  $app.auth.backdrop.addEventListener('click', (e) => {
    if (e.target === $app.auth.backdrop && $app.qr.modal.classList.contains('show')) {
      closeQrModal();
    }
  });

  // Initial render
  renderAll();
}

// Start the app
init();
</script>
</body>
</html>
