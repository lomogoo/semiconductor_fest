<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ã¿ã‚„ãåŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    :root {
      --bg-light: #f0f4f8;
      --accent-sky: #0ea5e9;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --bar-width-pct: 78%;
      --dot-size: 28px;
      --dot-border: 4px;
      --chip-size: 64px;
    }
    html { font-family: 'Inter', sans-serif; }
    body {
      background-color: var(--bg-light);
      background-image:
        radial-gradient(at 10% 20%, hsla(210, 80%, 95%, 0.7) 0px, transparent 50%),
        radial-gradient(at 80% 15%, hsla(200, 70%, 90%, 0.6) 0px, transparent 50%),
        radial-gradient(at 20% 90%, hsla(220, 75%, 92%, 0.5) 0px, transparent 50%),
        radial-gradient(at 90% 85%, hsla(190, 60%, 90%, 0.6) 0px, transparent 50%);
      background-attachment: fixed;
      color: var(--text-main);
      overscroll-behavior: none;
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    #app { flex: 1; display: flex; flex-direction: column; }
    main { flex: 1; overflow-y: auto; position: relative; }

    .page { display: none; width: 100%; position: relative; }
    .page.active { display: block; }

    .liquid-glass {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(32px) saturate(180%);
      -webkit-backdrop-filter: blur(32px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow:
        inset 0 2px 2px rgba(255, 255, 255, 0.8),
        0 16px 40px rgba(37, 37, 85, 0.12);
    }

    .floating-nav {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(32px) saturate(180%);
      -webkit-backdrop-filter: blur(32px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.32);
      box-shadow:
        inset 0 2px 2px rgba(255, 255, 255, 0.7),
        0 16px 40px rgba(37, 37, 85, 0.18);
      position: relative;
      border-radius: 1.5rem;
    }

    #nav-indicator {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      height: 75%;
      border-radius: 0.75rem;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.62), rgba(255,255,255,0.28)),
        linear-gradient(180deg, rgba(14,165,233,0.10), rgba(14,165,233,0.00));
      backdrop-filter: blur(28px) saturate(180%);
      -webkit-backdrop-filter: blur(28px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.48);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,0.85),
        inset 0 -10px 18px rgba(14,165,233,0.08),
        0 8px 24px rgba(14,165,233,0.28);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: -1;
    }

    .nav-btn { z-index: 1; }
    .nav-btn.active { color: #0c4a6e; }

    .bottom-sheet-backdrop { position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity .3s ease; pointer-events: none; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; transform: translateY(100%); transition: transform .4s cubic-bezier(0.4, 0, 0.2, 1); }
    .bottom-sheet.is-open { transform: translateY(0); }
    .bottom-sheet.is-open + .bottom-sheet-backdrop { opacity: 1; pointer-events: auto; }

    .ripple { position: relative; overflow: hidden; }
    .ripple-effect { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.7); transform: scale(0); animation: ripple-anim .6s linear; }
    @keyframes ripple-anim { to { transform: scale(4); opacity: 0; } }

    .list-item-anim { opacity: 0; transform: translateY(20px); animation: fade-in-up .5s ease-out forwards; }
    @keyframes fade-in-up { to { opacity: 1; transform: translateY(0); } }

    .progress-area { position: relative; padding-top: 3rem; margin-top: 1rem; overflow: visible; }
    #progress-wrapper { position: relative; margin: 0 auto; width: clamp(260px, var(--bar-width-pct), 560px); min-height: 44px; display: block; }

    .progress-track { position: relative; width: 100%; height: 16px; background-color: #e0e7ff; border-radius: 9999px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08); overflow: visible; }
    #progress-bar { 
      height: 100%; 
      border-radius: 9999px; 
      background: linear-gradient(90deg, #34d399, #10b981, var(--accent-sky), #3b82f6); 
      transition: width .5s ease-in-out;
      position: relative;
    }

    .progress-marker { 
      position: absolute; 
      top: 50%; 
      width: 32px; 
      height: 32px; 
      border-radius: 50%; 
      transform: translate(-50%, -50%); 
      background: white;
      border: 3px solid #cbd5e1;
      box-shadow: 0 0 8px rgba(0,0,0,.12);
      z-index: 12;
      display: grid;
      place-items: center;
      transition: all 0.3s ease;
    }
    .progress-marker.is-active {
      border-color: #3b82f6;
      background: #3b82f6;
      box-shadow: 0 0 16px rgba(59,130,246,.6);
    }
    .progress-marker .label {
      font-size: 14px;
      font-weight: 800;
      color: #334155;
      user-select: none;
    }

    #progress-dot { 
      position: absolute; 
      top: 50%; 
      left: 0%; 
      width: 36px; 
      height: 36px; 
      background-color: white; 
      border: 4px solid #3b82f6; 
      border-radius: 50%; 
      transform: translate(-50%, -50%); 
      box-shadow: 0 0 16px rgba(59, 130, 246, 0.6), 0 4px 12px rgba(0,0,0,.15); 
      transition: left 0.5s ease-in-out; 
      z-index: 20; 
      outline: 4px solid #fff;
    }

    .map-wrap { aspect-ratio:2/3; margin-top: 0; }

    .scanner-video { width: 100%; height: auto; border-radius: 1rem; background: #000; }
    .scan-guide { position: absolute; inset: 0; pointer-events: none; }
    .scan-corner { position: absolute; width: 24px; height: 24px; border: 3px solid rgba(255,255,255,.9); }
    .scan-corner.tl { top: 12%; left: 10%; border-right: none; border-bottom: none; }
    .scan-corner.tr { top: 12%; right: 10%; border-left: none; border-bottom: none; }
    .scan-corner.bl { bottom: 12%; left: 10%; border-right: none; border-top: none; }
    .scan-corner.br { bottom: 12%; right: 10%; border-left: none; border-top: none; }

    .toast { position: fixed; left: 50%; bottom: 88px; transform: translateX(-50%); z-index: 100; }

    .auth-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.55); backdrop-filter: blur(6px); z-index: 80; display:none; }
    .auth-backdrop.show { display:block; }
    .auth-modal { position: fixed; inset: 0; z-index: 90; display:none; align-items: center; justify-content: center; overflow-y: auto; }
    .auth-modal.show { display:flex; }

    .fullscreen-scanner {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: #000;
      display: none;
      flex-direction: column;
    }
    .fullscreen-scanner.active {
      display: flex;
    }
    .fullscreen-scanner video {
      flex: 1;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .fullscreen-scanner-controls {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 101;
    }

    .stamp-category-card {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .stamp-category-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .booth-progress {
      font-size: 11px;
      color: #059669;
      font-weight: 600;
      margin-top: 2px;
    }

    .company-mini-card {
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .company-mini-card:hover {
      background: rgba(255,255,255,0.8);
    }

    .company-mini-card .acquired-check {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #34d399, #10b981);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(52, 211, 153, 0.4);
    }

    .progress-info-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .progress-booth-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: rgba(255,255,255,0.5);
      border: 2px solid #cbd5e1;
      transition: all 0.3s ease;
    }

    .progress-booth-item.acquired {
      background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.2));
      border-color: #10b981;
    }

    .progress-booth-item .booth-icon {
      width: 28px;
      height: 28px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: white;
    }

    .progress-booth-item .booth-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .progress-booth-item .booth-label {
      font-size: 10px;
      font-weight: 600;
      color: #475569;
      text-align: center;
    }

    .progress-booth-item.acquired .booth-label {
      color: #059669;
    }

    /* Survey Styles */
    .survey-field {
      margin-bottom: 1.5rem;
    }

    .survey-label {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.75rem;
      display: block;
    }

    .survey-required {
      color: #ef4444;
      margin-left: 0.25rem;
    }

    .survey-radio-group, .survey-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .survey-option {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .survey-option:hover {
      background: rgba(226, 232, 240, 0.5);
    }

    .survey-option input {
      margin-right: 0.75rem;
      cursor: pointer;
    }

    .survey-option.checked {
      border-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.1);
    }

    .survey-textarea, .survey-text-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      font-family: inherit;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .survey-textarea:focus, .survey-text-input:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .survey-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Reward Styles */
    .reward-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      border-radius: 1.5rem;
    }

    .reward-image-wrapper {
      width: 140px;
      height: 140px;
      border-radius: 1rem;
      overflow: hidden;
      background: white;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .reward-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.5rem;
    }

    .reward-details {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      text-align: center;
    }

    .reward-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1e293b;
    }

    .reward-description {
      font-size: 0.875rem;
      color: #64748b;
      line-height: 1.5;
    }

    .staff-instruction {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(252, 211, 77, 0.1), rgba(251, 146, 60, 0.1));
      border: 2px solid #fbbf24;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
    }

    .staff-instruction-title {
      font-weight: 700;
      color: #d97706;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .staff-instruction-text {
      font-size: 0.875rem;
      color: #d97706;
      line-height: 1.6;
    }

    .survey-completed-message {
      padding: 1rem;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
      border: 2px solid #10b981;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .survey-completed-message-title {
      font-weight: 700;
      color: #059669;
      margin-bottom: 0.25rem;
    }

    .survey-completed-message-text {
      font-size: 0.875rem;
      color: #059669;
    }
  </style>
</head>
<body>
  <!-- Auth: Backdrop and Launch Panel -->
  <div id="auth-backdrop" class="auth-backdrop"></div>
  <div id="auth-launch" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 p-6 w-[min(92vw,480px)]">
      <h2 class="text-xl font-semibold text-slate-800">ã”åˆ©ç”¨å‰ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³/ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <p class="text-sm text-slate-600 mt-1">å½“æ—¥å—ä»˜ã®æ–¹ã¯ã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã§æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚äº‹å‰ç”³è¾¼æ¸ˆã¿ã®æ–¹ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ã¸ã€‚</p>
      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="open-signin" class="px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">å½“æ—¥å—ä»˜ã®æ–¹</button>
        <button id="open-login" class="px-4 py-3 rounded-2xl bg-slate-200 text-slate-800 font-semibold ripple">äº‹å‰ç”³è¾¼æ¸ˆã¿ã®æ–¹</button>
      </div>
    </div>
  </div>

  <!-- Signin Modal -->
  <div id="signin-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,560px)] my-auto">
      <div class="p-5 border-b border-white/50 flex items-center justify-between">
        <button data-back="signin" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300 flex items-center gap-1">
          <span>â†</span>
          <span>æˆ»ã‚‹</span>
        </button>
        <h3 class="text-lg font-semibold text-slate-800">å½“æ—¥å—ä»˜ã®æ–¹</h3>
        <div class="w-16"></div>
      </div>
      <form id="signin-form" class="p-5 space-y-4">
        <div>
          <label class="text-sm text-slate-700">æ°å</label>
          <input id="si-name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ä¾‹:æ±åŒ— å¤ªéƒ" />
        </div>
        <div>
          <label class="text-sm text-slate-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input id="si-email" type="email" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ä¾‹:taro@example.com" />
        </div>
        <button id="signin-submit" type="submit" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">ç™»éŒ²</button>
        <p id="signin-error" class="text-sm text-red-600"></p>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,560px)] my-auto">
      <div class="p-5 border-b border-white/50 flex items-center justify-between">
        <button data-back="login" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300 flex items-center gap-1">
          <span>â†</span>
          <span>æˆ»ã‚‹</span>
        </button>
        <h3 class="text-lg font-semibold text-slate-800">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç™»éŒ²æ¸ˆã¿ï¼‰</h3>
        <div class="w-16"></div>
      </div>
      <form id="login-form" class="p-5 space-y-4">
        <div>
          <label class="text-sm text-slate-700">æ°å</label>
          <input id="li-name" type="text" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ç™»éŒ²ã—ãŸæ°å" />
        </div>
        <div>
          <label class="text-sm text-slate-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input id="li-email" type="email" required class="mt-1 w-full rounded-xl border border-slate-300 bg-white/70 px-4 py-2 outline-none focus:ring-2 focus:ring-sky-300" placeholder="ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
        </div>
        <button id="login-submit" type="submit" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">å…¥å ´</button>
        <p class="text-xs text-slate-500">â€»äº‹å‰ã«Googleãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ãŸå†…å®¹ã§ãŠç­”ãˆãã ã•ã„ã€‚</p>
        <p id="login-error" class="text-sm text-red-600"></p>
      </form>
    </div>
  </div>

  <!-- User QR Modal -->
  <div id="qr-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,420px)] my-auto">
      <div class="p-4 border-b border-white/50 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">ã‚ãªãŸã®QRã‚³ãƒ¼ãƒ‰</h3>
        <button id="close-qr" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
      </div>
      <div class="p-5 flex flex-col items-center gap-3">
        <div id="qr-box" class="bg-white rounded-2xl p-3 border border-slate-200 shadow-sm"></div>
        <div id="qr-uuid" class="text-[10px] text-slate-500 break-all font-mono"></div>
        <div class="flex gap-2">
          <a id="download-qr" class="px-3 py-1.5 text-xs rounded-xl bg-sky-600 text-white border border-sky-600 cursor-pointer">ç”»åƒã‚’ä¿å­˜</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Survey Modal -->
  <div id="survey-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,640px)] max-h-[85dvh] overflow-y-auto my-auto">
      <div class="p-4 border-b border-white/50 flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur-sm z-10">
        <h3 class="text-lg font-semibold text-slate-800">ç°¡å˜ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
        <button id="close-survey" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">âœ•</button>
      </div>
      <form id="survey-form" class="p-4 space-y-4">
        <!-- Q1: å­¦å¹´ -->
        <div class="survey-field">
          <label class="survey-label">
            Q1. ã‚ãªãŸã®å­¦å¹´ã¯ï¼Ÿ
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="grade" value="é«˜1" required />
              <span>é«˜1</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="grade" value="é«˜2" />
              <span>é«˜2</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="grade" value="é«˜3" />
              <span>é«˜3</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="grade" value="å¤§å­¦ç”Ÿ" />
              <span>å¤§å­¦ç”Ÿ</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="grade" value="ãã®ä»–" />
              <span>ãã®ä»–</span>
            </label>
          </div>
        </div>

        <!-- Q2: èˆˆå‘³åˆ†é‡ -->
        <div class="survey-field">
          <label class="survey-label">
            Q2. èˆˆå‘³ã®ã‚ã‚‹åˆ†é‡ã¯ï¼Ÿï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
            <span class="survey-required">*</span>
          </label>
          <div class="survey-checkbox-group">
            <label class="survey-option">
              <input type="checkbox" name="interest" value="é›»å­å·¥å­¦" />
              <span>é›»å­å·¥å­¦</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="interest" value="ææ–™å·¥å­¦" />
              <span>ææ–™å·¥å­¦</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="interest" value="è£½é€ æŠ€è¡“" />
              <span>è£½é€ æŠ€è¡“</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="interest" value="å–¶æ¥­ãƒ»ä¼ç”»" />
              <span>å–¶æ¥­ãƒ»ä¼ç”»</span>
            </label>
            <label class="survey-option">
              <input type="checkbox" name="interest" value="ãã®ä»–" />
              <span>ãã®ä»–</span>
            </label>
          </div>
        </div>

        <!-- Q3: é–‹å‚¬åœ° -->
        <div class="survey-field">
          <label class="survey-label">
            Q3. ã©ã“ã‹ã‚‰ã”æ¥å ´ã§ã™ã‹ï¼Ÿ
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="location" value="å®®åŸçœŒå†…" required />
              <span>å®®åŸçœŒå†…</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="location" value="æ±åŒ—åœ°æ–¹ï¼ˆå®®åŸä»¥å¤–ï¼‰" />
              <span>æ±åŒ—åœ°æ–¹ï¼ˆå®®åŸä»¥å¤–ï¼‰</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="location" value="ãã®ä»–ã®åœ°åŸŸ" />
              <span>ãã®ä»–ã®åœ°åŸŸ</span>
            </label>
          </div>
        </div>

        <!-- Q4: ä»Šå¾Œã®é€£çµ¡ -->
        <div class="survey-field">
          <label class="survey-label">
            Q4. å°†æ¥ã®ã‚­ãƒ£ãƒªã‚¢ã«ã¤ã„ã¦ä¼æ¥­ã‹ã‚‰é€£çµ¡ã‚’å—ã‘ãŸã„ã§ã™ã‹ï¼Ÿ
            <span class="survey-required">*</span>
          </label>
          <div class="survey-radio-group">
            <label class="survey-option">
              <input type="radio" name="future_contact" value="ã¯ã„" required />
              <span>ã¯ã„</span>
            </label>
            <label class="survey-option">
              <input type="radio" name="future_contact" value="ã„ã„ãˆ" />
              <span>ã„ã„ãˆ</span>
            </label>
          </div>
        </div>

        <!-- Q5: è‡ªç”±è¨˜è¿° -->
        <div class="survey-field">
          <label class="survey-label">
            Q5. æœ¬æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ã”æ„Ÿæƒ³ã‚„ã”è¦æœ›ãŒã‚ã‚Œã°ãŠèã‹ã›ãã ã•ã„
          </label>
          <textarea name="feedback" class="survey-textarea" placeholder="ã”æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„..."></textarea>
        </div>

        <button type="submit" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">
          å›ç­”ã‚’é€ä¿¡
        </button>
        <p id="survey-error" class="text-sm text-red-600"></p>
      </form>
    </div>
  </div>

  <!-- Rewards Modal -->
  <div id="rewards-modal" class="auth-modal">
    <div class="liquid-glass rounded-3xl border border-white/50 w-[min(92vw,560px)] max-h-[85dvh] overflow-y-auto my-auto">
      <div class="p-4 border-b border-white/50 flex items-center justify-between sticky top-0 bg-white/80 backdrop-blur-sm z-10">
        <h3 class="text-lg font-semibold text-slate-800">ç‰¹å…¸äº¤æ›</h3>
        <button id="close-rewards" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
      </div>
      <div id="rewards-content" class="p-4 space-y-4">
        <!-- Points Display -->
        <div class="liquid-glass rounded-2xl p-4 border border-white/50">
          <div class="text-center mb-4">
            <div class="text-3xl font-bold text-purple-600" id="rewards-points-display">0</div>
            <div class="text-xs text-slate-600 mt-1">ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</div>
          </div>
          <div class="progress-info-grid" id="rewards-booth-grid">
            <!-- ãƒ–ãƒ¼ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã‚‹ -->
          </div>
        </div>

        <!-- Pre-survey message -->
        <div id="pre-survey-section" class="space-y-4">
          <div class="liquid-glass rounded-2xl p-4 border border-white/50">
            <div class="text-center">
              <div class="text-5xl mb-3">ğŸ</div>
              <div class="font-semibold text-slate-800 mb-2">QUOã‚«ãƒ¼ãƒ‰äº¤æ›</div>
              <div class="text-sm text-slate-600 mb-4">1ãƒ–ãƒ¼ã‚¹ = 500å††åˆ†ã®QUOã‚«ãƒ¼ãƒ‰</div>
            </div>
          </div>

          <div class="staff-instruction">
            <div class="staff-instruction-title">
              ğŸ“‹ ã”æ³¨æ„ãã ã•ã„
            </div>
            <div class="staff-instruction-text">
              ç‰¹å…¸ã®å—ã‘å–ã‚Šã®å‰ã«ã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸ã®å›ç­”ãŒå¿…è¦ã§ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã”å”åŠ›ãã ã•ã„ã€‚ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”å¾Œã«ã€L404ã«ã¦ç‰¹å…¸ã‚’äº¤æ›ãã ã•ã„ã€‚
            </div>
          </div>

          <button id="open-survey-btn" class="w-full px-4 py-3 rounded-2xl bg-sky-600 text-white font-semibold ripple">
            ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«å›ç­”ã™ã‚‹
          </button>
        </div>

        <!-- Post-survey section (hidden initially) -->
        <div id="post-survey-section" class="space-y-4 hidden">
          <div class="survey-completed-message">
            <div class="survey-completed-message-title">âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</div>
            <div class="survey-completed-message-text">æ¬¡ã«ã€ã‚¹ã‚¿ãƒƒãƒ•ã®å‰ã§äº¤æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
          </div>

          <div class="reward-card liquid-glass rounded-2xl border border-white/50">
            <div class="reward-image-wrapper">
              <img src="quo.png" alt="QUOã‚«ãƒ¼ãƒ‰" />
            </div>
            <div class="reward-details">
              <div class="reward-name">QUOã‚«ãƒ¼ãƒ‰ï¼ˆ500å††åˆ†ï¼‰</div>
              <div class="reward-description" id="reward-exchange-info">0æšäº¤æ›å¯èƒ½</div>
            </div>
          </div>

          <div class="staff-instruction">
            <div class="staff-instruction-title">
              ğŸ‘¨â€ğŸ’¼ ã‚¹ã‚¿ãƒƒãƒ•ç¢ºèª
            </div>
            <div class="staff-instruction-text">
              ã‚¹ã‚¿ãƒƒãƒ•ã®ç›®ã®å‰ã§ã“ã¡ã‚‰ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚äº¤æ›ã—ãŸç‰¹å…¸ã¯å—ä»˜ï¼ˆL404ï¼‰ã§ãŠå—ã‘å–ã‚Šãã ã•ã„ã€‚
            </div>
          </div>

          <button id="claim-reward-btn" class="w-full px-4 py-3 rounded-2xl bg-purple-600 text-white font-semibold ripple text-lg">
            ğŸ äº¤æ›ã™ã‚‹
          </button>

          <div class="text-xs text-slate-500 text-center">
            â€»äº¤æ›ã—ãŸQUOã‚«ãƒ¼ãƒ‰ã¯å—ä»˜ï¼ˆL404ï¼‰ã§ãŠå—ã‘å–ã‚Šãã ã•ã„
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stamp Category Detail Sheet -->
  <div id="category-sheet" class="bottom-sheet">
    <div class="liquid-glass rounded-t-3xl max-h-[85dvh] overflow-y-auto">
      <div class="p-4 border-b border-white/50 flex items-center justify-between">
        <h4 id="category-sheet-title" class="font-semibold text-lg text-slate-800"></h4>
        <button id="close-category-sheet" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
      </div>
      <div id="category-sheet-content" class="p-4"></div>
    </div>
  </div>
  <div class="bottom-sheet-backdrop" data-target="category"></div>

  <!-- Fullscreen Scanner -->
  <div id="fullscreen-scanner" class="fullscreen-scanner">
    <div class="fullscreen-scanner-controls">
      <button id="fullscreen-close" class="px-4 py-2 rounded-xl bg-red-500 text-white font-semibold">âœ• é–‰ã˜ã‚‹</button>
      <div class="flex gap-2">
        <button id="fullscreen-torch" class="px-3 py-2 rounded-xl bg-white/20 text-white border border-white/40">ğŸ’¡</button>
        <button id="fullscreen-switch" class="px-3 py-2 rounded-xl bg-white/20 text-white border border-white/40">ğŸ”„</button>
      </div>
    </div>
    <video id="fullscreen-video" autoplay playsinline muted></video>
    <div class="scan-guide">
      <div class="scan-corner tl"></div>
      <div class="scan-corner tr"></div>
      <div class="scan-corner bl"></div>
      <div class="scan-corner br"></div>
    </div>
    <div style="position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); color: white; text-align: center; background: rgba(0,0,0,0.6); padding: 0.5rem 1rem; border-radius: 1rem;">
      <span id="fullscreen-status">QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å†™ã—ã¦ãã ã•ã„</span>
    </div>
    <div id="fullscreen-message" class="hidden" style="position: absolute; bottom: 6rem; left: 50%; transform: translateX(-50%); z-index: 102; width: 80%; max-width: 320px;">
      <div class="px-4 py-3 rounded-2xl bg-red-500 text-white shadow-lg text-center font-medium"></div>
    </div>
  </div>

  <!-- Booth Detail Sheet -->
  <div id="booth-sheet" class="bottom-sheet">
    <div class="liquid-glass rounded-t-3xl max-h-[85dvh] overflow-y-auto">
      <div class="p-4 border-b border-white/50 flex items-start gap-3">
        <div id="booth-sheet-icon" class="w-12 h-12 rounded-lg overflow-hidden bg-white flex-shrink-0"></div>
        <div class="min-w-0 flex-1">
          <h4 id="booth-sheet-title" class="font-semibold text-lg text-slate-800 leading-tight"></h4>
          <div id="booth-sheet-tags" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
        <button id="close-booth-sheet" class="px-3 py-1.5 text-xs rounded-xl bg-slate-100 text-slate-700 border border-slate-300">é–‰ã˜ã‚‹</button>
      </div>
      <div class="p-4 space-y-4 text-sm">
        <p id="booth-sheet-desc" class="text-slate-700 leading-6"></p>
        <div class="text-slate-600 space-y-2">
          <div><strong class="font-medium text-slate-800">ç²å¾—ãƒã‚¤ãƒ³ãƒˆ:</strong><span class="text-sky-600 font-semibold">1pt (500å††åˆ†QUOã‚«ãƒ¼ãƒ‰)</span></div>
          <div><strong class="font-medium text-slate-800">ã‚¹ã‚¿ãƒ³ãƒ—æ¡ä»¶:</strong><span id="booth-sheet-condition">-</span></div>
          <div><strong class="font-medium text-slate-800">ãƒãƒ™ãƒ«ãƒ†ã‚£:</strong><span id="booth-sheet-giveaway">-</span></div>
        </div>
      </div>
    </div>
  </div>
  <div class="bottom-sheet-backdrop" data-target="booth"></div>

  <div id="app">
    <header id="header" class="sticky top-0 z-30 liquid-glass transition-transform duration-300 rounded-b-3xl">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
        <img src="logo.png" alt="Logo" class="w-10 h-10 shadow-lg rounded-lg object-contain" />
        <div>
          <h1 id="header-title" class="text-lg font-semibold text-sky-800">ãƒ›ãƒ¼ãƒ </h1>
          <p class="text-xs text-sky-700">ã¿ã‚„ãåŠå°ä½“ã‚­ãƒ£ãƒªã‚¢ãƒ•ã‚§ã‚¹</p>
        </div>
        <div id="user-pill" class="ml-auto text-xs text-slate-700 hidden"></div>
      </div>
    </header>

    <main class="flex-1 pb-28">
      <div id="page-home" class="page active p-4 space-y-6">
        <div class="liquid-glass rounded-3xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-sky-800">ã‚¹ã‚¿ãƒ³ãƒ—é€²æ—</h3>
            <div class="flex items-center gap-2">
              <span id="rank-percentile" class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 border border-amber-200 font-medium"></span>
              <span id="progress-badge" class="text-xs px-2 py-1 rounded-full bg-sky-100 text-sky-700 border border-sky-200 font-mono">0pt</span>
            </div>
          </div>
          <div class="progress-area">
            <div id="progress-wrapper">
              <div id="progress-track" class="progress-track">
                <div id="progress-bar" style="width:0%"></div>
                <div id="progress-dot"></div>
              </div>
            </div>
          </div>
          <p id="progress-msg" class="mt-4 text-sm text-center text-slate-600"></p>
          <div id="progress-percent" class="mt-2 text-center">
            <span class="text-2xl font-bold text-sky-600">0%</span>
            <span class="text-xs text-slate-500 ml-1">é”æˆ</span>
          </div>
          <div class="mt-4 text-center">
            <button id="open-rewards-btn" class="px-6 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 text-white font-semibold text-sm ripple shadow-lg hover:shadow-xl transition-shadow">
              ğŸ QUOã‚«ãƒ¼ãƒ‰ã‚’äº¤æ›ã™ã‚‹
            </button>
          </div>
        </div>

        <div class="liquid-glass rounded-3xl p-4">
          <h3 class="font-semibold text-sky-800 mb-3">ã‚¹ã‚¿ãƒ³ãƒ—</h3>
          <div class="space-y-3" id="stamp-categories">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="stamp-category-card liquid-glass rounded-2xl p-4 border border-white/50" data-category="stage">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-xl bg-purple-500 text-white grid place-items-center text-2xl">ğŸ¤</div>
                  <div>
                    <div class="font-semibold text-slate-800">ã‚¹ãƒ†ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</div>
                    <div class="text-xs text-slate-600">16:00ã€œ | ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãªã—</div>
                  </div>
                </div>
                <div class="text-slate-400">â€º</div>
              </div>
            </div>

            <!-- ç ”ç©¶ç™ºè¡¨ä¼š -->
            <div class="stamp-category-card liquid-glass rounded-2xl p-4 border border-white/50" data-category="presentation">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-xl bg-blue-500 text-white grid place-items-center text-2xl">ğŸ“Š</div>
                  <div>
                    <div class="font-semibold text-slate-800">ç ”ç©¶ç™ºè¡¨ä¼š</div>
                    <div class="text-xs text-slate-600">17:30ã€œ | ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãªã—</div>
                  </div>
                </div>
                <div class="text-slate-400">â€º</div>
              </div>
            </div>

            <!-- ä¼æ¥­ãƒ–ãƒ¼ã‚¹ -->
            <div class="stamp-category-card liquid-glass rounded-2xl p-4 border border-white/50" data-category="booths">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-xl bg-green-500 text-white grid place-items-center text-2xl">ğŸ¢</div>
                  <div>
                    <div class="font-semibold text-slate-800">ä¼æ¥­ãƒ–ãƒ¼ã‚¹</div>
                    <div class="text-xs text-slate-600">6ç¤¾ | å„1pt (500å††åˆ†)</div>
                    <div id="booth-progress" class="booth-progress">0/6 ç²å¾—æ¸ˆã¿</div>
                  </div>
                </div>
                <div class="text-slate-400">â€º</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page-map" class="page p-3 pt-2 space-y-1">
        <div class="max-w-[1200px] mx-auto">
          <button id="scan-card" class="w-full liquid-glass rounded-2xl px-4 py-3 flex items-center justify-between border border-white/50 ripple">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-sky-500 text-white grid place-items-center text-2xl">ğŸ“·</div>
              <div class="text-left">
                <div class="font-semibold text-slate-800">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</div>
                <div class="text-xs text-slate-600">QRã‚’èª­ã¿å–ã£ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’GET</div>
              </div>
            </div>
            <div class="text-sky-700 text-sm font-medium">ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹</div>
          </button>
        </div>
        
        <div class="map-wrap w-full max-w-[1200px] mx-auto">
          <svg id="svg-map" viewBox="0 0 1200 1800" preserveAspectRatio="xMidYMid meet" class="w-full h-auto">
            <image id="bg-image" href="assets/layout.png" xlink:href="assets/layout.png" x="0" y="0" width="1200" height="1800" />
            <g id="booth-icons" font-size="140" text-anchor="middle" dominant-baseline="middle" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));"></g>
          </svg>
        </div>
      </div>

      <div id="page-list" class="page p-4">
        <ul id="booth-list" class="space-y-2"></ul>
      </div>
    </main>

    <div id="toast" class="toast hidden">
      <div class="px-4 py-2 rounded-2xl bg-sky-600 text-white shadow-lg"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 z-40 p-3">
      <nav class="h-16 grid grid-cols-3 items-center floating-nav rounded-3xl">
        <div id="nav-indicator"></div>
        <button data-page="home" class="nav-btn active flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ </div><span class="text-xs font-medium">ãƒ›ãƒ¼ãƒ </span></button>
        <button data-page="map" class="nav-btn flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ—ºï¸</div><span class="text-xs font-medium">ãƒãƒƒãƒ—</span></button>
        <button data-page="list" class="nav-btn flex flex-col items-center justify-center h-full transition-colors duration-200 ripple"><div class="nav-icon text-2xl transition-transform">ğŸ“„</div><span class="text-xs font-medium">ä¸€è¦§</span></button>
      </nav>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://fsaeuowdijoeqhnrqazx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzYWV1b3dkaWpvZXFobnJxYXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjA0MjYsImV4cCI6MjA3NTQ5NjQyNn0.xgIQ9jf3qa4oy6Dbc8mVaP8woRDWBwMxLAJwiCGEWmk";

async function callEdgeFunction(functionName, body = {}) {
  const token = localStorage.getItem('auth_token');
  const headers = {
    'Content-Type': 'application/json',
    'apikey': SUPABASE_ANON_KEY,
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  try {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/${functionName}`, {
      method: 'POST',
      headers,
      body: JSON.stringify(body)
    });
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error || `API Error: ${response.status}`);
    }
    return await response.json();
  } catch (error) {
    console.error(`[callEdgeFunction] ${functionName} failed:`, error);
    throw error;
  }
}

const IMG_DEFAULT = 'logo.jpg';
const MAX_POINTS = 6;

const BOOTH_ANCHORS = {
  A: { x: 0.85, y: 0.22 }, 
  B: { x: 0.83, y: 0.35 }, 
  C: { x: 0.82, y: 0.60 },
  D: { x: 0.175, y: 0.60 }, 
  E: { x: 0.175, y: 0.83 }, 
  F: { x: 0.82, y: 0.83 }
};

const BOOTH_DATA = [
  { id: 'A', name: 'æ ªå¼ä¼šç¤¾ãƒ¬ã‚¹ã‚¿ãƒ¼', img: 'assets/restar.jpeg', icon: 'âš¡', desc: 'å›½å†…å±ˆæŒ‡ã®å£²ä¸Šã‚’èª‡ã‚‹åŠå°ä½“å•†ç¤¾ã€‚åŠå°ä½“è£½å“ã‚’å°‚é–€ã¨ã—ãŸè²·ã„ä»˜ã‘ãƒ»è²©å£²ã«åŠ ãˆã€é¡§å®¢ã®ç´å“ç®¡ç†ç­‰ã®ã‚µãƒãƒ¼ãƒˆã‚‚è¡Œã†ã€‚', tags:['ã‚¨ãƒƒãƒãƒ³ã‚°', 'è£½é€ è£…ç½®', 'ãƒ—ãƒ©ã‚ºãƒ'], giveaway:'TELã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¦ã‚¨ãƒãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ—', condition:'ã‚¨ãƒƒãƒãƒ³ã‚°å·¥ç¨‹ã«é–¢ã™ã‚‹ã‚¯ã‚¤ã‚ºã«æ­£è§£' },
  { id: 'B', name: 'ã‚­ã‚ªã‚¯ã‚·ã‚¢å²©æ‰‹æ ªå¼ä¼šç¤¾', img: 'assets/kioxia.png', icon: 'ğŸ–¼ï¸', desc: 'å›½å†…å”¯ä¸€ã®ãƒ¡ãƒ¢ãƒªåŠå°ä½“ãƒ¡ãƒ¼ã‚«ãƒ¼ã€Œã‚­ã‚ªã‚¯ã‚·ã‚¢ã€ã®ã‚°ãƒ«ãƒ¼ãƒ—ä¼æ¥­ã€‚æ±åŒ—åœ°åŸŸã®åŠå°ä½“äººæè‚²æˆç­‰ã«å–ã‚Šçµ„ã‚€ã€Œæ±åŒ—åŠå°ä½“ãƒ»ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ã‚³ãƒ³ã‚½ãƒ¼ã‚·ã‚¢ãƒ ã€ã®äº‹å‹™å±€ã‚‚å‹™ã‚ã¦ã„ã‚‹ã€‚', tags:['ãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯', 'EUV', 'ãƒªã‚½ã‚°ãƒ©ãƒ•ã‚£'], giveaway:'ãƒ•ã‚©ãƒˆãƒã‚¹ã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³å®šè¦', condition:'ãƒŸãƒ‹ãƒãƒ¥ã‚¢ãƒã‚¹ã‚¯ã®é‡ã­åˆã‚ã›ä½“é¨“' },
  { id: 'C', name: 'ã‚½ãƒ‹ãƒ¼ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿ãƒãƒ‹ãƒ¥ãƒ•ã‚¡ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°æ ªå¼ä¼šç¤¾', img: 'assets/sont.png', icon: 'ğŸ’¡', desc: 'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®åŠå°ä½“ç”Ÿç”£ä¼šç¤¾ã€‚ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ã‚«ãƒ¡ãƒ©ç­‰ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€Œã‚¤ãƒ¡ãƒ¼ã‚¸ã‚»ãƒ³ã‚µã€ã§ä¸–ç•Œãƒˆãƒƒãƒ—ã®ã‚·ã‚§ã‚¢ã‚’èª‡ã‚‹ã€‚ç™½çŸ³å¸‚ã«ãƒ¬ãƒ¼ã‚¶ãƒ¼åŠå°ä½“ã®ç”Ÿç”£å·¥å ´ãŒç«‹åœ°ã—ã¦ã„ã‚‹ã€‚', tags:['LSI', 'MCU', 'IoT'], giveaway:'ã‚ªãƒªã‚¸ãƒŠãƒ«ICãƒãƒƒãƒ—ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼', condition:'IoTãƒ‡ãƒã‚¤ã‚¹ã®ãƒ‡ãƒ¢ã‚’ä½“é¨“' },
  { id: 'D', name: 'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³å®®åŸæ ªå¼ä¼šç¤¾', img: 'assets/tel.png', icon: 'ğŸ”¥', desc: 'å›½å†…ãƒˆãƒƒãƒ—ã€ä¸–ç•Œã§ã‚‚ç¬¬4ä½ã®åŠå°ä½“è£½é€ è£…ç½®ãƒ¡ãƒ¼ã‚«ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ä¼æ¥­ã§ã‚ã‚Šã€å¤§å’Œç”ºã§ãƒ—ãƒ©ã‚ºãƒã‚¨ãƒƒãƒãƒ³ã‚°è£…ç½®ã®è£½é€ ç­‰ã‚’è¡Œã£ã¦ã„ã‚‹ã€‚', tags:['ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹', 'è£…ç½®éƒ¨å“', 'é™é›»ãƒãƒ£ãƒƒã‚¯'], giveaway:'ã‚»ãƒ©ãƒŸãƒƒã‚¯è£½ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼', condition:'ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹ã®ç†±ä¼å°å®Ÿé¨“ã«å‚åŠ ' },
  { id: 'E', name: 'TOPPANæ ªå¼ä¼šç¤¾', img: 'assets/toppan.jpg', icon: 'ğŸº', desc: 'å°åˆ·ãƒ»å¾®ç´°åŠ å·¥æŠ€è¡“ã‚’é§†ä½¿ã—ãŸåŠå°ä½“ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŸºæ¿ç­‰ã®éƒ¨ç´ æãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ä¸–ç•Œå±ˆæŒ‡ã®æŠ€è¡“åŠ›ã‚’èª‡ã‚‹ã€‚', tags:['ææ–™', 'ã‚»ãƒ©ãƒŸãƒƒã‚¯ã‚¹', 'é«˜ç´”åº¦'], giveaway:'ãƒŸãƒ‹ãƒãƒ¥ã‚¢ã‚»ãƒ©ãƒŸãƒƒã‚¯ãƒ—ãƒ¬ãƒ¼ãƒˆ', condition:'è£½å“ã‚µãƒ³ãƒ—ãƒ«ã«è§¦ã‚Œã¦ã¿ã‚‹' },
  { id: 'F', name: 'ãƒ©ãƒ”ã‚¹ã‚»ãƒŸã‚³ãƒ³ãƒ€ã‚¯ã‚¿æ ªå¼ä¼šç¤¾', img: 'assets/lapis.png', icon: 'ğŸŒ¡ï¸', desc: 'å›½å†…ç¬¬4ä½ã®åŠå°ä½“ãƒ¡ãƒ¼ã‚«ãƒ¼ã€Œãƒ­ãƒ¼ãƒ æ ªå¼ä¼šç¤¾ã€ã®ã‚°ãƒ«ãƒ¼ãƒ—ä¼æ¥­ã€‚å¤§è¡¡æ‘ã«åŠå°ä½“è£½é€ å·¥å ´ãŒç«‹åœ°ã—ã¦ã„ã‚‹ã€‚', tags:['è¨ˆæ¸¬', 'æˆè†œ', 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼'], giveaway:'æ¶²æ™¶æ¸©åº¦è¨ˆã‚«ãƒ¼ãƒ‰', condition:'è†œåšè¨ˆã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹å­¦' },
];

const CATEGORY_DATA = {
  stage: {
    title: 'ã‚¹ãƒ†ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
    icon: 'ğŸ¤',
    time: '16:00ã€œ',
    desc: 'ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã®ãƒˆãƒ¼ã‚¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚æ¥­ç•Œã®ãƒˆãƒƒãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã«ã‚ˆã‚‹è²´é‡ãªãŠè©±ãŒèã‘ã¾ã™ã€‚',
    condition: 'ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ '
  },
  presentation: {
    title: 'ç ”ç©¶ç™ºè¡¨ä¼š',
    icon: 'ğŸ“Š',
    time: '17:30ã€œ',
    desc: 'å­¦ç”Ÿã«ã‚ˆã‚‹åŠå°ä½“é–¢é€£ã®ç ”ç©¶ç™ºè¡¨ä¼šã§ã™ã€‚æœ€æ–°ã®ç ”ç©¶æˆæœã‚’å­¦ã³ã€è³ªç–‘å¿œç­”ã«ã‚‚å‚åŠ ã§ãã¾ã™ã€‚',
    condition: 'ç ”ç©¶ç™ºè¡¨ä¼šã«å‚åŠ '
  }
};

const state = { 
  points: 0, 
  activePage: 'home', 
  prevCount: 0, 
  user: null,
  percentile: null,
  acquiredStamps: new Set(),
  claimedRewards: new Set(),
  surveyCompleted: false
};

const $app = {
  header: document.getElementById('header'),
  headerTitle: document.getElementById('header-title'),
  userPill: document.getElementById('user-pill'),
  pages: document.querySelectorAll('.page'),
  nav: document.querySelector('.floating-nav'),
  navIndicator: document.getElementById('nav-indicator'),
  navButtons: document.querySelectorAll('.nav-btn'),
  boothList: document.getElementById('booth-list'),
  progress: {
    badge: document.getElementById('progress-badge'),
    bar: document.getElementById('progress-bar'),
    wrapper: document.getElementById('progress-wrapper'),
    msg: document.getElementById('progress-msg'),
    percent: document.getElementById('progress-percent'),
    rankPercentile: document.getElementById('rank-percentile'),
    dot: document.getElementById('progress-dot'),
  },
  map: {
    svg: document.getElementById('svg-map'),
    bg: document.getElementById('bg-image'),
    iconsGroup: document.getElementById('booth-icons')
  },
  categorySheet: {
    el: document.getElementById('category-sheet'),
    backdrop: document.querySelector('.bottom-sheet-backdrop[data-target="category"]'),
    title: document.getElementById('category-sheet-title'),
    content: document.getElementById('category-sheet-content'),
    closeBtn: document.getElementById('close-category-sheet')
  },
  boothSheet: {
    el: document.getElementById('booth-sheet'),
    backdrop: document.querySelector('.bottom-sheet-backdrop[data-target="booth"]'),
    icon: document.getElementById('booth-sheet-icon'),
    title: document.getElementById('booth-sheet-title'),
    tags: document.getElementById('booth-sheet-tags'),
    desc: document.getElementById('booth-sheet-desc'),
    condition: document.getElementById('booth-sheet-condition'),
    giveaway: document.getElementById('booth-sheet-giveaway'),
    closeBtn: document.getElementById('close-booth-sheet')
  },
  scan: {
    openCard: document.getElementById('scan-card'),
  },
  fullscreenScanner: {
    container: document.getElementById('fullscreen-scanner'),
    video: document.getElementById('fullscreen-video'),
    status: document.getElementById('fullscreen-status'),
    closeBtn: document.getElementById('fullscreen-close'),
    torchBtn: document.getElementById('fullscreen-torch'),
    switchBtn: document.getElementById('fullscreen-switch'),
  },
  auth: {
    backdrop: document.getElementById('auth-backdrop'),
    launch: document.getElementById('auth-launch'),
    signin: document.getElementById('signin-modal'),
    login: document.getElementById('login-modal'),
    openSignin: document.getElementById('open-signin'),
    openLogin: document.getElementById('open-login'),
    signinForm: document.getElementById('signin-form'),
    loginForm: document.getElementById('login-form'),
    siName: document.getElementById('si-name'),
    siEmail: document.getElementById('si-email'),
    liName: document.getElementById('li-name'),
    liEmail: document.getElementById('li-email'),
    signinError: document.getElementById('signin-error'),
    loginError: document.getElementById('login-error'),
  },
  toast: document.getElementById('toast'),
  qr: {
    modal: document.getElementById('qr-modal'),
    box: document.getElementById('qr-box'),
    uuid: document.getElementById('qr-uuid'),
    dl: document.getElementById('download-qr'),
    closeBtn: document.getElementById('close-qr')
  },
  rewards: {
    modal: document.getElementById('rewards-modal'),
    content: document.getElementById('rewards-content'),
    closeBtn: document.getElementById('close-rewards'),
    openBtn: document.getElementById('open-rewards-btn'),
    claimBtn: document.getElementById('claim-reward-btn'),
    openSurveyBtn: document.getElementById('open-survey-btn'),
    pointsDisplay: document.getElementById('rewards-points-display'),
    exchangeInfo: document.getElementById('reward-exchange-info'),
    boothGrid: document.getElementById('rewards-booth-grid'),
    preSurveySection: document.getElementById('pre-survey-section'),
    postSurveySection: document.getElementById('post-survey-section')
  },
  survey: {
    modal: document.getElementById('survey-modal'),
    form: document.getElementById('survey-form'),
    closeBtn: document.getElementById('close-survey'),
    error: document.getElementById('survey-error')
  }
};

function showAuthGate() {
  $app.auth.backdrop.classList.add('show');
  $app.auth.launch.classList.add('show');
  const root = document.getElementById('app');
  root.classList.add('opacity-0', 'pointer-events-none', 'select-none');
}

function hideAuthGate() {
  $app.auth.backdrop.classList.remove('show');
  $app.auth.launch.classList.remove('show');
}

function openAuthModal(kind) {
  hideAuthGate();
  $app.auth.backdrop.classList.add('show');
  const target = kind === 'signin' ? $app.auth.signin : $app.auth.login;
  target.classList.add('show');
}

function closeAuthModal(kind) {
  const target = kind === 'signin' ? $app.auth.signin : $app.auth.login;
  target.classList.remove('show');
  if (!$app.auth.signin.classList.contains('show') &&
      !$app.auth.login.classList.contains('show') &&
      !$app.qr.modal.classList.contains('show') &&
      !$app.rewards.modal.classList.contains('show') &&
      !$app.survey.modal.classList.contains('show')) {
    $app.auth.backdrop.classList.remove('show');
  }
}

function backToAuthGate(kind) {
  closeAuthModal(kind);
  showAuthGate();
}

function enableAppUI(user) {
  if (!user || !user.id || !user.name || !user.email) {
    console.error('Invalid user data:', user);
    showToast('ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™');
    showAuthGate();
    return;
  }
  
  $app.auth.backdrop?.classList.remove('show');
  $app.auth.launch?.classList.remove('show');
  $app.auth.signin?.classList.remove('show');
  $app.auth.login?.classList.remove('show');
  $app.qr.modal?.classList.remove('show');
  $app.rewards.modal?.classList.remove('show');
  $app.survey.modal?.classList.remove('show');
  const root = document.getElementById('app');
  root.classList.remove('opacity-0', 'pointer-events-none', 'select-none');
  $app.userPill.classList.remove('hidden');
  $app.userPill.classList.add('cursor-pointer');
  $app.userPill.innerHTML =
    `<button class="px-2 py-1 rounded-xl bg-sky-100 border border-sky-200 hover:bg-sky-200 transition">
       ${user.name}
     </button>`;

  window.scrollTo({ top: 0, behavior: 'instant' });
  
  const mainEl = document.querySelector('main');
  if (mainEl) {
    mainEl.scrollTop = 0;
  }
  
  setTimeout(() => {
    layoutBoothIcons();
  }, 100);
}

function openQrModal() {
  if (!state.user?.id) { showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  $app.auth.backdrop.classList.add('show');
  $app.qr.modal.classList.add('show');
  renderUserQr(state.user.id);
}

function closeQrModal() {
  $app.qr.modal.classList.remove('show');
  if (!$app.auth.signin.classList.contains('show') &&
      !$app.auth.login.classList.contains('show') &&
      !$app.rewards.modal.classList.contains('show') &&
      !$app.survey.modal.classList.contains('show')) {
    $app.auth.backdrop.classList.remove('show');
  }
}

function renderUserQr(uuid) {
  $app.qr.box.innerHTML = '';
  $app.qr.uuid.textContent = uuid;

  try {
    new QRCode($app.qr.box, {
      text: uuid,
      width: 260,
      height: 260,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    setTimeout(() => {
      const canvas = $app.qr.box.querySelector('canvas');
      if (canvas) {
        try {
          const dataUrl = canvas.toDataURL('image/png');
          $app.qr.dl.setAttribute('href', dataUrl);
          $app.qr.dl.setAttribute('download', `user-qr-${uuid}.png`);
        } catch (e) {
          console.warn('toDataURL failed', e);
        }
      }
    }, 100);
  } catch (err) {
    console.error(err);
    showToast('QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

function openSurveyModal() {
  $app.auth.backdrop.classList.add('show');
  $app.survey.modal.classList.add('show');
}

function closeSurveyModal() {
  $app.survey.modal.classList.remove('show');
  if (!$app.auth.signin.classList.contains('show') &&
      !$app.auth.login.classList.contains('show') &&
      !$app.qr.modal.classList.contains('show') &&
      !$app.rewards.modal.classList.contains('show')) {
    $app.auth.backdrop.classList.remove('show');
  }
}

async function submitSurvey(e) {
  e.preventDefault();
  if (!state.user?.id) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
  const formData = new FormData($app.survey.form);
  const surveyData = {
    grade: formData.get('grade'),
    location: formData.get('location'),
    future_contact: formData.get('future_contact'),
    feedback: formData.get('feedback'),
    interests: []
  };

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¤‡æ•°é¸æŠã•ã‚ŒãŸã‚‚ã®ã‚’åé›†
  formData.getAll('interest').forEach(interest => {
    surveyData.interests.push(interest);
  });

  try {
    $app.survey.error.textContent = '';
    const result = await callEdgeFunction('submit-survey', {
      userId: state.user.id,
      surveyData: surveyData
    });

    if (result.success) {
      state.surveyCompleted = true;
      state.user.survey_completed = true;
      saveLocalUser(state.user);
      closeSurveyModal();
      showToast('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼');
      
      // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰å ±é…¬ç”»é¢ã‚’æ›´æ–°
      setTimeout(() => {
        renderRewardsModal();
      }, 300);
    }
  } catch (err) {
    console.error('Survey submission failed:', err);
    $app.survey.error.textContent = 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
  }
}

function openRewardsModal() {
  if (!state.user?.id) { 
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); 
    return; 
  }
  $app.auth.backdrop.classList.add('show');
  $app.rewards.modal.classList.add('show');
  renderRewardsModal();
}

function closeRewardsModal() {
  $app.rewards.modal.classList.remove('show');
  if (!$app.auth.signin.classList.contains('show') &&
      !$app.auth.login.classList.contains('show') &&
      !$app.qr.modal.classList.contains('show') &&
      !$app.survey.modal.classList.contains('show')) {
    $app.auth.backdrop.classList.remove('show');
  }
}

function renderRewardsModal() {
  const points = state.points;
  const alreadyClaimed = state.claimedRewards.size > 0;
  const isSurveyCompleted = state.surveyCompleted || (state.user && state.user.survey_completed);
  
  $app.rewards.pointsDisplay.textContent = `${points}pt`;

  $app.rewards.boothGrid.innerHTML = '';
  BOOTH_DATA.forEach(booth => {
    const isAcquired = state.acquiredStamps.has(booth.id);
    const item = document.createElement('div');
    item.className = `progress-booth-item ${isAcquired ? 'acquired' : ''}`;
    item.innerHTML = `
      <div class="booth-icon">
        <img src="${booth.img}" alt="${booth.name}" />
      </div>
      <div class="booth-label">${booth.id}</div>
    `;
    $app.rewards.boothGrid.appendChild(item);
  });

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæœªå®Œäº†ã®å ´åˆ
  if (!isSurveyCompleted) {
    $app.rewards.preSurveySection.classList.remove('hidden');
    $app.rewards.postSurveySection.classList.add('hidden');
  } else {
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®Œäº†å¾Œ
    $app.rewards.preSurveySection.classList.add('hidden');
    $app.rewards.postSurveySection.classList.remove('hidden');

    $app.rewards.exchangeInfo.textContent = alreadyClaimed 
      ? 'äº¤æ›æ¸ˆã¿' 
      : `${points}æšäº¤æ›å¯èƒ½`;

    const btn = $app.rewards.claimBtn;
    if (alreadyClaimed) {
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      btn.textContent = 'äº¤æ›æ¸ˆã¿';
    } else if (points === 0) {
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      btn.textContent = 'ãƒ–ãƒ¼ã‚¹ã‚’å›ã£ã¦ãã ã•ã„';
    } else {
      btn.disabled = false;
      btn.classList.remove('opacity-50', 'cursor-not-allowed');
      btn.textContent = 'ğŸ äº¤æ›ã™ã‚‹';
    }
  }
}

async function claimReward() {
  if (!state.user?.id) {
    showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }

  if (state.points === 0) {
    showToast('ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  if (state.claimedRewards.size > 0) {
    showToast('æ—¢ã«äº¤æ›æ¸ˆã¿ã§ã™');
    return;
  }

  if (!state.surveyCompleted && !state.user.survey_completed) {
    showToast('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸ã®å›ç­”ãŒå¿…è¦ã§ã™');
    closeRewardsModal();
    setTimeout(() => openSurveyModal(), 300);
    return;
  }

  try {
    const rewardId = `quo-card-${state.points}`;
    const result = await callEdgeFunction('claim-reward', {
      userId: state.user.id,
      rewardId: rewardId,
      points: state.points
    });

    if (result.success) {
      state.claimedRewards.add(rewardId);
      showToast(`âœ… QUOã‚«ãƒ¼ãƒ‰${state.points}æš (${state.points * 500}å††åˆ†)ã‚’äº¤æ›ã—ã¾ã—ãŸï¼`);
      renderRewardsModal();
    }
  } catch (err) {
    console.error('Failed to claim reward:', err);
    if (err.message && err.message.includes('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ')) {
      closeRewardsModal();
      setTimeout(() => openSurveyModal(), 300);
    } else {
      showToast('ç‰¹å…¸ã®äº¤æ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
}

const LS_KEY_USER = 'app_user';
const LS_KEY_TOKEN = 'auth_token';

function saveLocalUser(u) { 
  localStorage.setItem(LS_KEY_USER, JSON.stringify(u)); 
}

function loadLocalUser() { 
  try { 
    return JSON.parse(localStorage.getItem(LS_KEY_USER) || 'null'); 
  } catch { 
    return null; 
  } 
}

function clearLocalUser() { 
  localStorage.removeItem(LS_KEY_USER); 
  localStorage.removeItem(LS_KEY_TOKEN);
}

async function syncPointsFromServer() {
  if (!state.user?.id) {
    console.log('[syncPointsFromServer] No user ID');
    return;
  }
  
  console.log('[syncPointsFromServer] Starting sync for user:', state.user.id);
  
  try {
    const data = await callEdgeFunction('get-user-data', {
      userId: state.user.id
    });
    
    console.log('[syncPointsFromServer] Data received:', data);
    
    state.points = data.points || 0;
    state.acquiredStamps = new Set(data.acquired_stamps || []);
    state.claimedRewards = new Set(data.claimed_rewards || []);
    state.surveyCompleted = data.survey_completed || false;
    
    if (state.user) {
      state.user.survey_completed = state.surveyCompleted;
      saveLocalUser(state.user);
    }
    
    console.log('[syncPointsFromServer] State updated:', {
      points: state.points,
      acquiredStamps: Array.from(state.acquiredStamps),
      claimedRewards: Array.from(state.claimedRewards),
      surveyCompleted: state.surveyCompleted
    });
    
    await updatePercentile();
    renderAll();
    
    console.log('[syncPointsFromServer] Sync complete');
  } catch (err) {
    console.error('[syncPointsFromServer] Failed to sync points:', err);
  }
}

async function updatePercentile() {
  if (!state.user?.id || state.points === 0) {
    state.percentile = null;
    return;
  }
  
  try {
    const result = await callEdgeFunction('get-percentile', {
      userId: state.user.id
    });
    
    state.percentile = result.percentile;
  } catch (err) {
    console.error('Failed to calculate percentile:', err);
    state.percentile = null;
  }
}

function renderAll() {
  renderProgress();
  updateActivePage();
  if (state.activePage === 'map') {
    layoutBoothIcons();
  }
}

function renderBoothList() {
  console.log('[renderBoothList] called');
  $app.boothList.innerHTML = '';
  BOOTH_DATA.forEach((b, i) => {
    const isAcquired = state.acquiredStamps.has(b.id);
    const li = document.createElement('li');
    li.className = 'liquid-glass rounded-2xl flex items-center gap-3 p-3 ripple list-item-anim cursor-pointer';
    if (isAcquired) {
      li.style.background = 'linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(16, 185, 129, 0.15))';
    }
    li.style.animationDelay = `${i * 50}ms`;
    li.innerHTML = `
      ${isAcquired ? '<div class="acquired-check">âœ“</div>' : ''}
      <div class="w-12 h-12 rounded-lg overflow-hidden bg-white flex-shrink-0">
        <img src="${b.img}" alt="${b.name}" class="w-full h-full object-contain bg-white" />
      </div>
      <div class="min-w-0 flex-1">
        <div class="font-semibold text-slate-800">${b.name}</div>
        <div class="text-xs text-slate-500 truncate">${b.desc}</div>
      </div>
      <div class="text-xl ${isAcquired ? 'text-emerald-600' : 'text-sky-600'} font-semibold">${isAcquired ? 'âœ“' : '1pt'}</div>`;
    li.addEventListener('click', () => openBoothSheet(b));
    $app.boothList.appendChild(li);
  });
}

function renderProgress() {
  const n = state.points;
  const progressPercent = (n / MAX_POINTS) * 100;

  $app.progress.badge.textContent = `${n}pt`;
  $app.progress.bar.style.width = `${progressPercent}%`;
  $app.progress.dot.style.left = `${progressPercent}%`;

  if (state.percentile !== null) {
    $app.progress.rankPercentile.textContent = `ä¸Šä½ ${100 - state.percentile}%`;
    $app.progress.rankPercentile.classList.remove('hidden');
  } else {
    $app.progress.rankPercentile.classList.add('hidden');
  }

  const progressTrack = document.getElementById('progress-track');
  const existingMarkers = progressTrack.querySelectorAll('.progress-marker');
  existingMarkers.forEach(m => m.remove());

  for (let i = 1; i <= MAX_POINTS; i++) {
    const marker = document.createElement('div');
    marker.className = `progress-marker ${n >= i ? 'is-active' : ''}`;
    marker.style.left = `${(i / MAX_POINTS) * 100}%`;
    marker.innerHTML = `<span class="label">${i}</span>`;
    progressTrack.appendChild(marker);
  }

  if (n >= MAX_POINTS) {
    $app.progress.msg.innerHTML = 'ğŸ‰ <strong>å…¨ã¦ã®ãƒ–ãƒ¼ã‚¹ã‚’å›ã‚Šã¾ã—ãŸï¼</strong> QUOã‚«ãƒ¼ãƒ‰ã¨äº¤æ›ã§ãã¾ã™ï¼';
  } else {
    $app.progress.msg.innerHTML = `ã‚ã¨<strong>${MAX_POINTS - n}</strong>ãƒ–ãƒ¼ã‚¹ã§å…¨ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼`;
  }

  const achievementPercent = Math.round((n / MAX_POINTS) * 100);
  $app.progress.percent.querySelector('.text-2xl').textContent = `${achievementPercent}%`;

  updateAcquiredBadges();

  state.prevCount = n;
}

function updateAcquiredBadges() {
  const boothIds = ['A', 'B', 'C', 'D', 'E', 'F'];
  const acquiredBooths = boothIds.filter(id => state.acquiredStamps.has(id)).length;
  const boothProgress = document.getElementById('booth-progress');
  if (boothProgress) {
    boothProgress.textContent = `${acquiredBooths}/6 ç²å¾—æ¸ˆã¿`;
    if (acquiredBooths === 6) {
      boothProgress.style.color = '#059669';
    }
  }
}

function updateActivePage() {
  console.log('[updateActivePage] activePage =', state.activePage);
  
  $app.pages.forEach(p => {
    const isActive = p.id === `page-${state.activePage}`;
    p.classList.toggle('active', isActive);
    p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
  });

  let activeBtn = null;
  $app.navButtons.forEach(btn => {
    const isActive = btn.dataset.page === state.activePage;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-current', isActive ? 'page' : 'false');
    if (isActive) activeBtn = btn;
  });
  
  if (activeBtn) {
    const btnW = activeBtn.offsetWidth;
    const indW = Math.max(56, Math.round(btnW * 0.66));
    const left = activeBtn.offsetLeft + (btnW - indW) / 2;
    $app.navIndicator.style.width = `${indW}px`;
    $app.navIndicator.style.transform = `translate(${left}px, -50%)`;
  }
  
  const pageTitles = { home: 'ãƒ›ãƒ¼ãƒ ', map: 'ãƒãƒƒãƒ—', list: 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„' };
  $app.headerTitle.textContent = pageTitles[state.activePage];

  if (state.activePage === 'list') { 
    renderBoothList(); 
  }
  
  if (state.activePage === 'map') {
    layoutBoothIcons();
  }
}

function openCategorySheet(categoryKey) {
  if (categoryKey === 'booths') {
    $app.categorySheet.title.textContent = 'ä¼æ¥­ãƒ–ãƒ¼ã‚¹';
    $app.categorySheet.content.innerHTML = `
      <div class="space-y-3">
        <p class="text-sm text-slate-600 mb-4">å„ä¼æ¥­ãƒ–ãƒ¼ã‚¹ã‚’è¨ªå•ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ã€‚å„ãƒ–ãƒ¼ã‚¹1pt (500å††åˆ†QUOã‚«ãƒ¼ãƒ‰) ãšã¤ç²å¾—ã§ãã¾ã™ã€‚</p>
        ${BOOTH_DATA.map(booth => {
          const isAcquired = state.acquiredStamps.has(booth.id);
          return `
          <div class="company-mini-card liquid-glass rounded-xl p-3 border border-white/40${isAcquired ? ' bg-gradient-to-r from-emerald-50/50 to-green-50/50' : ''}" data-booth-id="${booth.id}">
            ${isAcquired ? '<div class="acquired-check">âœ“</div>' : ''}
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg overflow-hidden bg-white flex-shrink-0">
                <img src="${booth.img}" alt="${booth.name}" class="w-full h-full object-contain bg-white" />
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-slate-800 text-sm">${booth.name}</div>
                <div class="text-xs text-slate-500 truncate">${booth.desc}</div>
              </div>
              <div class="${isAcquired ? 'text-emerald-600' : 'text-sky-600'} font-semibold text-sm">${isAcquired ? 'âœ“' : '1pt'}</div>
            </div>
          </div>
        `}).join('')}
      </div>
    `;
    
    $app.categorySheet.content.querySelectorAll('.company-mini-card').forEach(card => {
      card.addEventListener('click', () => {
        const boothId = card.dataset.boothId;
        const booth = BOOTH_DATA.find(b => b.id === boothId);
        if (booth) {
          closeCategorySheet();
          setTimeout(() => openBoothSheet(booth), 300);
        }
      });
    });
  } else {
    const category = CATEGORY_DATA[categoryKey];
    $app.categorySheet.title.textContent = category.title;
    $app.categorySheet.content.innerHTML = `
      <div class="space-y-4">
        <div class="flex items-center gap-2 text-sm">
          <span class="text-3xl">${category.icon}</span>
          <div>
            <div class="font-semibold text-slate-800">${category.time}</div>
            <div class="text-slate-600">ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãªã—</div>
          </div>
        </div>
        <p class="text-sm text-slate-700 leading-relaxed">${category.desc}</p>
        <div class="liquid-glass rounded-xl p-3 border border-white/40">
          <div class="text-xs font-semibold text-slate-700 mb-1">å‚åŠ æ¡ä»¶</div>
          <div class="text-sm text-slate-600">${category.condition}</div>
        </div>
      </div>
    `;
  }
  
  $app.categorySheet.el.classList.add('is-open');
  $app.categorySheet.backdrop.classList.add('is-open');
}

function closeCategorySheet() {
  $app.categorySheet.el.classList.remove('is-open');
  $app.categorySheet.backdrop.classList.remove('is-open');
}

function openBoothSheet(booth) {
  const isAcquired = state.acquiredStamps.has(booth.id);
  
  $app.boothSheet.icon.innerHTML = `<img src="${booth.img}" alt="${booth.name}" class="w-full h-full object-contain bg-white" />`;
  $app.boothSheet.title.textContent = booth.name;
  $app.boothSheet.desc.textContent = booth.desc;
  $app.boothSheet.condition.textContent = booth.condition;
  $app.boothSheet.giveaway.textContent = booth.giveaway;
  
  $app.boothSheet.tags.innerHTML = '';
  
  if (isAcquired) {
    const acquiredBadge = document.createElement('span');
    acquiredBadge.className = 'px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200 text-xs font-semibold';
    acquiredBadge.textContent = 'âœ“ å–å¾—æ¸ˆã¿';
    $app.boothSheet.tags.appendChild(acquiredBadge);
  }
  
  booth.tags.forEach(t => {
    const span = document.createElement('span');
    span.className = 'px-2 py-0.5 rounded-full bg-sky-100 text-sky-700 border border-sky-200 text-xs';
    span.textContent = t;
    $app.boothSheet.tags.appendChild(span);
  });
  
  $app.boothSheet.el.classList.add('is-open');
  $app.boothSheet.backdrop.classList.add('is-open');
}

function closeBoothSheet() {
  $app.boothSheet.el.classList.remove('is-open');
  $app.boothSheet.backdrop.classList.remove('is-open');
}

let scanStream = null;
let useBackCamera = true;
let trackWithTorch = null;
let scanning = false;
let codeReader = null;

async function openFullscreenScanner() {
  $app.fullscreenScanner.container.classList.add('active');
  await startCamera();
}

function closeFullscreenScanner() {
  stopCamera();
  $app.fullscreenScanner.container.classList.remove('active');
}

async function startCamera() {
  try {
    $app.fullscreenScanner.status.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­â€¦';
    
    if (!codeReader) {
      codeReader = new ZXing.BrowserQRCodeReader();
    }
    
    const constraints = {
      video: {
        facingMode: useBackCamera ? 'environment' : 'user',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };
    
    scanStream = await navigator.mediaDevices.getUserMedia(constraints);
    $app.fullscreenScanner.video.srcObject = scanStream;
    await $app.fullscreenScanner.video.play();
    
    try {
      const [track] = scanStream.getVideoTracks();
      const caps = track.getCapabilities?.();
      if (caps && 'torch' in caps) {
        trackWithTorch = track;
        $app.fullscreenScanner.torchBtn.classList.remove('opacity-50', 'pointer-events-none');
      } else {
        $app.fullscreenScanner.torchBtn.classList.add('opacity-50', 'pointer-events-none');
      }
    } catch (e) {
      console.warn('Torch not available');
      $app.fullscreenScanner.torchBtn.classList.add('opacity-50', 'pointer-events-none');
    }
    
    scanning = true;
    $app.fullscreenScanner.status.textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å†™ã—ã¦ãã ã•ã„';
    
    scanQRCode();
    
  } catch (err) {
    console.error(err);
    $app.fullscreenScanner.status.textContent = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
}

async function scanQRCode() {
  if (!scanning || !$app.fullscreenScanner.video.srcObject) return;
  
  try {
    const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'fullscreen-video');
    if (result && result.text) {
      scanning = false;
      const success = await handleScanResult(result.text);
      return;
    }
  } catch (err) {
    // QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç„¡è¦–
  }
  
  if (scanning) {
    requestAnimationFrame(() => scanQRCode());
  }
}

async function stopCamera() {
  scanning = false;
  
  if (codeReader) {
    try {
      await codeReader.reset();
    } catch (e) {
      console.warn('Failed to reset code reader', e);
    }
  }
  
  if (scanStream) {
    scanStream.getTracks().forEach(t => {
      t.stop();
      console.log('Track stopped:', t.label);
    });
    scanStream = null;
  }
  
  if ($app.fullscreenScanner.video.srcObject) {
    $app.fullscreenScanner.video.srcObject = null;
  }
  
  trackWithTorch = null;
  $app.fullscreenScanner.torchBtn.dataset.on = '0';
  $app.fullscreenScanner.torchBtn.classList.remove('bg-amber-200');
}

async function toggleTorch() {
  if (!trackWithTorch) return;
  const on = $app.fullscreenScanner.torchBtn.dataset.on === '1';
  try {
    await trackWithTorch.applyConstraints({ advanced: [{ torch: !on }] });
    $app.fullscreenScanner.torchBtn.dataset.on = on ? '0' : '1';
    $app.fullscreenScanner.torchBtn.classList.toggle('bg-amber-200');
  } catch (e) { 
    console.warn('Torch not available', e); 
  }
}

async function switchCamera() {
  useBackCamera = !useBackCamera;
  await stopCamera();
  setTimeout(() => startCamera(), 300);
}

function showFullscreenMessage(msg, isError = true) {
  const el = document.getElementById('fullscreen-message');
  const box = el.firstElementChild;
  box.textContent = msg;
  box.className = `px-4 py-3 rounded-2xl shadow-lg text-center font-medium ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
  el.classList.remove('hidden');
  clearTimeout(showFullscreenMessage._t);
  showFullscreenMessage._t = setTimeout(() => {
    el.classList.add('hidden');
  }, 2000);
}
  
async function handleScanResult(text) {
  if (!text) return false;
  
  if (!state.user?.id) {
    showFullscreenMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', true);
    return false;
  }
  
  try {
    const result = await callEdgeFunction('grant-stamp', {
      userId: state.user.id,
      qrCode: text.toLowerCase()
    });
    
    if (result.success) {
      await stopCamera();
      showFullscreenMessage(`âœ… ${result.pointsAdded}ptç²å¾—ï¼`, false);
      await wait(1500);
      closeFullscreenScanner();
      
      await syncPointsFromServer();
      return true;
    }
  } catch (error) {
    console.error('Stamp grant error:', error);
    
    if (error.message.includes('æ—¢ã«å–å¾—æ¸ˆã¿')) {
      showFullscreenMessage('âš ï¸ æ—¢ã«å–å¾—æ¸ˆã¿ã§ã™', true);
    } else if (error.message.includes('æœªå¯¾å¿œ')) {
      showFullscreenMessage('âŒ æœªå¯¾å¿œã®QRã‚³ãƒ¼ãƒ‰ã§ã™', true);
    } else {
      showFullscreenMessage('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
    }
    
    await wait(1500);
    return false;
  }
}

function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

async function ensureAuth() {
  const local = loadLocalUser();
  const token = localStorage.getItem(LS_KEY_TOKEN);
  
  if (local && local.id && token) {
    state.user = local;
    state.surveyCompleted = local.survey_completed || false;
    enableAppUI(state.user);
    await syncPointsFromServer();
    return true;
  }
  
  showAuthGate();
  return false;
}

async function handleSignin(e) {
  e.preventDefault();
  $app.auth.signinError.textContent = '';

  const name = $app.auth.siName.value.trim();
  const email = $app.auth.siEmail.value.trim();
  
  if (!name || !email) {
    $app.auth.signinError.textContent = 'æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚';
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    $app.auth.signinError.textContent = 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    return;
  }

  try {
    const result = await callEdgeFunction('onsite-intake', {
      name,
      email
    });

    if (result.user && result.token) {
      const user = {
        id: result.user.id,
        name: result.user.name,
        email: result.user.email,
        registration_type: result.user.registration_type || 'on_site',
        survey_completed: false
      };
      
      saveLocalUser(user);
      localStorage.setItem(LS_KEY_TOKEN, result.token);
      state.user = user;
      state.surveyCompleted = false;
      
      closeAuthModal('signin');
      enableAppUI(user);
      await syncPointsFromServer();
      showToast('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚ˆã†ã“ãï¼');
    }
  } catch (err) {
    console.error(err);
    $app.auth.signinError.textContent = err.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}

async function handleLogin(e) {
  e.preventDefault();
  $app.auth.loginError.textContent = '';
  
  const name = $app.auth.liName.value.trim();
  const email = $app.auth.liEmail.value.trim();
  if (!name || !email) {
    $app.auth.loginError.textContent = 'æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    $app.auth.loginError.textContent = 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    return;
  }
  
  try {
    const result = await callEdgeFunction('login', {
      name,
      email
    });
    
    if (result.user && result.token) {
      const user = {
        id: result.user.id,
        name: result.user.name,
        email: result.user.email,
        registration_type: result.user.registration_type || 'pre_registration',
        survey_completed: false
      };
      
      saveLocalUser(user);
      localStorage.setItem(LS_KEY_TOKEN, result.token);
      state.user = user;
      
      closeAuthModal('login');
      enableAppUI(user);
      await syncPointsFromServer();
      showToast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚');
    }
  } catch (err) {
    console.error(err);
    $app.auth.loginError.textContent = err.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
}

function showToast(msg) {
  const el = $app.toast;
  const box = el.firstElementChild;
  box.textContent = msg;
  el.classList.remove('hidden');
  el.classList.add('animate-bounce');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => {
    el.classList.add('hidden');
    el.classList.remove('animate-bounce');
  }, 1800);
}

function layoutBoothIcons() {
  const g = $app.map.iconsGroup;
  if (!g) return;
  
  console.log('[layoutBoothIcons] called');
  g.innerHTML = '';
  
  const vb = $app.map.svg.viewBox.baseVal;
  const base = Math.min(vb.width, vb.height);
  const size = Math.max(100, Math.min(280, Math.round(base * 0.14)));

  Object.keys(BOOTH_ANCHORS).forEach(id => {
    const a = BOOTH_ANCHORS[id];
    const cx = vb.width * a.x;
    const cy = vb.height * a.y;
    const x = cx - size / 2;
    const y = cy - size / 2;

    const booth = BOOTH_DATA.find(b => b.id === id) || { img: IMG_DEFAULT };
    const isAcquired = state.acquiredStamps.has(id);
    
    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
    group.setAttribute('cursor', 'pointer');
    group.setAttribute('role', 'button');
    group.setAttribute('aria-label', booth.name);
    group.dataset.id = id;
    
    const shadowDeep = document.createElementNS('http://www.w3.org/2000/svg','rect');
    shadowDeep.setAttribute('x', x + 8);
    shadowDeep.setAttribute('y', y + 8);
    shadowDeep.setAttribute('width', size);
    shadowDeep.setAttribute('height', size);
    shadowDeep.setAttribute('rx', size * 0.18);
    shadowDeep.setAttribute('fill', 'rgba(0,0,0,0.3)');
    shadowDeep.setAttribute('filter', 'blur(12px)');
    group.appendChild(shadowDeep);
    
    const shadowMid = document.createElementNS('http://www.w3.org/2000/svg','rect');
    shadowMid.setAttribute('x', x + 2);
    shadowMid.setAttribute('y', y + 2);
    shadowMid.setAttribute('width', size);
    shadowMid.setAttribute('height', size);
    shadowMid.setAttribute('rx', size * 0.18);
    shadowMid.setAttribute('fill', 'rgba(0,0,0,0.15)');
    shadowMid.setAttribute('filter', 'blur(4px)');
    group.appendChild(shadowMid);
    
    const baseRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    baseRect.setAttribute('x', x + 1);
    baseRect.setAttribute('y', y + 1);
    baseRect.setAttribute('width', size);
    baseRect.setAttribute('height', size);
    baseRect.setAttribute('rx', size * 0.18);
    baseRect.setAttribute('fill', isAcquired ? 'linear-gradient(135deg, #6ee7b7, #34d399)' : 'linear-gradient(135deg, #cbd5e1, #94a3b8)');
    baseRect.setAttribute('stroke', isAcquired ? '#10b981' : '#64748b');
    baseRect.setAttribute('stroke-width', '2');
    group.appendChild(baseRect);
    
    const border = document.createElementNS('http://www.w3.org/2000/svg','rect');
    border.setAttribute('x', x);
    border.setAttribute('y', y);
    border.setAttribute('width', size);
    border.setAttribute('height', size);
    border.setAttribute('rx', size * 0.18);
    border.setAttribute('fill', 'white');
    border.setAttribute('stroke', isAcquired ? 'url(#acquired-gradient)' : 'url(#border-gradient)');
    border.setAttribute('stroke-width', '4');
    border.setAttribute('filter', 'drop-shadow(0 2px 8px rgba(0,0,0,0.2))');
    group.appendChild(border);
    
    const innerShadow = document.createElementNS('http://www.w3.org/2000/svg','rect');
    innerShadow.setAttribute('x', x + 4);
    innerShadow.setAttribute('y', y + 4);
    innerShadow.setAttribute('width', size - 8);
    innerShadow.setAttribute('height', size - 8);
    innerShadow.setAttribute('rx', size * 0.15);
    innerShadow.setAttribute('fill', 'none');
    innerShadow.setAttribute('stroke', 'rgba(0,0,0,0.1)');
    innerShadow.setAttribute('stroke-width', '1');
    group.appendChild(innerShadow);
    
    const clipId = `clip-${id}`;
    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
    const clipPath = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
    clipPath.setAttribute('id', clipId);
    const clipRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    clipRect.setAttribute('x', x + 5);
    clipRect.setAttribute('y', y + 5);
    clipRect.setAttribute('width', size - 10);
    clipRect.setAttribute('height', size - 10);
    clipRect.setAttribute('rx', size * 0.15);
    clipPath.appendChild(clipRect);
    defs.appendChild(clipPath);
    group.appendChild(defs);
    
    const fillRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    fillRect.setAttribute('x', x + 5);
    fillRect.setAttribute('y', y + 5);
    fillRect.setAttribute('width', size - 10);
    fillRect.setAttribute('height', size - 10);
    fillRect.setAttribute('rx', size * 0.15);
    fillRect.setAttribute('fill', '#fff');
    fillRect.setAttribute('clip-path', `url(#${clipId})`);
    group.appendChild(fillRect);

    const img = document.createElementNS('http://www.w3.org/2000/svg','image');
    img.setAttribute('x', x + 5);
    img.setAttribute('y', y + 5);
    img.setAttribute('width', size - 10);
    img.setAttribute('height', size - 10);
    img.setAttribute('href', booth.img);
    img.setAttributeNS('http://www.w3.org/1999/xlink', 'href', booth.img);
    img.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    img.setAttribute('clip-path', `url(#${clipId})`);
    group.appendChild(img);
    
    const highlight = document.createElementNS('http://www.w3.org/2000/svg','rect');
    highlight.setAttribute('x', x + 5);
    highlight.setAttribute('y', y + 5);
    highlight.setAttribute('width', size - 10);
    highlight.setAttribute('height', (size - 10) * 0.5);
    highlight.setAttribute('rx', size * 0.15);
    highlight.setAttribute('fill', 'url(#highlight-gradient)');
    highlight.setAttribute('opacity', '0.5');
    highlight.setAttribute('clip-path', `url(#${clipId})`);
    group.appendChild(highlight);
    
    const gloss = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    gloss.setAttribute('cx', x + size * 0.3);
    gloss.setAttribute('cy', y + size * 0.25);
    gloss.setAttribute('rx', size * 0.15);
    gloss.setAttribute('ry', size * 0.1);
    gloss.setAttribute('fill', 'white');
    gloss.setAttribute('opacity', '0.6');
    gloss.setAttribute('clip-path', `url(#${clipId})`);
    group.appendChild(gloss);
    
    if (isAcquired) {
      const checkBg = document.createElementNS('http://www.w3.org/2000/svg','circle');
      checkBg.setAttribute('cx', x + size - 20);
      checkBg.setAttribute('cy', y + 20);
      checkBg.setAttribute('r', size * 0.12);
      checkBg.setAttribute('fill', '#10b981');
      checkBg.setAttribute('stroke', 'white');
      checkBg.setAttribute('stroke-width', '3');
      group.appendChild(checkBg);
      
      const checkMark = document.createElementNS('http://www.w3.org/2000/svg','text');
      checkMark.setAttribute('x', x + size - 20);
      checkMark.setAttribute('y', y + 20);
      checkMark.setAttribute('text-anchor', 'middle');
      checkMark.setAttribute('dominant-baseline', 'central');
      checkMark.setAttribute('fill', 'white');
      checkMark.setAttribute('font-size', size * 0.12);
      checkMark.setAttribute('font-weight', 'bold');
      checkMark.textContent = 'âœ“';
      group.appendChild(checkMark);
    }
    
    g.appendChild(group);
  });
  
  if (!document.getElementById('highlight-gradient')) {
    const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
    
    const gradient = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    gradient.setAttribute('id', 'highlight-gradient');
    gradient.setAttribute('x1', '0');
    gradient.setAttribute('y1', '0');
    gradient.setAttribute('x2', '0');
    gradient.setAttribute('y2', '1');
    
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    stop1.setAttribute('offset', '0%');
    stop1.setAttribute('stop-color', 'white');
    stop1.setAttribute('stop-opacity', '0.9');
    
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    stop2.setAttribute('offset', '100%');
    stop2.setAttribute('stop-color', 'white');
    stop2.setAttribute('stop-opacity', '0');
    
    gradient.appendChild(stop1);
    gradient.appendChild(stop2);
    defs.appendChild(gradient);
    
    const borderGrad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    borderGrad.setAttribute('id', 'border-gradient');
    borderGrad.setAttribute('x1', '0');
    borderGrad.setAttribute('y1', '0');
    borderGrad.setAttribute('x2', '0');
    borderGrad.setAttribute('y2', '1');
    
    const bstop1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    bstop1.setAttribute('offset', '0%');
    bstop1.setAttribute('stop-color', '#f1f5f9');
    
    const bstop2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    bstop2.setAttribute('offset', '50%');
    bstop2.setAttribute('stop-color', '#e2e8f0');
    
    const bstop3 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    bstop3.setAttribute('offset', '100%');
    bstop3.setAttribute('stop-color', '#cbd5e1');
    
    borderGrad.appendChild(bstop1);
    borderGrad.appendChild(bstop2);
    borderGrad.appendChild(bstop3);
    defs.appendChild(borderGrad);
    
    const acquiredGrad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    acquiredGrad.setAttribute('id', 'acquired-gradient');
    acquiredGrad.setAttribute('x1', '0');
    acquiredGrad.setAttribute('y1', '0');
    acquiredGrad.setAttribute('x2', '0');
    acquiredGrad.setAttribute('y2', '1');
    
    const astop1 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    astop1.setAttribute('offset', '0%');
    astop1.setAttribute('stop-color', '#6ee7b7');
    
    const astop2 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    astop2.setAttribute('offset', '50%');
    astop2.setAttribute('stop-color', '#34d399');
    
    const astop3 = document.createElementNS('http://www.w3.org/2000/svg','stop');
    astop3.setAttribute('offset', '100%');
    astop3.setAttribute('stop-color', '#10b981');
    
    acquiredGrad.appendChild(astop1);
    acquiredGrad.appendChild(astop2);
    acquiredGrad.appendChild(astop3);
    defs.appendChild(acquiredGrad);
    
    $app.map.svg.insertBefore(defs, $app.map.svg.firstChild);
  }

  g.querySelectorAll('g[data-id]').forEach(el => el.addEventListener('click', () => {
    const booth = BOOTH_DATA.find(b => b.id === el.dataset.id);
    if (booth) openBoothSheet(booth);
  }));
}

function setupSurveyInteractivity() {
  // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ãƒã‚§ãƒƒã‚¯è¡¨ç¤º
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const group = e.target.name;
      document.querySelectorAll(`input[name="${group}"]`).forEach(r => {
        r.closest('.survey-option').classList.remove('checked');
      });
      e.target.closest('.survey-option').classList.add('checked');
    });
  });

  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒã‚§ãƒƒã‚¯è¡¨ç¤º
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      e.target.closest('.survey-option').classList.toggle('checked', e.target.checked);
    });
  });
}

function init() {
  console.log('[init] starting');
  
  $app.navButtons.forEach(btn => {
    if (!btn) return;
    btn.addEventListener('click', () => {
      console.log('[nav] clicked:', btn.dataset.page);
      state.activePage = btn.dataset.page;
      updateActivePage();
    });
  });

  if ($app.nav) {
    $app.nav.addEventListener('click', (e) => {
      const btn = e.target.closest('.nav-btn');
      if (!btn) return;
      console.log('[nav-delegate] clicked:', btn.dataset.page);
      state.activePage = btn.dataset.page;
      updateActivePage();
    });
  }

  document.querySelectorAll('.stamp-category-card').forEach(card => {
    card.addEventListener('click', () => {
      const category = card.dataset.category;
      openCategorySheet(category);
    });
  });

  if ($app.categorySheet.backdrop) {
    $app.categorySheet.backdrop.addEventListener('click', closeCategorySheet);
  }
  $app.categorySheet.closeBtn.addEventListener('click', closeCategorySheet);

  if ($app.boothSheet.backdrop) {
    $app.boothSheet.backdrop.addEventListener('click', closeBoothSheet);
  }
  $app.boothSheet.closeBtn.addEventListener('click', closeBoothSheet);

  document.addEventListener('click', e => {
    const rippleTarget = e.target.closest('.ripple');
    if (!rippleTarget) return;
    const rect = rippleTarget.getBoundingClientRect();
    const ripple = document.createElement('span');
    const diameter = Math.max(rippleTarget.clientWidth, rippleTarget.clientHeight);
    const radius = diameter / 2;
    ripple.style.width = ripple.style.height = `${diameter}px`;
    ripple.style.left = `${e.clientX - rect.left - radius}px`;
    ripple.style.top = `${e.clientY - rect.top - radius}px`;
    ripple.classList.add('ripple-effect');
    rippleTarget.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  });

  window.addEventListener('resize', () => {
    if (state.activePage === 'map') {
      layoutBoothIcons();
    }
  });

  if ($app.scan.openCard) {
    $app.scan.openCard.addEventListener('click', openFullscreenScanner);
  }
  if ($app.fullscreenScanner.closeBtn) {
    $app.fullscreenScanner.closeBtn.addEventListener('click', closeFullscreenScanner);
  }
  if ($app.fullscreenScanner.torchBtn) {
    $app.fullscreenScanner.torchBtn.addEventListener('click', toggleTorch);
  }
  if ($app.fullscreenScanner.switchBtn) {
    $app.fullscreenScanner.switchBtn.addEventListener('click', switchCamera);
  }

  if ($app.rewards.openBtn) {
    $app.rewards.openBtn.addEventListener('click', openRewardsModal);
  }
  if ($app.rewards.closeBtn) {
    $app.rewards.closeBtn.addEventListener('click', closeRewardsModal);
  }
  if ($app.rewards.claimBtn) {
    $app.rewards.claimBtn.addEventListener('click', claimReward);
  }
  if ($app.rewards.openSurveyBtn) {
    $app.rewards.openSurveyBtn.addEventListener('click', () => {
      closeRewardsModal();
      setTimeout(() => openSurveyModal(), 300);
    });
  }

  if ($app.survey.closeBtn) {
    $app.survey.closeBtn.addEventListener('click', closeSurveyModal);
  }
  if ($app.survey.form) {
    $app.survey.form.addEventListener('submit', submitSurvey);
  }

  setupSurveyInteractivity();

  ensureAuth().then(ok => {
    if (ok) {
      enableAppUI(state.user);
    }
  });

  $app.auth.openSignin.addEventListener('click', () => openAuthModal('signin'));
  $app.auth.openLogin.addEventListener('click', () => openAuthModal('login'));
  document.querySelectorAll('[data-back="signin"]').forEach(el => 
    el.addEventListener('click', () => backToAuthGate('signin'))
  );
  document.querySelectorAll('[data-back="login"]').forEach(el => 
    el.addEventListener('click', () => backToAuthGate('login'))
  );
  $app.auth.signinForm.addEventListener('submit', handleSignin);
  $app.auth.loginForm.addEventListener('submit', handleLogin);

  $app.userPill.addEventListener('click', openQrModal);
  $app.qr.closeBtn.addEventListener('click', closeQrModal);

  $app.auth.backdrop.addEventListener('click', (e) => {
    if (e.target === $app.auth.backdrop) {
      if ($app.qr.modal.classList.contains('show')) {
        closeQrModal();
      } else if ($app.rewards.modal.classList.contains('show')) {
        closeRewardsModal();
      } else if ($app.survey.modal.classList.contains('show')) {
        closeSurveyModal();
      }
    }
  });

  renderAll();
  
  setInterval(() => {
    if (state.user?.id) {
      syncPointsFromServer();
    }
  }, 30000);
  
  console.log('[init] complete');
}

init();
</script>
</body>
</html>
